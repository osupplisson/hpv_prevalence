---
title: |
author: |
 | 
date: |
#abstract: 
output:
 bookdown::pdf_book:
  class: book
  pandoc_args: --top-level-division=chapter
  citation_package: biblatex
  toc: false
  number_sections: yes
  fig_width: 4
  fig_height: 4
  fig_caption: yes
  keep_tex: true
  includes:
   in_header: '../template_for_report/latex_template.tex'
csl: 'bmj.csl'
lang: en
link-citations: yes
geometry: left=3cm,right=3cm,top=3cm,bottom=3cm
font: 11pt
breaklinks: yes
urlcolor: red
linkcolor: red
citecolor: red
anchorcolor: red
bibliography: 'sources.bib'
biblatexoptions: [refsection=chapter,defernums=true,bibencoding=inputenc,maxnames=10, backend=biber,citereset=chapter,sorting=none, style=nature]
editor_options: 
  chunk_output_type: console
---

```{r include=FALSE, results='hide'}
# Cleaning packages -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
knitr::opts_chunk$set(fig.path="figures/")
options(bitmapType="cairo")
knitr::opts_chunk$set(dpi = 300)
options(tinytex.clean = FALSE)
print("Cleaning packages")
detachAllPackages <- function() {
 basic.packages <- c("package:stats", "package:graphics", "package:grDevices", "package:utils", "package:datasets", "package:methods", "package:base")
 package.list <- search()[ifelse(unlist(gregexpr("package:", search())) == 1, TRUE, FALSE)]

 package.list <- setdiff(package.list, basic.packages)

 if (length(package.list) > 0) for (package in package.list) detach(package, character.only = TRUE)
}

detachAllPackages()


required_packages <- c(
 "rmapshaper",
 "ggridges",
 "palettetown",
 "latex2exp",
 "ggtext",
 "ggpubr",
 "gridExtra",
 "extrafont",
 "GGally",
 "ggthemes",
 "RColorBrewer",
 "showtext",
 "scales",
 "ggplot2",
 "patchwork",
 "ggExtra",
 "cowplot",
 "ggbreak",
 "ggforce",
 "geomtextpath",
 "ggnewscale",
 "colorspace",
 "ggrepel",
 "flextable",
 "bookdown",
 "knitr",
 "kableExtra",
 "grDevices",
 "showtext",
 "grid",
 "tidybayes",
 "sf",
 "tidyverse",
 "tidylog",
 "paletteer",
 "ggh4x",
 "egg",
 "spdep",
 "terra",
 "sf",
 "janitor",
 "anytime",
 "inlabru",
 "sf"
)

# Loading libraries -------------------------------------------------------
lapply(required_packages, library, character.only = TRUE)

var_to_prec <- function(sigma) {
 tibble(
  "var" = sigma^2,
  "prec" = 1 / sigma^2
 )
}
prec_to_var <- function(prec) {
 tibble(
  "var" = 1 / prec,
  "std" = sqrt(1 / prec)
 )
}

formating_text <- function(x,
              digits_choice = 0) {
 format(
  round(x,
   digits = digits_choice
  ),
  small.mark = ".",
  big.mark = ",",
  nsmall = digits_choice
 )
}
load("hpv/clean_data/aggregated_data.rda")
df_for_fit <- readRDS("hpv/clean_data/output/df_for_fit.RDS")
descriptivefigures <- readRDS("hpv/clean_data/descriptive_figures.RDS")

knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  dpi = 1200
 )

transfo <- function(.x, .y) {
  if (is.data.frame(.x) & !str_detect(.y, "summary\\.") & !str_detect(.y, "ame")){
   if (str_detect(paste0(colnames(.x), collapse = " "), "testgroup")){
    .x <- .x %>%
     mutate(test = ifelse(testgroup == 1, "Organised", "Opportunistic"))
   }
   
   if (str_detect(paste0(colnames(.x), collapse = " "), "virusgroup")) {
    .x <- .x %>%
     mutate(genotypes = ifelse(virusgroup == 1, "HPV16/18", "Other genotypes"))
   }
   
   if (str_detect(paste0(colnames(.x), collapse = " "), "idyear")) {
    .x <- .x %>%
     mutate(year = case_when(
      idyear == 1 ~ 2020,
      idyear == 2 ~ 2021,
      idyear == 3 ~ 2022,
      idyear == 4 ~ 2023
     ))
   }}
  .x}



function_text <- function(df,x=1,y=1,pref = " ", ref = 1, multiple = 100){
 mean <- formating_text(multiple * df$mean/ref, x)
 qi_lb <- formating_text(multiple * df$qi_lb/ref, y)
 qi_ub <- formating_text(multiple * df$qi_ub/ref, y)
 paste0(mean, pref,"[",qi_lb, ',', qi_ub,"]")
}

function_text_ci <- function(df,y=1,pref = " "){
 qi_lb <- formating_text(100 * df$qi_lb, y)
 qi_ub <- formating_text(100 * df$qi_ub, y)
 paste0("[",qi_lb, ',', qi_ub,"]")
}

mesh_space <- readRDS("hpv/clean_data/output/mesh.RDS")

```


```{r include=FALSE}
res <- readRDS("hpv/clean_data/output/gcpo.RDS")
opt <- res %>%
 filter(ls == min(ls))


selected_model <- opt %>% 
 .$model

name <- str_remove(str_remove(selected_model, "gcpo_"), ".RDS")



pathpostfit <- paste0("hpv/clean_data/output/post_fit_", name, ".RDS")
pathpp <- paste0("hpv/clean_data/output/pp_", name, ".RDS")
results <- readRDS(pathpostfit)
pp_baseline <- readRDS(pathpp)
expected_baseline <- readRDS(str_replace(pathpp, "pp", "expected"))

f_pp_expected <- function(d){
  d %>% 
     imap(function(.x, .y) {
   if (str_detect(paste0(colnames(.x), collapse = " "), "testgroup")){
    .x <- .x %>%
     mutate(test = ifelse(testgroup == 1, "Organised", "Opportunistic"))
   }
   
   if (str_detect(paste0(colnames(.x), collapse = " "), "virusgroup")) {
    .x <- .x %>%
     mutate(genotypes = ifelse(virusgroup == 1, "HPV16/18", "Other genotypes"))
   }
   
   if (str_detect(paste0(colnames(.x), collapse = " "), "idyear")) {
    .x <- .x %>%
     mutate(year = case_when(
      idyear == 1 ~ 2020,
      idyear == 2 ~ 2021,
      idyear == 3 ~ 2022,
      idyear == 4 ~ 2023
     ))
   }
  .x})
}
pp_baseline <- pp_baseline %>% f_pp_expected(.)
expected_baseline <- expected_baseline %>% f_pp_expected(.)


x <- c("virusgroup", "year", "age_class", "region_name", "type")
 list_x <- do.call(c, lapply(seq_along(x), combn, x = x, simplify = FALSE))
print(length(list_x))

names(pp_baseline) <- list_x %>% imap(~paste0(.x, collapse = "")) %>% do.call(c,.)
names(expected_baseline) <- list_x %>% imap(~paste0(.x, collapse = "")) %>% do.call(c,.)

```


```{r}

share_city_bias <- results$map[[30]]$difference_test %>% mutate(higher_0_class = base::cut(higher_0, breaks = c(0,0.01,0.05,0.1,0.5,0.9,0.95,0.99,1), include.lowest = T, ordered_result = T)) %>% 
 st_drop_geometry() %>% 
 group_by(virusgroup, higher_0_class) %>% 
 count %>%
 group_by(virusgroup) %>% 
 mutate(pct = 100*n/sum(n))
```




\let\cleardoublepage=\clearpage
\hiddenchapter{startpaper}
\thispagestyle{empty}

\begin{center}
\textbf{High-risk human papillomavirus cervical infection prevalence in France, 2020-2023: a nationwide, large-scale, and spatially resolved retrospective study comparing opportunistic and organised screening}

Olivier Supplisson\(^\mathrm{1,2,*}\), Nicolas Tessandier\(^\mathrm{1,3}\), Mathilde Roussel\(^\mathrm{4}\), Stéphanie Haim-Boukobza \(^\mathrm{5}\), Sonia Burrel\(^\mathrm{6,7}\), Mircea T. Sofonea\(^\mathrm{8,9}\), Samuel Alizon\(^\mathrm{1}\)

\end{center}

\(^\mathrm 1\) Center for Interdisciplinary Research in Biology (CIRB), Collège de France, CNRS, INSERM, Université PSL, Paris, France.

\(^\mathrm 2\) Sorbonne University, Paris, France.

\(^\mathrm 3\) ExposUM Institute, Université de Montpellier, MIVEGEC, Montpellier, France

\(^\mathrm 4\) Laboratoire Cerba, pole infectiologie, Frépillon, France.

\(^\mathrm 5\) Cerba HealthCare, Issy-les-Moulineaux, France.


\(^\mathrm 6\) CHU de Bordeaux, Service de virologie, Bordeaux, France.

\(^\mathrm 7\) CNRS UMR 5234, Fundamental Microbiology and Pathogenicity, Université de Bordeaux, Bordeaux, France.

\(^\mathrm 8\) PCCEI, Univ Montpellier, INSERM, EFS, Montpellier, France.

\(^\mathrm 9\) Department of Anesthesiology, Critical Care, Intensive Care, Pain and Emergency Medicine, CHU Nîmes, Nîmes, France.

\(^*\) Corresponding author: osupplis@gmail.com. Collège de France, 11 Place Marcelin Berthelot, 75005 Paris.

\begin{center}
Version as of \today.
\end{center}


\captionsetup[figure]{list=no}
\captionsetup[table]{list=no}

\newpage
\thispagestyle{empty}




\captionsetup[figure]{list=no}
\captionsetup[table]{list=no}

\newpage
\thispagestyle{empty}

\section*{Abstract}


\textbf{Background:} In France, cervical cancer screening for females aged 30 to 65 primarily targets high-risk human papillomavirus (HPV) infections using DNA tests (‘HR HPV test’). 

\textbf{Aim:} The primary goal was to map the prevalence of cervical infections caused by HPV16 and/or 18, or by any of 12 other carcinogenic genotypes (31, 33, 35, 39, 45, 51, 52, 56, 58, 59, 66, and 68). The secondary goal was to compare prevalence estimates obtained from tests conducted after spontaneous medical visits (‘opportunistic screening’) or as part of the national screening programme (‘organised screening’).

\textbf{Methods:} The analytic sample contained `r formating_text(sum(df_for_fit$N/2),0)` results of HR HPV tests collected, between 2020 and 2023, in metropolitan France.  A full hierarchical Bayesian model was used to compute spatially resolved prevalence maps at the postcode level.

\textbf{Results:} Among samples from organised and opportunistic screening, `r formating_text(100*sum(sum(df_for_fit %>% filter(hpvother == 0 & type == "orga") %>% .$result))/sum(sum(df_for_fit %>% filter(hpvother == 0 & type == "orga") %>% .$N)),1)`%  and `r formating_text(100*sum(sum(df_for_fit %>% filter(hpvother == 0 & type == "ind") %>% .$result))/sum(sum(df_for_fit %>% filter(hpvother == 0 & type == "ind") %>% .$N)),1)`% were positive for HPV16 and/or 18, respectively. For other genotypes, these percentages were `r formating_text(100*sum(sum(df_for_fit %>% filter(hpvother == 1 & type == "orga") %>% .$result))/sum(sum(df_for_fit %>% filter(hpvother == 1 & type == "orga") %>% .$N)),1)`% and `r formating_text(100*sum(sum(df_for_fit %>% filter(hpvother == 1 & type == "ind") %>% .$result))/sum(sum(df_for_fit %>% filter(hpvother == 1 & type == "ind") %>% .$N)),1)`%, respectively.

During the last week of the study period, among females aged 30, opportunistic screening was associated with a greater HPV infection prevalence for HPV16 and/or 18 (other genotypes) in `r results$map[[30]]$count_difference_test %>% filter(virusgroup == 1) %>% function_text(., x = 1, y = 1, multiple = 100, ref = nrow(data_cp_final))`% (`r results$map[[30]]$count_difference_test %>% filter(virusgroup == 2) %>% function_text(., x = 1, y = 1, multiple = 100, ref = nrow(data_cp_final))`%) of postcodes. The probability of this percentage being lower among females aged 66 was below 95% for both genotype groups.

After correcting for this effect, a pronounced northwest/southeast gradient in HR HPV infection prevalence was found across France, for both genotype groups, with some hotspots located at the border with Spain and Italy and Switzerland.

\textbf{Conclusion:} Opportunistic screening is associated with systematic inflation in HR HPV infection prevalence.

\textbf{Keywords:} High-risk HPV; Cervical infection prevalence; Organised screening; Opportunistic screening; Gaussian random fields; Gaussian Markov random fields.



\savegeometry{Mem}


\newpage
\setcounter{page}{1}

\hiddensection{Introduction}

Human papillomaviruses (HPV) cause a massive public health burden worldwide. In addition to anogenital warts and papillomatosis, persistent HPV infections caused by oncogenic (high-risk, HR) genotypes are responsible for nearly all cervical cancers and a substantial proportion of penile, vulval, vaginal, anal, and oropharyngeal cancers \cite{deMartelEtAl2017}. In 2020, an estimated 600,000 new cases of cervical cancer were reported globally, making it the fourth most common cancer among females \cite{whowebsite,Singh2023}. In the European Union, it ranks as the second most prevalent cancer among females aged 15--44 years, after breast cancer \cite{ECDC_HPV_Factsheet}. The World Health Organisation (WHO)'s global strategy to accelerate the elimination of cervical cancer as a public health problem promotes HR HPV screening as one of the key interventions to prevent and control the burden associated with this disease \cite{whostrategy}.

In 2019, France updated its cervical cancer screening guidelines, shifting from cytology-based screening to a combination of cytological analysis and HPV DNA detection test (further simplified as 'HR HPV test'). These updated guidelines keep cytological analysis as the primary screening tool for females aged less than 30, but now recommend HR HPV test as the primary screening method for females aged 30 to 65. The first HR HPV test should be performed as early as age 30 or 3 years after the last cytological analysis. If this test is negative for all HR HPV, the next test should be performed 5 years later. In the case of a positive result for one of the targeted genotypes, a cytological analysis should be performed within the year. If the cytological analysis is normal, a new HR HPV test should be performed one year later \cite{LeBihanBenjamin2023,Waheed2023}.

The national cervical cancer screening programme was updated in July 2020 with these new guidelines. This programme, which was launched in 2018 following encouraging results from modelling and pilot studies \cite{modellinghpv,Hamers2018}, aimed at reducing the incidence of cervical cancer and associated mortality by 30% over 10 years through an increase in screening coverage rate of up to 80% \cite{spfcervical,LeBihanBenjamin2023,Waheed2023}. It was partly motivated by the concerns about the observed decreasing trend in 'opportunistic screening' uptake, i.e., prescription-based screening following spontaneous medical consultations \cite{Maura2018}. The new version of the French organised screening programme targets females aged 30 to 65 who do not follow French screening guidelines by inviting them to consult a primary care provider and undergo a free HR HPV test (see Supplementary Files \ref{guidelines} for additional details).

As of 2025, many countries have implemented similar organised cervical cancer screening programmes \cite{Maver2020,Bruni2022}. As in France, these programmes typically rely on a combination of cytological analyses and HR HPV tests. Beyond their contribution to reducing the incidence and mortality of cervical cancer \cite{Ronco2014,Brisson2020,Jansen2020}, screening programmes relying on HR HPV tests offer a unique window on HR HPV cervical infection prevalence. Furthermore, due to different selection mechanisms in screening uptake, prevalence estimates obtained through organised screening programmes are expected to differ from those derived from opportunistic screening \cite{Ouanhnon2023,Gianino2018}.


This work aimed to provide the first spatially-resolved picture of cervical infections caused by HPV16 and/or HPV18, or caused by at least one of 12 other carcinogenic genotypes (31, 33, 35, 39, 45, 51, 52, 56, 58, 59, 66, and 68), according to the WHO classification \cite{whohpv}, in metropolitan France. It also aimed to study whether opportunistic and organised screening are associated with systematic differences in prevalence estimates.


\pagebreak
\hiddensection{Methods}



\hiddensubsection{Data}

The initial dataset contained all results from HR HPV tests performed on cervical samples, in France, between January 2020 and November 2023, by Cerba, one of the largest networks of medical biology laboratories in the country.

Regardless of the screening pathway, two types of biologically and clinically validated assays were used to analyse collected samples: eiter the Alinity m high risk\textregistered\(~\) assay or the Roche Cobas\textregistered\(~\) HR HPV test \cite{Arbyn2021}. Both assays target the viral DNA of 14 HPV genotypes: 16, 18, 31, 33, 35, 39, 45, 51, 52, 56, 58, 59, 66, and 68. Alinity m high risk\textregistered\(~\) can distinguish between HPV16, HPV18, and HPV45, but not between other genotypes. Roche's Cobas\textregistered\(~\) provides distinct results only for HPV16 and 18 and cannot distinguish between other HR genotypes. Therefore, the data extracted by Cerba provided binary results (i.e., positive or negative) for HPV16 and HPV18 for both assays, for HPV45 only for Alinity m high risk\textregistered\(~\), and for all other HR genotypes for both assays.

In addition to test results, the dataset included the screening pathway, the week and year of the sample analysis, patients' age and postcode of the city of residence. Details about these postcodes are provided in Supplementary Files \ref{studyadminlandscape}. No additional variables were available.

\hiddensubsection{Analytic sample selection}


The detailed description of the sample selection steps and the corresponding flowchart are provided in Supplementary Files \ref{flowchart}. In brief, we only analysed test results from females living in France, aged between 15 and 79 years, for whom information about their anonymous ID, age, spatial location, and type of screening was available.

We considered all patients aged 15 to 79, living in metropolitan France and in Overseas Territories for descriptive statistics purposes only (reported in Supplementary Files \ref{descstat}). The statistical analysis, aimed at fulfilling the study objectives, was conducted solely on patients from metropolitan France within the age range of 30 to 66 years, which we refer to as 'analytic sample'.

The upper age limit was set at 66 years to account for the delay between the receipt of the invitation from the organised screening programme and test uptake; which may lead females of such an age to benefit from the free HR HPV test provided by the organised screening programme. The lower age limit aligns with the recommended age for HR HPV testing.



\pagebreak

\hiddensubsection{Statistical inference}

We performed a disease mapping statistical analysis \cite{MacNab2022}, which aims at providing disease-related metrics at small-area levels, such as postcodes. It seeks to do so despite scarce sampling and data dependency across space and time. Scarce sampling may prevent the computation of the quantities of interest or may be the source of unstable estimates with large, implausible, uncertainty intervals \cite{Ghosh1994}. Data dependency manifests itself through spatial and temporal autocorrelation and must be accounted for when computing uncertainty intervals \cite{Hoeting2009}. State-of-the-art disease mapping analyses use hierarchical models estimated within a full Bayesian framework, which allow to capture both the relation between data points and to leverage information from densely sampled areas to enhance estimates in sparsely sampled regions, to deal with both issues \cite{MacNab2010,MacNab2022,MacNab20222}.

The number of tests and positive tests were aggregated at the stratum level. Strata were based on postcode, age, week-year of screening, genotype groups, and screening pathway. Two groups of genotypes were considered: HPV16 and/or HPV18 ('HPV16/18’) and genotypes other than HPV16/18 ('other genotypes’).

The number of positive tests within each stratum was assigned a binomial distribution, the size parameter of which was the total number of tests performed within each stratum. The expected proportion of positive tests within a stratum was linked, through the standard logistic function, to a set of predictors using stratum’s characteristics as input. 

Each stratum's predictor included a global intercept and additional parameters associated with the full two-way interaction between dummy variables associated with the group of other genotypes and opportunistic screening. Other parameters were divided into two groups. The first group was common to data collected through opportunistic and organised screening, while the second was specific to data collected through opportunistic screening. Each group of parameters contained spatially varying, age-varying, and time-varying parameters to which we assigned multivariate hierarchical priors. Six different models were considered, each with a different prior spatial structure.

Competing models were discriminated through the log-score \cite{Gneiting2007}, which was computed using the leave-one-group-out cross-validation approach described in \cite{lgocv,Adin2024}. All models were estimated using the \texttt{inlabru} package \cite{Bachl2019,brunew}, a wrapper around the \texttt{R-INLA} package \cite{JSSv063i19,advancesinrinla}, in R version 4.4.0 \cite{r_logiciel}. Further details are provided in Supplementary Files \ref{additionalstat}.


\pagebreak

\hiddensection{Results}


```{r include=FALSE}
p1 <- ggpubr::ggarrange(
 descriptivefigures$descriptive_plot_sample + 
  scale_y_continuous(labels = function(x) ifelse(x < 0, "", scales::comma(x)), n.breaks = 10) +
  theme_minimal(base_size = 21) +
  theme(legend.direction = "horizontal", legend.position = "bottom"),
 descriptivefigures$number_test_age +
  theme_minimal(base_size = 21) +
  theme(legend.direction = "horizontal", legend.position = "bottom")+
  theme(axis.text.x = element_text(angle = +90, vjust = 0.5, hjust=1)),
 ncol = 2,
 labels = c("A) ", "B) "),
 font.label = list(size = 22, color = "black", face = "bold", family = NULL)
)
p2 <- ggpubr::ggarrange(
 descriptivefigures$descriptive_plot_year +
  theme_minimal(base_size = 21) +
  theme(legend.direction = "horizontal", legend.position = "bottom"),
 descriptivefigures$descriptive_plot_age +
  theme_minimal(base_size = 21) +
  theme(legend.direction = "horizontal", legend.position = "bottom")+
  theme(axis.text.x = element_text(angle = +90, vjust = 0.5, hjust=1)),
 ncol = 2,
 labels = c("C) ", "D) "),
 font.label = list(size = 22, color = "black", face = "bold", family = NULL)
)


maxnumberweek <- max(dfdate$idtime)
```



```{r include=FALSE}

plot_year <- results$list_main_city$summary_city_year %>% 
  filter(metric == "rd") %>% 
  filter(idtime == max(idtime)) %>% 
  ggplot() +
  geom_line(aes(x = age, y = mean, color = test), size = 1)+
  geom_ribbon(aes(x = age,
           ymin = qi_lb, 
           ymax = qi_ub,
           fill = test), alpha = 0.25) +
  facet_grid(genotypes~city) +
  #geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x = "Year",
     y = "Difference in expected prevalence \n between 2023 and 2020",
     color = "Type of screening: ",
     fill = "Type of screening: ",
     caption = "Line: posterior average. Ribbon: posterior ETI95%. Scale of y axis for plots B and C: percentage points.") +
  scale_fill_manual(values = c("red", "blue")) +
  scale_color_manual(values = c("red", "blue")) +
  theme_minimal(base_size = 21) +
  theme(legend.direction = "horizontal", legend.position = "bottom")+
  scale_y_continuous(labels = function(x)100*x)


plot_age <- results$list_main_city$summary_city_age %>% 
  filter(metric == "rd") %>% 
  filter(idtime == max(idtime)) %>% 
  ggplot() +
  geom_line(aes(x = age, y = mean, color = test), size = 1)+
  geom_ribbon(aes(x = age,
           ymin = qi_lb, 
           ymax = qi_ub,
           fill = test), alpha = 0.25) +
  facet_grid(genotypes~city, scale = 'free_y') +
  #geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x = "Age",
     y = "Difference in expected prevalence \n with females aged 30",
     color = "Type of screening: ",
     fill = "Type of screening: ",
     caption = "Line: posterior average. Ribbon: posterior ETI95%. Scale of y axis for plots A and B: percentage points.") +
  scale_fill_manual(values = c("red", "blue")) +
  scale_color_manual(values = c("red", "blue")) +
  theme_minimal(base_size = 21) +
  theme(legend.direction = "horizontal", legend.position = "bottom")+
  scale_y_continuous(labels = function(x)100*x)




function_for_spatial_plot <- function(df_input,
                   t,
                   v,
                   sub,
                   lab = "Posterior expected HR HPV cervical infection prevalence among 30-year-olds, under organised screening, at the end of November 2023,",
                   restriction_idf = F,
                   color_option = "turbo",
                   direction_option = 1,
                   funlabel = label_percent()) {
 
 lab <- paste0(lab, " for ", ifelse(v == "HPV16/18", "HPV16/18", str_to_lower("Other genotypes")))
 data <- df_input
 cols <- colnames(data)
 
 if(length(unique(data$virusgroup)) == 2){
  data <- data %>% 
  filter(genotypes %in% v)
 }
 if(length(unique(data$test))== 2){
  data <- data %>% 
   filter(test %in% t)
 } 
 

 data <- data %>%
  select(genotypes, geometry, region, one_of(sub)) %>%
  pivot_longer(cols = sub, names_to = "name", values_to = "values") %>% 
  filter(name %in% sub) %>% 
  mutate(name = case_when(name == "mean" ~ "Posterior average",
              name == "qi_lb" ~ "Posterior LB ETI95%",
              name == "qi_ub" ~ "Posterior UB ETI95%",
              name == "higher_0" ~ "Posterior Pr>0.95"),
      name = factor(name,
             levels = c("Posterior LB ETI95%",
                  "Posterior average",
                  "Posterior UB ETI95%",
                  "Posterior Pr>0.95"))) 
 
  min <- min(data$values)
  max <- max(data$values)
 
  if(restriction_idf == T){
   data <- data %>% 
    filter(region == "Île-de-France")
  }
  
  p <- ggplot() +
  gg(data,
    aes(color = values, 
      fill = values)) + 
  theme_map(font_size = 23) +
  scale_color_viridis_c(option = color_option,
             limits = c(min,max), 
             direction = 1,
             labels = funlabel,
             n.breaks = 6) +
  scale_fill_viridis_c(option = color_option,
             limits = c(min,max), 
             direction = direction_option,
             labels = funlabel,
             n.breaks = 6) +
  labs(color = lab,
     fill = lab) +
  theme(
   plot.title = element_text(hjust = 0.5),
   legend.position = "bottom",
   legend.key.width = unit(3, "cm"),
   legend.key.height = unit(0.5, "cm"),
   legend.spacing = unit(0.25, "cm"),
   legend.title = element_text(hjust = 0.5),
   legend.justification = "center",
   legend.title.position = "top"
  ) +
  theme(plot.margin = margin(
   t = 0.0005,
   r = 0.0005,
   b = 0.0005,
   l = 0.0005,
   unit = "cm"
  ))+ theme(
  plot.title = element_text(hjust = 0.5, face = "bold"),
  plot.subtitle = element_text(hjust = 0.5, face = "bold")
)
  
  if(length(sub) != 1){
   p +
    facet_wrap( ~ name) 
  }else{
   p
  }
  }

label_difference_test <- "Difference (in percentage points) in expected prevalence between opportunistic and organised \n screening, among females aged 30,"

lable_expected_prev <- "Expected HR HPV cervical infection prevalence, under organised \n screening, among females aged 30,"


###Whole France
####VIRUS
france30_hpv1618 <- function_for_spatial_plot(results$map[[30]]$virusspecific,
             v = "HPV16/18",
             t = "Organised",
             c("mean"))+
  gg(carto_district %>% filter(insee_reg == "11"), alpha = 0.0000001, color = "black")+
  gg(fr_mask,color = "black", alpha = 0.0000001) 

france30_hpvother <- function_for_spatial_plot(results$map[[30]]$virusspecific,
             v = "Other genotypes",
             t = "Organised",
             c("mean"))+
  gg(carto_district %>% filter(insee_reg == "11"), alpha = 0.0000001, color = "black")+
  gg(fr_mask,color = "black", alpha = 0.0000001) 

###Difference test
space30_differencetest_hpv1618 <- function_for_spatial_plot(results$map[[30]]$difference_test,
             v = "HPV16/18",
             t = "Organised",
             c("mean"),
             lab = label_difference_test,
             funlabel = function(x){paste0(100*x, "pp")}) +
 gg(carto_district %>% filter(insee_reg == "11"), alpha = 0.0000001, color = "black") +
  gg(fr_mask,color = "black", alpha = 0.0000001) 

space30_differencetest_hpvother<- function_for_spatial_plot(results$map[[30]]$difference_test,
             v = "Other genotypes",
             t = "Organised",
             c("mean"),
             lab = label_difference_test,
             funlabel = function(x){paste0(100*x, "pp")}) +
 gg(carto_district %>% filter(insee_reg == "11"), alpha = 0.0000001, color = "black") +
  gg(fr_mask,color = "black", alpha = 0.0000001) 


##Zoom on IDF
paris30_hpv1618 <- function_for_spatial_plot(results$map[[30]]$virusspecific,
             v = "HPV16/18",
             t = "Organised",
             c("mean"),
             lab = lable_expected_prev,
             restriction_idf = T)+
  gg(carto_district %>% filter(insee_reg == "11"), alpha = 0.0000001, color = "black")

paris30_hpvother <- function_for_spatial_plot(results$map[[30]]$virusspecific,
             v = "Other genotypes",
             t = "Organised",
             c("mean"),
             lab = lable_expected_prev,
             restriction_idf = T)+
  gg(carto_district %>% filter(insee_reg == "11"), alpha = 0.0000001, color = "black") 

##Difference - IDF
paris30_differencetest_hpv1618 <- function_for_spatial_plot(results$map[[30]]$difference_test,
             v = "HPV16/18",
             t = "Organised",
             c("mean"),
             lab = label_difference_test,
             restriction_idf = T,
             funlabel = function(x){paste0(100*x, "pp")}) +
  gg(carto_district %>% filter(insee_reg == "11"), alpha = 0.0000001, color = "black")


paris30_differencetest_hpvother <- function_for_spatial_plot(results$map[[30]]$difference_test,
             v = "Other genotypes",
             t = "Organised",
             c("mean"),
             lab = label_difference_test,
             restriction_idf = T,
             funlabel = function(x){paste0(100*x, "pp")}) +
  gg(carto_district %>% filter(insee_reg == "11"), alpha = 0.0000001, color = "black")



 
plot_summary_city <- results$list_main_city$virusspecific %>%
  filter(idtime == max(idtime)) %>% 
  ggplot() +
  geom_line(aes(x = age, y = mean, color = test),linewidth = 1)+
  geom_ribbon(aes(x = age,
          ymin = qi_lb,
          ymax = qi_ub,
          fill = test), alpha = 0.25) +
  facet_grid(genotypes~city, scale = "free") +
  labs(x = "Age",
     y = "Expected prevalence in %",
     caption = "Line: posterior average. Ribbon: posterior ETI95%",
     color = "Type of screening: ",
     fill = "Type of screening: ") +
  scale_fill_manual(values = c("red", "blue")) +
  scale_color_manual(values = c("red", "blue")) +
  theme_minimal(base_size = 21) +
  theme(legend.direction = "horizontal", legend.position = "bottom") +
  scale_y_continuous(labels = scales::percent)


library(ggnewscale)
diff_between_virus_city <- results$list_main_city$difference_virus %>%
  filter(idtime == max(idtime)) %>% 
 plyr::rbind.fill(results$list_main_city$difference_virus_test %>%
     filter(idtime == max(idtime)) %>% 
     mutate(test = NA)) %>% 
 mutate(test = case_when(
  test == "Organised" ~ "Difference in expected prevalence between other genotypes and HPV16/18, correcting for the systematic inflation associated with opportunistic screening (percentage points)",
    test == "Opportunistic" ~ "Difference in expected prevalence between other genotypes and HPV16/18, under opportunistic screening (percentage points)",
  T ~ "Systematic inflation associated with opportunistic screening in the difference between expected prevalence of each genotype group (percentage points)"
  )
 ) %>% 
  ggplot() +
  geom_line(aes(x = age, y = mean, color = test),linewidth = 1)+
  geom_ribbon(aes(x = age,
          ymin = qi_lb,
          ymax = qi_ub,
          fill = test), alpha = 0.25) +
  facet_grid(~city) +
  labs(x = "Age",
     y = "Posterior average (solid line) and ETI95% (ribbon)",
     color = "Difference between HPV16/18 and other genotypes: ",
     fill = "Difference between HPV16/18 and other genotypes: ",
     caption = element_blank()) +
  scale_fill_manual(values = c("red", "blue", "darkgreen")) +
  scale_color_manual(values = c("red", "blue", "darkgreen")) +
  theme_minimal(base_size = 21) +
  theme(legend.direction = "horizontal", legend.position = "bottom")+
  #geom_hline(yintercept = 0, linetype = "dashed") +
  scale_y_continuous(labels = function(x)100*x) +
 guides(fill=guide_legend(nrow=3,byrow=TRUE),
     color=guide_legend(nrow=3,byrow=TRUE))+ 
 labs(color = element_blank(),
    fill = element_blank())





diff_between_test_city <- results$list_main_city$difference_test %>%
  filter(idtime == max(idtime)) %>% 
  ggplot() +
  geom_line(aes(x = age, y = mean, color = genotypes),linewidth = 1)+
  geom_ribbon(aes(x = age,
          ymin = qi_lb,
          ymax = qi_ub,
          fill = genotypes), alpha = 0.25) +
  facet_grid(~city) +
  labs(x = "Age",
     y = "Difference in expected prevalence \n between opportunistic and organised screening",
     color = "Genotype group: ",
     fill = "Genotype group: ",
     caption = element_blank()) +
  scale_fill_manual(values = c("darkgreen", "darkorange")) +
  scale_color_manual(values = c("darkgreen", "darkorange")) +
  theme_minimal(base_size = 21) +
  theme(legend.direction = "horizontal", legend.position = "bottom")+
  geom_hline(yintercept = 0, linetype = "dashed") +
  scale_y_continuous(labels = function(x)paste0(100*x, "pp"))



ecdf_space <- results$map[[30]]$difference_test %>% st_drop_geometry()%>%
 mutate(virusgroup = ifelse(virusgroup == 1, "HPV16/18", "Other genotypes")) %>% 
 ggplot() + 
 stat_ecdf(aes(x = higher_0, color = virusgroup),geom = "smooth") + scale_color_manual(values = c("darkgreen", "darkorange"))+
 labs(x = "Posterior probability of systematic inflation > 0", y = "Cumulated proportion",color = "Virus") + 
 geom_vline(xintercept = 0.95, linetype = "dashed")+
 geom_hline(yintercept = 0.5, linetype = "dashed")+
 theme_minimal(base_size = 21) +
 theme(legend.direction = "horizontal", legend.position = "bottom")



proba_france30_differencetesthpv1618 <- function_for_spatial_plot(results$map[[30]]$difference_test %>% mutate(higher_0 = base::cut(higher_0, breaks = c(0,0.01,0.05,0.1,0.5,0.9,0.95,0.99,1), include.lowest = T, ordered_result = T)),
             v = c("Other genotypes", "HPV16/18"),
             t = "Organised",
             c("higher_0"),
             lab = "Posterior probability of a positive difference in expected prevalence between opportunistic and organised screening") +
 facet_grid(~genotypes) +
  scale_colour_brewer(palette = "Spectral", direction = -1, drop=FALSE) +
  scale_fill_brewer(palette = "Spectral", direction = -1, drop=FALSE) +
  gg(carto_district %>% filter(insee_reg == "11"), alpha = 0.0000001, color = "black")+ 
  gg(fr_mask,color = "black", alpha = 0.0000001) 


proba_paris30_differencetesthpvother <- function_for_spatial_plot(results$map[[30]]$difference_test %>% mutate(higher_0 = base::cut(higher_0, breaks = c(0,0.01,0.05,0.1,0.5,0.9,0.95,0.99,1), include.lowest = T, ordered_result = T)),
             v = c("Other genotypes", "HPV16/18"),
             t = "Organised",
             c("higher_0"),
             lab = "Probability of positive systematic inflation from opportunistic screening") +
 facet_grid(~genotypes) + 
  scale_colour_brewer(palette = "Spectral", direction = -1, drop=FALSE) +
  scale_fill_brewer(palette = "Spectral", direction = -1, drop=FALSE) +
  gg(carto_district %>% filter(insee_reg == "11"), alpha = 0.0000001, color = "black")

```
\textbf{Descriptive reporting for the analytic sample}


The analytic sample contained the results of `r df_for_fit %>% st_drop_geometry() %>% filter(virus == "hpv1618") %>% .$N %>% sum %>% formating_text(.,0)` HR HPV tests. Of these, `r formating_text(100*sum(sum(df_for_fit %>% filter(hpv1618 == 1) %>% .$result))/sum(sum(df_for_fit %>% filter(hpv1618 == 1) %>% .$N)),1)`% and `r formating_text(100*sum(sum(df_for_fit %>% filter(hpvother == 1) %>% .$result))/sum(sum(df_for_fit %>% filter(hpvother == 1) %>% .$N)),1)`% were positive for HPV16/18 and for other genotypes, respectively. For opportunistic screening, these percentages were `r formating_text(100*sum(sum(df_for_fit %>% filter(hpvother == 0 & type == "ind") %>% .$result))/sum(sum(df_for_fit %>% filter(hpvother == 0 & type == "ind") %>% .$N)),1)`% and `r formating_text(100*sum(sum(df_for_fit %>% filter(hpvother == 1 & type == "ind") %>% .$result))/sum(sum(df_for_fit %>% filter(hpvother == 1 & type == "ind") %>% .$N)),1)`%, for HPV16/18 and other genotypes, respectively. For organised screening, they were `r formating_text(100*sum(sum(df_for_fit %>% filter(hpvother == 0 & type == "orga") %>% .$result))/sum(sum(df_for_fit %>% filter(hpvother == 0 & type == "orga") %>% .$N)),1)`% and `r formating_text(100*sum(sum(df_for_fit %>% filter(hpvother == 1 & type == "orga") %>% .$result))/sum(sum(df_for_fit %>% filter(hpvother == 1 & type == "orga") %>% .$N)),1)`% for both groups, respectively. Stratified observed prevalence are reported in Supplementary Files \ref{rawsummary}.

\textbf{Posterior predictive check for the selected model}

The selected model's spatial components were specified through the `r str_to_upper(opt$space)` prior, with the `r ifelse(opt$type == "queenfirstorder", "first-order Queen contiguity", "XXX")` structure as the neighbourhood matrix. It was able to reproduce the observed prevalence and found a posterior average expected [equal-tailed interval at 95%, ETI95%] cervical infection prevalence in the analytic sample of `r expected_baseline$virusgroup %>% filter(genotypes == "HPV16/18") %>% function_text`% for HPV16/18 and `r expected_baseline$virusgroup %>% filter(genotypes == "Other genotypes") %>% function_text`% for other genotypes. Keeping the same order for the genotypes, the posterior average [ETI95] predictive cervical infection prevalence among opportunistic tests was `r expected_baseline$virusgrouptype %>% filter(genotypes == "HPV16/18"& type == "ind") %>% function_text`% and `r expected_baseline$virusgrouptype %>% filter(genotypes == "Other genotypes"& type == "ind") %>% function_text`%, respectively. For organised screening, they were `r expected_baseline$virusgrouptype %>% filter(genotypes == "HPV16/18"& type == "orga") %>% function_text`% and `r expected_baseline$virusgrouptype %>% filter(genotypes == "Other genotypes"& type == "orga") %>% function_text`%, respectively. Additional stratification can be found in Supplementary Files \ref{rawsummary}.

\textbf{Effect of screening pathway on the expected prevalence among females aged 30}

The posterior distribution of the spatial-specific difference between the expected HR HPV cervical infection prevalence generated using the model specific to each type of screening made it possible to quantify the difference in expected prevalence associated with opportunistic screening relative to organised screening. For comparison purposes and given the non-linear relation between the expected prevalence and strata characteristics, we focused here on females aged 30 (the age at which the recommendation to use HR HPV tests begins), considering the last observed week, at the end of November 2023.

At the end of the study period, opportunistic screening was associated with a greater HPV infection prevalence among females aged 30, compared with organised screening, in more than the majority of postcodes with high certainty. Such an inflation was identified on average [ETI95%] in `r results$map[[30]]$count_difference_test %>% filter(virusgroup == 1) %>% function_text(., x = 1, y = 1, multiple = 100, ref = nrow(data_cp_final))`% of postcodes for HPV16/18 and `r results$map[[30]]$count_difference_test %>% filter(virusgroup == 2) %>% function_text(., x = 1, y = 1, multiple = 100, ref = nrow(data_cp_final))`% of postcodes for other genotypes.


The difference in HR HPV infection prevalence, between opportunistic and organized screening,  among females aged 30 in the postcode with the greatest ETI95% lower bound was on average [ETI95%] `r results$map[[30]]$difference_test %>% st_drop_geometry()%>% filter(virusgroup == 1) %>% filter(qi_lb == max(qi_lb)) %>% function_text` percentage points (pp) for HPV16/18 and `r results$map[[30]]$difference_test %>% st_drop_geometry()%>% filter(virusgroup == 2) %>% filter(qi_lb == max(qi_lb)) %>% function_text`pp for other genotypes (Figure \ref{mapbias}).


\bcenter
\bigbreak
\bigbreak

\emph{Insert Figure \ref{mapbias} here.}


**Figure \ref{mapbias}: Posterior average difference between opportunistic and organised screening in terms of expected HR HPV cervical infection prevalence in France (upper row) and Paris region (bottom row) for HPV16/18 (A) and other genotypes (B). Values are in percentage points (pp), among females aged 30, at the end of November 2023. Maps with ETI95% are provided in Supplementary Files \ref{mapwithci1}.**


\bigbreak
\bigbreak
\ecenter


\textbf{Maps of the expected HR HPV cervical infection prevalence among females aged 30}

The joint posterior distribution of the model specific to organised screening allowed us to generate the spatial-specific expected HR HPV cervical infection prevalence under organised screening, among females aged 30, at the end of November 2023. This made it possible to produce what, to our knowledge, is the first spatially resolved nationwide mapping of this quantity for France.

Once removed the systematic inflation associated with opportunistic screening, a pronounced northwest/southeast gradient in HR HPV infection prevalence was found across France, for both genotype groups. Hotspots were identified at the borders with Spain and Italy and Switzerland.

The areas in which we detected the lowest ETI95% lower bound for the expected prevalence had an posterior average [ETI95%] expected prevalence of `r results$map[[30]]$virusspecific %>% st_drop_geometry() %>% filter(virusgroup == 1) %>% filter(qi_lb == min(qi_lb)) %>% function_text`% for HPV16/18 and `r results$map[[30]]$virusspecific %>% st_drop_geometry() %>% filter(virusgroup == 2) %>% filter(qi_lb == min(qi_lb)) %>% function_text`% for other genotypes. By contrast,  the area in which the maximum lower bound was detected had a posterior average [ETI95%] expected prevalence of `r results$map[[30]]$virusspecific %>% st_drop_geometry() %>% filter(virusgroup == 1) %>% filter(qi_lb == max(qi_lb)) %>% function_text`% for HPV16/18 and `r results$map[[30]]$virusspecific %>% st_drop_geometry() %>% filter(virusgroup == 2) %>% filter(qi_lb == max(qi_lb)) %>% function_text`% for other genotypes (Figure \ref{mapspatial30}A and B). Maps with ETI95% upper and lower bounds are provided in Supplementary Files \ref{mapwithci2}.


\bcenter
\bigbreak
\bigbreak

\emph{Insert Figure \ref{mapspatial30} here.}

**Figure \ref{mapspatial30}: Posterior average expected HR HPV cervical infection prevalence in France (top rows) and Paris region (bottom row), among females aged 30, at the end of November 2023, under organised screening, for HPV16/18 (A) and other genotypes (B). Maps with ETI95% upper and lower bounds are provided in Supplementary Files \ref{mapwithci2}.**

\bigbreak
\bigbreak
\ecenter


\textbf{Age-specific expected HR HPV cervical infection prevalence in major French cities}

To study how the expected HR HPV cervical infection prevalence changes with age, we restricted the evaluation of the posterior expected prevalence to eleven major French cities, spread around mainland France, at the end of November 2023 (see Supplementary Files \ref{studyadminlandscape} for their locations).

The likely systematic upward inflation identified among females aged 30 extended to almost all ages in major French cities. In Paris, the posterior ETI95%lower bound for this upward inflation decreased from `r results$list_main_city$difference_test %>% filter(city == "Paris" & genotypes == "HPV16/18") %>% filter(age == 30 & idtime == max(idtime)) %>% function_text`pp for HPV16/18 and `r results$list_main_city$difference_test  %>% filter(city == "Paris" & genotypes == "Other genotypes") %>% filter(age == 30 & idtime == max(idtime)) %>% function_text`pp for other genotypes among females aged 30 to `r results$list_main_city$difference_test  %>% filter(city == "Paris" & genotypes == "HPV16/18" & idtime == max(idtime)) %>% filter(age == 66 & idtime == max(idtime)) %>% function_text`pp and `r results$list_main_city$difference_test  %>% filter(city == "Paris" & genotypes == "Other genotypes") %>% filter(age == 66 & idtime == max(idtime)) %>% function_text`pp, respectively, among females aged 66. 

When removing the systematic inflation associated with opportunistic screening, the posterior average [ETI95%] expected HPV16/18 cervical infection prevalence in Paris decreased from `r results$list_main_city$virusspecific %>% filter(city == "Paris" & genotypes == "HPV16/18" & age == 30 & test == "Organised" & idtime == max(idtime)) %>% function_text`% among females aged 30 to `r results$list_main_city$virusspecific %>% filter(city == "Paris" & genotypes == "HPV16/18" & age == 66 & test == "Organised" & idtime == max(idtime)) %>% function_text`% among females aged 66. For other genotypes, it decreased from `r results$list_main_city$virusspecific %>% filter(city == "Paris" & genotypes == "Other genotypes" & age == 30 & test == "Organised" & idtime == max(idtime)) %>% function_text`% to `r results$list_main_city$virusspecific %>% filter(city == "Paris" & genotypes == "Other genotypes" & age == 66 & test == "Organised" & idtime == max(idtime)) %>% function_text`% (Figure \ref{probacity}A and B). Maps for the entire country are shown in Supplementary Files \ref{mapall}.





\bcenter
\bigbreak
\bigbreak

\emph{Insert Figure \ref{probacity} here.}

**Figure \ref{probacity}: A) Summary of the posterior distribution of the expected HR HPV cervical infection prevalence, in major French cities, stratified by age and genotype group. B) Summary of the posterior distribution of the difference (in percentage points), between the two groups of genotypes (other genotypes and HPV16/18), in the expected prevalence of cervical infection, in major French cities, stratified by age. C) Posterior proportion (in %) of postcodes for which a systematic increase in expected infection prevalence was detected with opportunistic screening, compared with organised screening, stratified by age and genotype group. D) Posterior probability that the number of postcodes with a higher expected prevalence under opportunistic screening, compared to organised screening, is lower than this at age 30. Table counterparts for these plots are provided in Supplementary Files \ref{tableprobacity}. All variables were computed at the end of November 2023.**

\bigbreak
\bigbreak
\ecenter

```{r}

change_number_cp <- results$map %>% 
  imap(~.x$count_difference_test) %>% 
  do.call(rbind,.) %>% 
  select(age,
         mean,
         qi_lb,
         qi_ub,
         virusgroup) %>% 
  mutate_at(c("mean",
              "qi_lb",
              "qi_ub"),
            ~round(.,0))



plot_number_cp <- change_number_cp %>% 
  pivot_longer(cols = c(mean, qi_lb, qi_ub),
               names_to = "name",
               values_to = "value") %>% 
  mutate(name = case_when(
           name == "mean" ~ "Average",
           name == "qi_lb" ~ "ETI95% LB",
           name == "qi_ub" ~ "ETI95% UB"
         ),
         name = factor(name, levels = c("ETI95% LB", "Average", "ETI95% UB"))) %>% 
  mutate(value = value/nrow(data_cp_final)) %>% 
    mutate(virusgroup = ifelse(virusgroup==1, "HPV16/18", "Other genotypes")) %>% 
    ggplot() +
    geom_line(aes(x = age, y = value,color = virusgroup, linetype = name)) +
    labs(color = "Genotype group: ",
         linetype = "Posterior: ")+ 
    theme_minimal(base_size = 21)  +
    scale_color_manual(values = c("darkgreen", "orange"))  + 
    scale_y_continuous(labels = scales::label_percent(), n.breaks = 8) +
  scale_linetype_manual(values = c(2,1, 3), labels = c("2.5% Quantile", "Average", "97.5% Quantile")) + 
  labs(x = "Age",
       y = str_wrap("Posterior % of postcodes with a greater expected infection \n prevalence under opportunistic screening, compared \n with organised screening", 40)) + 
  scale_x_continuous(breaks = seq(30, 66, 5))


diff_number_cp <- results$change_inflation_age %>% 
    imap(~.x$diff_prev_between_screening) %>% 
    do.call(rbind,.) %>% 
    select(age,
           mean,
           qi_lb,
           qi_ub,
           lower_0,
           virusgroup) %>% 
    mutate_at(c("mean",
                "qi_lb",
                "qi_ub"),
              ~round(.,0))  %>% 
  mutate(virusgroup = ifelse(virusgroup == 1, "HPV16/18", "Other genotypes")) %>% 
    ggplot() + 
    geom_line(aes(x = age, y = lower_0, color = factor(virusgroup))) +
    labs(color = "Genotype group: ",
         linetype = element_blank())+ 
    theme_minimal(base_size = 21)  +
    scale_color_manual(values = c("darkgreen", "orange"))  + 
    scale_y_continuous(labels = scales::label_percent(), n.breaks = 8) +
    scale_linetype_manual(values = c(2,1, 3), labels = c("2.5% Quantile", "Average", "97.5% Quantile")) + 
    labs(x = "Age",
         y = str_wrap("Posterior probability for the number of postcodes with a detected inflation in expected prevalence under opportunistic screening to be lower than this at age 30",  width = 40)) + 
    scale_x_continuous(breaks = seq(30, 66, 5))

```

Among females aged 66, opportunistic screening was associated with a systematic inflation in the expected infection prevalence in  `r change_number_cp %>% filter(age == 66 & virusgroup == 1) %>% function_text(., ref = nrow(data_cp_final))`% of postcodes for HPV16/18 and `r change_number_cp %>% filter(age == 66 & virusgroup == 2) %>% function_text(., ref = nrow(data_cp_final))`% for other genotypes, see Figure \ref{probacity}C. There was a `r (results$change_inflation_age[[66]]$diff_prev_between_screening$lower_0[1] * 100)%>% formating_text(.,1)`% and `r (results$change_inflation_age[[66]]$diff_prev_between_screening$lower_0[2]*100) %>% formating_text(.,1)`% chance for these percentages to be lower than these computed among females aged 30, respectively for HPV16/18 and other genotypes, see \ref{probacity}D. 



```{r eval=TRUE, include=FALSE}
tmp <- results$map %>% 
    imap(~.x[["difference_virus"]] %>% 
    st_drop_geometry() ) %>% 
    do.call(rbind,.)%>% 
    mutate(count = ifelse(higher_0 >= 0.99, 1, 0)) %>% 
  group_by(count, testgroup, age) %>% 
  count() %>% 
  filter(count == 1) %>% 
  mutate(pct = 100*n/nrow(data_cp_final)) %>% 
  ungroup() %>% 
  mutate()

tmp %>% .$pct %>% unique()
```

\textbf{Difference in expected infection prevalence between the two groups of genotypes within each screening pathway}

For each screening pathway, the posterior mean difference in infection prevalence between the two groups of oncogenic genotypes followed a northeast-to-southwest gradient. In all major French cities, the prevalence of HPV16/18 was almost certainly lower than that of the other genotypes. Moreover, both screening pathways tended to yield smaller and closer differences in expected prevalence between the two genotype groups among older females compared to younger ones (see Supplementary Files \ref{comparinggenotype}).

\textbf{Temporal changes in the expected HR HPV cervical infection prevalence}

The posterior distribution for the expected HR HPV cervical infection prevalence under opportunistic screening favoured an increase in the expected infection prevalence between the last and first week of the study period, for both groups of genotypes. However, when considering organised screening, such a positive temporal trend was not found with high certainty (Figure \ref{differenceage}A and Supplementary Files \ref{diftim}).



\bcenter
\bigbreak
\bigbreak

\emph{Insert Figure \ref{differenceage} here.}


\textbf{Figure \ref{differenceage}: A) Posterior odds ratio between the expected HR HPV cervical infection prevalence during the last and first week of the study period, stratified by type of screening and genotype groups. B) Posterior expected HR HPV cervical infection prevalence simulated for the analytic sample assuming that all data would have been collected only through opportunistic or organised screening, stratified by year of screening. C) Posterior marginal difference (in the analytic sample) in the expected prevalence between opportunistic and organised screening, stratified by year of screening and age. Panels B and C are available in table format in Supplementary Files \ref{diffcitytable}.}
\bigbreak
\bigbreak
\ecenter



\textbf{Marginal difference in expected HR HPV cervical infection prevalence associated with screening pathway}

To go beyond the conditional picture explored so far, we computed the Marginal Difference in Expected Prevalence (MDEP), which measures the marginal difference in expected prevalence had all data been collected via opportunistic rather than organised screening. It accounts for all interactions and reflects how the within-sample expected prevalence would change depending on screening pathway.


Assuming exclusive collection of data via organised screening, the posterior average [ETI95%] expected prevalence would be `r results$prevalence$expected_prevalence %>% filter(virus == "hpv1618" & test == "Organised") %>% function_text`% for HPV16/18 and `r results$prevalence$expected_prevalence %>% filter(virus == "hpvother" & test == "Organised") %>% function_text`% for other genotypes. The alternative situation, in which all strata would have been collected through opportunistic screening would be associated with an average [ETI95%] change in the expected prevalence of `r results$ame$ame_test %>% filter(virus == "hpv1618") %>% function_text(.,1)`pp and `r results$ame$ame_test %>% filter(virus == "hpvother") %>% function_text(.,1)`pp, for HPV16/18 and other genotypes, respectively (Figure \ref{differenceage}A and B). The MDEP stratified by age and year is provided in Figure \ref{differenceage}C.



```{r}

plot_expected_prevalence <- results$prevalence$expected_prevalence %>% 
  plyr::rbind.fill(results$prevalence$expected_prevalence_year) %>% 
  mutate(year = ifelse(is.na(year), "All", year),
      year = factor(year, levels = c("2020","2021","2022","2023","All")),
      virus = ifelse(virus == "hpv1618", "HPV16/18", "Other genotypes"),
      test = paste0(test, " screening")) %>% 
  ggplot() + 
  geom_point(position = position_dodge(width = 0.9),
        aes(x = year, y = mean, color = test))+
  geom_errorbar(position = position_dodge(width = 0.9),
         aes(x = year, ymin = qi_lb, ymax = qi_ub, color = test))+
  #geom_hline(yintercept = 0, linetype = "dashed")+
  labs(x = "Year",
     y = "Expected prevalence in \n the analytic sample",
     caption = "Posterior average: dots, Posterior ETI95%: bars",
     color = "Assuming all tests collected through: ")+ 
  theme_minimal(base_size = 21) +
  facet_grid(~virus)+
  theme(legend.direction = "horizontal", legend.position = "bottom")+
  scale_y_continuous(labels = scales::label_percent(), n.breaks = 8)+
  scale_color_manual(values = c("red", "blue"))



plot_ame <- results$ame$ame_test %>% 
  plyr::rbind.fill(results$ame$ame_test_year) %>% 
  mutate(year = ifelse(is.na(year), "All", year),
      year = factor(year, levels = c("2020","2021","2022","2023","All")),
      virus = ifelse(virus == "hpv1618", "HPV16/18", "Other genotypes")) %>% 
  ggplot() + 
  geom_point(aes(x = year, y = mean, color = year))+
  geom_errorbar(aes(x = year, ymin = qi_lb, ymax = qi_ub, color = year))+
  #geom_hline(yintercept = 0, linetype = "dashed")+
  labs(x = "Year",
     y = "Marginal difference in expected prevalence  of opportunistic screening",
     caption = "Posterior average: dots, Posterior ETI95%: bars",
     color = "Year: ")+ 
  theme_minimal(base_size = 21) +
  facet_grid(~virus)+
  theme(legend.direction = "horizontal", legend.position = "bottom")+
  scale_y_continuous(labels = function(x)100*x)



plot_ameage <- results$ame$ame_test_age %>% 
    plyr::rbind.fill(results$ame$ame_test %>% mutate(age_class = "[30,66]")) %>% 
    plyr::rbind.fill(results$ame$ame_test_year %>% mutate(age_class = "[30,66]")) %>% 
    plyr::rbind.fill(results$ame$ame_test_age_year) %>% 
    mutate(year = ifelse(is.na(year), "All", year),
           year = factor(year, levels = c("2020","2021","2022","2023","All")),
           virus = ifelse(virus == "hpv1618", "HPV16/18", "Other genotypes"),
           age_class = factor(age_class, levels = c("[30,39]", "(39,49]", "(49,59]", "(59,66]", "[30,66]"))) %>% 
    ggplot() + 
    geom_point(aes(x = year, y = mean, color = year))+
    geom_errorbar(aes(x = year, ymin = qi_lb, ymax = qi_ub, color = year))+
    facet_grid(age_class~virus) +
    #geom_hline(yintercept = 0, linetype = "dashed")+
    labs(x = "Year",
         y = "Marginal difference in expected prevalence  by age",
         caption = "Posterior average: dots, Posterior ETI95%: bars",
         color = "Year: ")+ 
    theme_minimal(base_size = 21) +
    theme(legend.direction = "horizontal", legend.position = "bottom")+
    scale_color_manual(values = c("darkorange", "purple", "darkgreen", "brown", "black"))+
    geom_hline(yintercept = 0, color = 'red', linetype = "dashed") + 
    scale_y_continuous(breaks = seq(0,0.06, 0.02), labels = function(x)paste0(100*x,"pp"))

  

plot_or_time <- results$list_main_city$summary_city_year %>% 
  filter(age == 30 &
        metric == "or" & 
        idtime != 1 & 
        city == "Paris") %>% 
  ggplot() +
  geom_point(aes(x = genotypes, y = mean, color = test ), position = position_dodge(width = 0.9))+
  geom_errorbar(aes(x = genotypes, ymin = qi_lb, ymax = qi_ub, color = test ), position = position_dodge(width = 0.9)) +
  theme_minimal()+
  geom_hline(yintercept = 1, linetype = "dashed") +
  scale_y_continuous(n.breaks = 8) +
  labs(x = "Genotypes",
     y = "Odds ratio of the expected \n prevalence  between the last \n and first week of the period",
     color = "Type of screening: ")+
  scale_color_manual(values = c("red", "blue")) +
   theme_minimal(base_size = 21) +
   theme(legend.direction = "horizontal", legend.position = "bottom") 
```

**Sensitivity analyses**

The results of the sensitivity analyses can be found in Supplementary Files \ref{sensi}. Only slight changes in the posterior average and ETI95% for the MDEP were observed.

\newpage

\hiddensection{Discussion}

Screening and vaccination are two of the interventions recommended by the WHO strategy to eliminate cervical cancer \cite{whowebsite,Singh2023,Bergman2019}. The optimisation of their spatial deployment could contribute to making them more effective. To this end, spatially resolved maps of HR HPV infection prevalence can help identify areas where they can be the most effective.

Our study provides the first spatially resolved picture of HR HPV cervical infection prevalence in metropolitan France. Our modelling approach was designed to handle non-linear age-specific prevalence patterns, the spatial structure of the dataset, and multiple genotype groups and screening types within a unified statistical modelling approach.

The analysis highlighted the systematic inflation of HR HPV cervical infection prevalence when using test results collected through opportunistic screening compared to those collected through organised screening. It also identified a northeast/southwest gradient in the HR HPV cervical infection prevalence with prevalence hotspots identified near the border with Spain and Italy and Switzerland.  This identified spatial gradient correlates with the spatial gradient in HR HPV vaccines uptake found by Ribassin-Majed \textit{et al.} \cite{RibassinMajed2021}, providing a possible explanation for this pattern.



\textbf{HR HPV16/18 cervical infection prevalence}

The 2023 Summary Report on HPV and Related Diseases in the World published by the Catalan Institute of Oncology (ICO)/the International Agency for Research on Cancer (IARC) Information Centre on HPV and Cancer, found a pooled 95% confidence interval (CI95%) cervical infection prevalence for HPV16/18 among females with normal cytology of [2.5,2.7]% in Western Europe (see \cite{whoreport}, page 103).

For France, the same report identified 12 studies estimating HR HPV cervical infection prevalence in females with normal cervical cytology, all published in 2014 or before (see \cite{whoreport}, page 97). Among these, Heard \textit{et al.} \cite{Heard2013} stands out with a dataset collected from July 2009 to November 2012, in 16 sampling sites, participating in an experiment for the initial version of the organised screening programme. For normal cytology, they implemented a stratified sampling scheme, according to the age class (25--29, 30--39, 40--49, 50--65 years), resulting in a total of 3,037 cervical samples. HPV16/18 was found in 3.9 [CI95%: 2.8,5.1]% of these samples.

We observed a prevalence for HPV16/18 of `r formating_text(100*sum(sum(df_for_fit %>% filter(hpvother == 0 & type == "orga") %>% .$result))/sum(sum(df_for_fit %>% filter(hpvother == 0 & type == "orga") %>% .$N)),1)`% in the samples collected through organised screening and our model produced a posterior average expected [ETI95%] infection prevalence of `r expected_baseline$virusgrouptype %>% filter(genotypes == "HPV16/18" & type == "orga") %>% function_text`%. The latter value overlaps with Heard \textit{et al.} \cite{Heard2013}'s lower range uncertainty interval while pointing towards lower values that are closer to the ICO/IARC's estimates for Western Europe, the upper bounds of the uncertainty intervals hint at potentially large difference between our results and Heard et al. \cite{Heard2013}.

The differences between our results and those from Heard \textit{et al.} \cite{Heard2013} could primarily be due to differences in sample composition. The first difference lies in age composition. Heard \textit{et al.} \cite{Heard2013} selected participants based on a stratified sampling scheme. Conversely, we used all the tests performed by one of the leading networks of biology laboratories in France but provided model-based age-specific infection prevalence estimates. A second source of heterogeneity is related to vaccination, which increased between previous studies and ours. In 2022, 33.8% of girls aged 16 had a full vaccination scheme, against 15.5% in 2017 \cite{dePouvourville2024}. Last but not least, a third source of heterogeneity originates from differences in spatial sampling. We used test results from all over France whereas Heard \textit{et al.} \cite{Heard2013} had samples coming from only 5 of the 22 French regions, none of which were located in East of France where we found a lower posterior average expected infection prevalence.

\textbf{Public health implications}

Many countries, especially in Europe, have implemented nationwide organised HR HPV testing programmes, with the intent to increase screening uptake \cite{Bruni2010,Bruni2022}. In France, according to the latest assessment carried out by the national public health institute (Santé publique France, SpF), the coverage of cervical cancer screening uptake among females aged [25-65] between 2020 and 2022 was 59.5\%, below the 80\% targeted by the programme \cite{spfcervical}. In most of these organised screening programmes, including France, invitations are dispatched based on the time since the previous screening, regardless of residence \cite{Bruni2022}.


The heavy burden of cervical cancer and the benefits associated with HR HPV screening call for HR HPV testing uptake to be encouraged nationwide \cite{Ronco2014,Brisson2020,Jansen2020}. However, the prevalence hotspots identified in our analysis could help pinpoint areas where increasing screening effort might enhance the public health impact of the organised screening programme while limiting the additional costs.

Our results also shed light on the spatially-differentiated impact of screening pathways on HR HPV infection prevalence, which may contribute to bias prospective modelling studies using routinely collected data and not accounting for such an effect. We provided plausible ranges for this effect, allowing modellers to explore its impact on their results as part of their sensitivity analyses. 

\textbf{Limits}

Our work has three main limitations. First, the large grid used to define strata caused high computational and storage costs, preventing to account for interactions between dimensions. As a result, all models, despite their flexibility, accounted for each dimension independently on the logit-scale.

Second, the dataset did not allow for the study of organised screening uptake among eligible females. A report by SpF found that 11.6% of screening tests for females aged 30-65 in 2020-2022 were performed through the organised screening programme, i.e., following the receipt of an invitation letter \cite{spfcervical}. The launch of the updated version of the organised screening programme amidst the COVID-19 pandemic, in July 2020, may have slowed down the roll-out of these invitations and their uptake. However, reported screening coverage for females aged 25-65 was higher in 2020-2022 than in 2017-2019, indicating a plausible limited impact or a catch-up dynamic  during time periods with limited disruption of the healthcare sector \cite{spfcervical}.

Lastly, we shown that data from opportunistic screening were likely associated with a systematic inflation in HR HPV infection prevalence across mainland France compared to organised screening. However, because the screening uptake following receipt of an invitation is not mandatory, data collected through organised screening might not give a more accurate reflection of the true prevalence than opportunistic screening. Therefore, residual selection biases affect both estimated prevalence. Modelling the selection process could address this concern but this is typically impossible using data routinely collected by medical biology laboratories.

\textbf{Implication for future research}

This study provides an original, nationwide, and spatially resolved picture of HR HPV cervical infection prevalence in France. It also highlights the likely systematic upward inflation in expected prevalence associated with opportunistic screening compared with organised screening.

Similar quantification of the differences between screening pathways for other infections, whose prevalence studies heavily rely on opportunistic sampling, should be performed to improve the reliability of future prospective modelling work assessing the effect of public health interventions.


\newpage

\pagestyle{empty}


\printbibliography[section=\therefsection,heading=subbibliography,title={References}, resetnumbers]

\newpage

\pagestyle{empty}

\section*{Statements}


\subsection*{Ethical considerations}

Study declared to the French Data Protection Authority (the \textit{Commission nationale de l'informatique et des libertés}, CNIL) by the French National Centre for Scientific Research (CNRS) Data Protection Department (DPD) on the 05/07/2024 (number 2228349/3, UMR7241 record). All data processing was compliant with the French reference methodology MR-004 (research not involving the human person, studies and evaluations in the field of health). 

\subsection*{Declaration of Competing Interests}

The authors have nothing to declare.


\subsection*{Funding}


OS is funded by a Ph.D. grant from the ANRS|Maladies infectieuses émergentes (grant number 22485).

NT is funded by a research grant from the ANRS|Maladies infectieuses émergentes (grant number 21290). NT is the recipient of a Fellowship from the ExposUM Institute. The grant is a combined contribution from the Université de Montpellier, Région d'Occitanie, and France 2030.

This project was also funded by the ANRS|Maladies infectieuses émergentes through the research project ANRS-0681-MIST.

The funders were not involved in any part of the study, including design, data collection, analysis, interpretation, manuscript writing, and submission.

\newpage

\subsection*{Authors contributions}

\begin{itemize}
\item Study conceptualisation: O.S., S.H.B., S.A., M.T.S.
\item Administrative work: O.S., S.A.
\item Funding acquisition: O.S., S.H.B., M.T.S, S.A., S.B.
\item Initial data extraction and cleaning: M.R.
\item Secondary data cleaning: O.S.
\item Initial statistical analysis: O.S.
\item Initial draft: O.S.
\item Specific domain knowledge: M.R., S.H.B., S.B., S.A., N.T.
\item Review of first draft: M.T.S, S.A.
\item Review of subsequent drafts: All authors
\item Supervision of the statistical analysis: S.A., M.T.S.
\item Supervision: S.H.B., M.T.S, S.A., S.B.
\end{itemize}

\subsection*{Data and codes}

Data cannot be shared due to legal constraints associated with the use of the French reference methodology MR-004. 

Codes are available on the first author's GitHub page: \url{https://github.com/osupplisson/hpv_prevalence}.



\subsection*{Acknowledgements}

We are grateful to the genotoul bioinformatics platform Toulouse Occitanie (Bioinfo Genotoul, \url{https://doi.org/10.15454/1.5572369328961167E12}) for providing help and computing and storage resources".

The authors acknowledge the  ISO 9001 certified IRD i-Trop HPC (South Green Platform) at IRD Montpellier for providing HPC resources that have contributed to the research results reported within this paper. \url{https://bioinfo.ird.fr/}-\url{http://www.southgreen.fr}

We are also thankful to Bioclust, the computing cluster of PB-IBENS (LABEX MEMOLIFE members) for providing storage resources. \url{https://www.ibens.bio.ens.psl.eu/spip.php?rubrique55#bioclust}


\savegeometry{Mem}
\captionsetup[figure]{labelfont={color=white},font=bf}
\thispagestyle{empty}\addtocounter{page}{-1} 
\newgeometry{left=0.001cm, right=0.001cm, top=0.001cm, bottom=0.001cm}

\blscape




```{r "figure1"}
#| fig.cap = "\\label{mapbias}",
#| fig.width=29.7,
#| fig.height=22.5

p <- ggpubr::ggarrange(
ggpubr::ggarrange(
 space30_differencetest_hpv1618+
  labs(color = element_blank(), fill = element_blank())+
   theme(legend.position = "none") +
  labs(subtitle = "Metropolitan France"),
 space30_differencetest_hpvother+ 
  labs(color = element_blank(), fill = element_blank())+
   theme(legend.position = "none")+
  labs(subtitle = "Metropolitan France"),
 labels = c("A) ", "B) "),
 font.label = list(size = 22, color = "black", face = "bold", family = NULL)
 ),
ggpubr::ggarrange(
paris30_differencetest_hpv1618 +
  labs(subtitle = "Zoom on Paris region"),
paris30_differencetest_hpvother+
  labs(subtitle = "Zoom on Paris region"),
labels = c(" ", " "), 
nrow = 1),
heights = c(2,1),
nrow = 2)

p

```

```{r "figure2"}
#| fig.cap = "\\label{mapspatial30}",
#| fig.width=29.7,
#| fig.height=22.5

p <- ggpubr::ggarrange(
ggpubr::ggarrange(
france30_hpv1618 +
 labs(color = element_blank(), fill = element_blank())+
   theme(legend.position = "none")+
  labs(subtitle = "Metropolitan France"),
france30_hpvother+
 labs(color = element_blank(), fill = element_blank())+
   theme(legend.position = "none")+
  labs(subtitle = "Metropolitan France"),
labels = c("A) ", "B) "),
 font.label = list(size = 22, color = "black", face = "bold", family = NULL)),
ggpubr::ggarrange(
paris30_hpv1618+
  labs(subtitle = "Zoom on Paris region"),
paris30_hpvother+
  labs(subtitle = "Zoom on Paris region"),
labels = c(" ", "")),
heights = c(2,1),
nrow = 2)

p
```




```{r}
plot_cp <- ggpubr::ggarrange(
    plot_number_cp,
    diff_number_cp,
  labels = c("C) ", "D) "),
 font.label = list(size = 22, color = "black", face = "bold", family = NULL),
 ncol = 2)
```



```{r "figure3"}
#| fig.cap = "\\label{probacity}",
#| fig.width=29.7,
#| fig.height=22.5

ggpubr::ggarrange(
  plot_summary_city,
  diff_between_test_city,
  plot_cp,
  labels = c("A) ", "B) ", " "),
 font.label = list(size = 22, color = "black", face = "bold", family = NULL),
  nrow = 3)

```

```{r "figure4"}
#| fig.cap = "\\label{differenceage}",
#| fig.width=29.7,
#| fig.height=22.5
ggpubr::ggarrange(
  ggpubr::ggarrange(
  plot_or_time,
  plot_expected_prevalence + 
   labs(caption = element_blank()),
  nrow = 1,
  labels = c("A) ", "B) "),
 font.label = list(size = 22, color = "black", face = "bold", family = NULL)),
  plot_ameage+
  labs(color = element_blank(), 
     fill = element_blank(),
     caption = "For all plots, dots represent the posterior average and bars the posterior ETI95%.")+
   theme(legend.position = "none"),
  labels =c(" ", "C) "),
 font.label = list(size = 22, color = "black", face = "bold", family = NULL),
  nrow = 2,
  heights = c(1,2))
```




\elscape

\loadgeometry{Mem}




\pagestyle{plain}
\hiddenchapter{Supplementary Files}
\section*{Supplementary Files}

This supplementary material is hosted by Eurosurveillance as supporting information alongside the article 'High-risk human papillomavirus cervical infection prevalence in France, 2020-2023: a nationwide, large-scale, and spatially resolved retrospective study comparing opportunistic and organised screening', on behalf of the authors, who remain responsible for the accuracy and appropriateness of the content. The same standards for ethics, copyright, attributions and permissions as for the article apply. Supplements are not edited by Eurosurveillance and the journal is not responsible for the maintenance of any links or email addresses provided therein.


```{r eval=FALSE, include=FALSE}
Supplementary Files for the article 'High-risk human papillomavirus cervical infection prevalence in France, 2020-2023: a nationwide, large-scale, and spatially resolved retrospective study comparing opportunistic and organised screening'.

```


\newpage

\setcounter{section}{0}
\setcounter{subsection}{0}
\setcounter{table}{0}
\setcounter{figure}{0}
\setcounter{page}{1}
\captionsetup[figure]{list=yes}
\captionsetup[table]{list=yes}
\captionsetup[figure]{labelfont={color=red},font=bf}

\renewcommand{\thefigure}{S\arabic{figure}}
\renewcommand{\thetable}{S\arabic{table}}


\tableofcontents
\newpage
\listoffigures
\newpage
\listoftables
\newpage


\renewcommand\thesection{S\arabic{section}}
\renewcommand\thesubsection{S\arabic{section}.\arabic{subsection}}


\section{Additional details about the French cervical cancer screening guidelines \label{guidelines}}

The latest French guidelines for cervical cancer screening were updated in 2019. These guidelines recommend, for females aged 25 to 29, 2 cytological analyses at a one-year interval if the first result is normal, and, in the absence of abnormality on both cytological analyses, a new cytological analysis 3 years later. In the case of an abnormal cytology result, an HR HPV test should be performed. 

For females aged 30 to 65, an HR HPV test should be performed as the first-line test. The first HR HPV test should be performed 3 years after the last normal cytology result, or as early as 30 in the absence of a prior cytology result. If the HR HPV test is negative, the next HR HPV test should be performed 5 years later. In case of a positive HR HPV test for HR HPV, a cytological analysis should be performed within the year. If the cytology result is normal, an HR HPV test should be performed a year later \cite{LeBihanBenjamin2023,Waheed2023}. A detailed note about the management of females with abnormal cervical cytology and positive HR HPV is available in \cite{Brun2025}.

In France, females can undergo cervical cancer screening through 2 pathways. First, upon reception of an invitation from the French National Social Security System, patients can be screened as part of the French National Cervical Cancer Screening programme.  

The current version of this national organised screening programme was set up the 30th of July 2020. The legal document creating this new national screening programme can be accessed on the following link: \url{https://www.legifrance.gouv.fr/loda/id/JORFTEXT000042238343/} (accessed 15th January 2025).


The national organised screening programme proactively invites females who do not follow the screening guidelines by postal mail to visit a doctor, a midwife, or a gynaecologist for a medical examination. As part of this medical examination, a cervical smear can be collected, which is then sent to medical biology or anatomical pathology laboratories for analysis. Alternatively, the biological sampling and analysis can be performed at a medical biology laboratory, following prescription from the primary care provider. Under this screening pathway, referred to as 'organised screening’, the biological analysis is free for the patient and the primary care consultation is reimbursed according to standard nationwide rules. 

Starting in mid-2024, invitations are also sent online, and the visit to a primary care provider is no longer required: participants can directly visit a medical biology laboratory for biological sampling and analysis.

As an alternative to the organised screening pathway, patients may undergo 'opportunistic screening’, meaning that patients spontaneously consult a primary care provider, without any invitation from the French National Social Security System. Any subsequent HR HPV test after this initial consultation is then subject to an out-of-pocket cost.



\newpage
\section{Details about the French administrative organisation \label{studyadminlandscape}}


One key issue we had to deal with was the misalignment between two available spatial IDs:
\begin{itemize}
\item The France administrative dataset identifies city using a single unique ID, known as the code commune;
\item The dataset extracted from Cerba provided the postcode of each patient. Postcodes are defined based on postman's rounds;
\end{itemize}

Three cases could happen:
\begin{itemize}
\item the postcode corresponds to single unique ID in its entirety (one-one relationship);
\item the postcode corresponds to several unique IDs in their entirety (one-to-many relationship);
\item the postcode corresponds to a single unique ID but not in its entirety (many-to-one relationship);
\end{itemize}

To deal with this issue, we relied on the only available open source dataset linking both spatial dimension, as of 2014, available on \url{https://www.data.gouv.fr/fr/datasets/fond-de-carte-des-codes-postaux/}. As a result of this discrepancy between these two spatial ID, one postcode may include several cities. 

The dataset contained only postcodes for metropolitan France. We are not aware of similar dataset for Overseas territories.



The initial data contained `r formating_text(nrow(data_cp),0)` non-overlapping spatial areas, each associated with a unique postcode in metropolitan France. Among these, we kept only cities not located in small islands around metropolitan France. We ended up with `r formating_text(nrow(data_cp_final),0)` unique postcodes, which were used to build the spatial neighbourhood matrix.



Supplementary figure \ref{citymap} shows the spatial delimitation of all cities considered in the study. 


```{r }
#| fig.cap = "Layout of postcodes in metropolitan France. \\label{citymap}",
#| fig.width=12,
#| fig.height=12


tmp <- data_cp_final 
tmp$geometry <- ms_simplify(tmp$geometry,
              keep = 0.025,
              keep_shapes = T)


ggplot() + 
 gg(tmp) + 
 theme_map() +
 labs(fill = element_blank())+
 theme(legend.direction = "horizontal", legend.position = "bottom")

```

Among all these cities, we considered specifically 11 of them, for computing the conditional prevalence (Supplementary Figues \ref{cities}.


```{r}
#| fig.cap = "Centroid of the main French cities in metropolitan France. For Paris, Lyon, and Marseille, the centroid of the 1st arrondissement is displayed. \\label{cities}",
#| fig.width=11,
#| fig.height=11
 
centroid_major_city <- readRDS(file = "hpv/clean_data/output/centroid_major_city.RDS")

centroids <- as_tibble(st_coordinates(st_centroid(centroid_major_city%>% 
 st_transform(crs(urban_unit))) %>% .$geometry))
centroid_major_city <- centroid_major_city %>% cbind(centroids)

ggplot() +
  gg(fr_mask, fill = "white") + 
  gg(centroid_major_city, color = 'red') +
  geom_text_repel(
    data = centroid_major_city,
    aes(
      x = X,
      y = Y,
      label = city
    ),
    color = "black",   
    bg.color = "white", 
    size = 8,
    segment.size = .25,
    segment.alpha = .8,
    force = 5,
    force_pull = 10
  ) +
 theme_map()
```


In France, cities are organised within administrative divisions known as 'départements' ('districts', in the main text). Metropolitan France comprises 96 districts, grouped into 13 regions. Two of these districts are situated on Corsica, an island located between France and Italy. France's administrative structure is illustrated in Supplementary Figure \ref{mapfr}. Paris, France's capital city, lies at the center of the Île-de-France region, depicted in Supplementary Figure \ref{mapidf}. In addition to districts located in metropolitan France, 5 districts are located in Overseas territories: Martinique, Guadeloupe, Guyane, Réunion and Mayotte. Of these districts, Guyane is the only one that is continental in nature. Each of this district are also region.



```{r}
#| fig.cap = "Administrative subdivision of metropolitan France. \\label{mapfr}",
#| fig.width=13,
#| fig.height=13
library(rcartocolor)
library(paletteer)
map <- carto_district %>% 
 left_join(carto_region %>% st_drop_geometry %>% select(insee_reg, nomr = nom), by = "insee_reg") %>% 
 st_as_sf() %>% 
 st_transform(st_crs(crs_init))
 
centroids <- as_tibble(st_coordinates(st_centroid(map$geometry)))
map <- map %>% cbind(centroids)


map$geometry <- ms_simplify(map$geometry,
 keep = 0.025,
 keep_shapes = T
)

p <- ggplot() + 
 gg(map,
   aes(fill = nomr), color = alpha("black", 1 / 2)) +
 geom_text_repel(
  data = map,
  aes(
   x = X,
   y = Y,
   label = nom
  ),
  color = "black",   
  bg.color = "white", 
  size = 6,
  segment.size = .25,
  segment.alpha = .8,
  force = 5,
  force_pull = 10
 ) +
 theme_map() + 
  theme(legend.direction = "horizontal", legend.position = "bottom")+
   labs(fill = "Region: ") +
  scale_fill_paletteer_d("rcartocolor::Pastel")

p
```


```{r}
#| fig.cap = "Administrative subdivision of Paris region (Île-de-France). \\label{mapidf}",
#| fig.width=10,
#| fig.height=6

p <- ggplot() + 
 gg(map %>% filter(nomr == "Île-de-France"),
   aes(fill = nomr), color = alpha("black", 1 / 2)) +
 geom_text_repel(
  data = map %>% filter(nomr == "Île-de-France"),
  aes(
   x = X,
   y = Y,
   label = nom
  ),
  color = "black",   
  bg.color = "white", 
  size = 6,
  segment.size = .25,
  segment.alpha = .8,
  force = 5,
  force_pull = 10
 ) +
 theme_map() + 
  theme(legend.direction = "horizontal", legend.position = "bottom")+
   labs(fill = "Region: ") +
  scale_fill_manual(values = "#C9DB74")

p
```

\newpage

\section{Sample selection flowchart \label{flowchart}}

All missing and erroneous items were due to issues at the time of patients' registration, before test uptake, and therefore could be considered as Missing Completely at Random with respect to test results.

Starting from the initial dataset, we excluded all test results associated with patients who had missing age or anonymous ID, because age was required for modelling, and an anonymous ID was necessary to ensure we wouldn't consider the same individuals multiple times in the analysis.


We further restricted the dataset to include only patients aged 15 to 79. We did so because the number of tests outside this age range was small and therefore the descriptive reporting of the results made little sense due to a likely extreme selection process. We also suspected that patients recorded as aged 0 likely had erroneous birthdate entries in Cerba’s database.


We then filtered out all tests with missing postcodes or associated with persons living outside France. We did this because our research focused on France.


As a next step, we filtered out tests recorded as both organised and opportunistic screening, which indicated a potential issue at the data reporting step.


Because invitations to take part in the organised screening programme are theoretically restricted to females aged 25 to 65, we removed all tests labeled as organised screening for patients younger than 25 or older than 66. We considered a one-year slack (66 instead of 65-year-old) to allow for a delay between screening invitation and screening uptake.

We then filtered out tests associated with postcodes unmatched in the French administrative dataset. 

In the case of individuals testing multiple times, we only kept the most recent test. We did so for three reasons. First, considering population-level modelling helped to slightly alleviate the computational burden associated with model fitting. Second, there was almost no individual testing multiple times within the organised screening pathway, preventing us from considering individual-specific modelling that accounts for screening pathways.


\begin{figure}
\centering
\includegraphics{flowchart.pdf}
\caption{Analytic sample selection flowchart}
\end{figure}

\newpage
\section{Descriptive reporting for the 'Descriptive samples' \label{descstat}}


\subsection{Descriptive reporting among females aged [15-79] in metropolitan France}


The descriptive sample contained the results of `r formating_text(sum(descriptivefigures$descriptive_plot_sample$data %>% filter(type == "All") %>% .$value),0)` tests, most of which (around 95%) were collected during opportunistic screening. Test dates ranged from the week of `r as.Date(paste(dfdate %>% filter(idtime == min(data_bru$idtime)) %>% .$week, 1, sep="-"), "%Y-%U-%u")` to this of `r as.Date(paste(dfdate %>% filter(idtime == max(data_bru$idtime)) %>% .$week, 1, sep="-"), "%Y-%U-%u")` (i.e., a total of `r maxnumberweek` weeks). See Supplementary Figure \ref{testtime} for the number of tests each week. 

The breakdown of these tests by age was highly unbalanced for opportunistic screening but less so for organised screening (Supplementary Figure \ref{descfig}A and B). The number of tests was highly variable between years (Supplementary Figure \ref{descfig}A). This should not be interpreted as a variation in screening effort. First, the lower testing levels in 2020 are attributable to the COVID-19 pandemic context (social distancing measures such as lockdowns, disrupted medical follow-up, and avoidance of medical facilities for fear of higher transmission risk). Second, Cerba and other medical biology laboratories started to implement the 2019 guidelines during 2020. Third, the sharp drop for 2022 and 2023, compared with 2021, was due to a change in Cerba's internal organisation, with an important proportion of collected samples being sent for analysis to another entity of the Cerba group, for which we could not export the data.

During the entire study period, `r descriptivefigures$descriptive_plot_year$data %>% filter(type == "All" & year == "All") %>% filter(str_detect(name, "Negative")) %>% mutate(value = 100*value) %>% .$value %>% formating_text(.,1)`% of the tests were negative, `r descriptivefigures$descriptive_plot_year$data %>% filter(type == "All" & year == "All") %>% filter(str_detect(name, "16")) %>% mutate(value = 100*value) %>% .$value %>% formating_text(.,1)`% were positive for HPV16, `r descriptivefigures$descriptive_plot_year$data %>% filter(type == "All" & year == "All") %>% filter(str_detect(name, "18")) %>% mutate(value = 100*value) %>% .$value %>% formating_text(.,1)`% were positive for HPV18, and `r descriptivefigures$descriptive_plot_year$data %>% filter(type == "All" & year == "All") %>% filter(str_detect(name, "other")) %>% mutate(value = 100*value) %>% .$value %>% formating_text(.,1)`% were positive for other genotypes. The observed global raw prevalence was greater for opportunistic screening (`r formating_text(100*(data_bru %>% filter(type == "ind") %>% mutate(x = N-case000) %>% .$x %>% sum / sum(data_bru%>% filter(type == "ind") %>% .$N)),1)`%) than for the organised one (`r formating_text(100*(data_bru %>% filter(type == "orga") %>% mutate(x = N-case000) %>% .$x %>% sum / sum(data_bru%>% filter(type == "orga") %>% .$N)),1)`%). A similar result was found when stratifying by age and year (Supplementary Figure \ref{descfig}D). Details about coinfections are reported in Supplementary Table \ref{coinfection}.



\newgeometry{left=0.001cm, right=0.001cm, top=0.001cm, bottom=0.001cm}
\blscape


```{r "descfig"}
#| fig.cap = "Descriptive reporting for females aged [15-79] in metropolitan France. A) Number of HR HPV tests, stratified by year and type of screening. B) Number of tests, stratified by age, and type of screening. C) Proportion of tests by result (positive for HPV16, positive for HPV18, positive for other genotypes, and negative), stratified by year and type of screening. D) Proportion of tests by result, stratified by age and type of screening. \\label{descfig}",
#| fig.width=29.7,
#| fig.height=20
ggpubr::ggarrange(p1, p2, nrow = 2)
```


\elscape


\loadgeometry{Mem}


```{r}

descriptivefigures$descriptive_plot_sample$data %>% 
  group_by(type) %>% 
  mutate(pct = 100*value/sum(value)) %>% 
  plyr::rbind.fill(descriptivefigures$descriptive_plot_sample$data %>% 
             mutate(year = 1) %>% 
             group_by(year, type) %>% 
             summarise(value = sum(value))) %>% 
  select(type, year, value, pct) %>% 
  arrange(type, year) %>% 
  mutate(year = ifelse(year == 1, "All", as.character(year)),
      pct = ifelse(is.na(pct), " ", formating_text(pct, 2)),
      value = formating_text(value, 0)) %>% 
  right_join(descriptivefigures$descriptive_plot_year$data %>% 
          mutate(name = str_remove_all(name, "Positive "),
             name = str_remove_all(name, " to all genotypes")) %>% 
          transmute(type = type, 
               year = year,
               name = name,
               pos = formating_text(100*value, 2)) %>% 
          pivot_wider(names_from = name, values_from = pos)
  ) %>% 
  knitr::kable(
    col.names = c(
      "Type of screening",
      "Year",
      "Number of tests",
      "\\% of total test",
      "HPV16",
      "HPV18", 
      "Other genotypes",
      "Negative"
    ),
    format = "latex",
    label = "tabledescyearsex",
    caption = "Number of tests and observed cervical infection prevalence, stratified by year and type of screening. Table counterpart to Supplementary Figure \\ref{descfig}A and C.",
    align = "c",
    escape = F,
    booktabs = T,
    linesep = ""
  ) %>%
  add_header_above(c(
    " " = 4,
    "Positive" = 3,
    " " = 1
  )) %>% 
  kable_styling(
    # font_size = 6,
    latex_options = c(
      "scale_down",
      "repeat_header",
      "HOLD_position"
    ),
    position = "center"
  ) %>%
  add_header_above(c(
    " " = 4,
    "Results (% of tests)" = 4
  ))


```

```{r}
#| fig.cap = "Number of tests performed in each time step (year-week), stratified by type of screening. \\label{testtime}",
#| fig.width=11,
#| fig.height=11
 
descriptivefigures$plot_ntest
```



```{r}
x <- data_bru %>% 
  rbind(data_bru %>% mutate(type = "All")) %>% 
  mutate(type = case_when(type == "orga"~ "Organised",
              type == "ind" ~ "Opportunistic",
              TRUE ~ "All"),
      type = factor(type, levels = c("All", "Organised", "Opportunistic"))) %>% 
 st_drop_geometry()


x <- x %>% 
  rbind(x %>% mutate(age_class = "All")) %>% 
  group_by(age_class,type) %>% 
  summarise_at(vars(starts_with("case"), "N"), ~sum(.))%>% 
  mutate_at(vars(starts_with("case")), ~formating_text(100*./N,2)) %>% 
  arrange(desc(age_class),type) %>% 
  mutate(N = formating_text(N,0))


x %>% 
  knitr::kable(
    col.names = c(
      "Age",
      "Type of screening",
      str_remove_all(colnames(x) %>% tibble() %>% filter(str_detect(., "case")) %>% .$., "case"),
      "Number of tests"
    ),
    format = "latex",
    label = "xxx",
    caption = "Proportion of tests with coinfection, stratified by type of screening and age.  \\label{coinfection}",
    align = "c",
    escape = F,
    booktabs = T,
    linesep = ""
  ) %>%
  add_header_above(c(
    " " = 2,
    "Proportion in % (Order: HPV16, HPV18, Other genotypes)*" = 8,
    " " = 1
  )) %>% 
  kable_styling(
    # font_size = 6,
    latex_options = c(
      "scale_down",
      "repeat_header",
      "HOLD_position"
    ),
    position = "center"
  ) %>% 
 add_footnote(c("*: Positive tests are flagged with 1 and negative tests by 0."), notation = "symbol")




```



```{r}

t1 <- descriptivefigures$number_test_age$data %>%
  plyr::rbind.fill(descriptivefigures$number_test_age$data %>% 
             mutate(type = "All") %>% 
             group_by(type, age_class) %>% 
             summarise(value = sum(value)) %>% 
             ungroup()) %>% 
  dplyr::select(-name, -label) %>% 
  group_by(type) %>% 
  mutate(pct = 100*value/sum(value)) %>% 
  ungroup() 

t2 <- data_bru %>%
  st_drop_geometry() %>% 
  mutate(type = 'All') %>% 
  rbind(data_bru%>%
       st_drop_geometry()) %>% 
  group_by(age_class,type) %>%
  summarise(hpv16 = sum(hpv16),
       hpv18 = sum(hpv18),
       hpvother = sum(hpvother),
       hpvneg = sum(hpvneg),
       hpvpos = sum(hpvpos)) %>% 
  mutate(N = hpvneg + hpvpos) %>% 
  mutate_at(
    vars("hpv16",
       "hpv18",
       "hpvother",
       "hpvneg",
       "hpvpos"),
    ~./N) %>% 
  select(-N,-hpvpos) %>% 
  pivot_longer(cols = c(-age_class, -type),
         names_to = "name",
         values_to = "value") %>% 
  filter(!is.na(name)) %>% 
  ungroup() %>% 
  mutate(name = str_remove_all(name, "Positive "),
      name = str_remove_all(name, " to all genotypes")) %>% 
  transmute(type = type, 
       age_class = age_class,
       name = name,
       pos = formating_text(100*value, 2)) %>% 
  pivot_wider(names_from = name, values_from = pos) %>% 
  mutate(type = case_when(type == "ind" ~ "Opportunistic",
              type == "orga" ~ "Organised",
              TRUE ~ type))

left_join(t1,t2) %>% 
  mutate(type = factor(type, levels = c("All", "Opportunistic", "Organised")),
      value = formating_text(value, 0),
      pct = formating_text(pct, 2)) %>% 
  arrange(type) %>% 
  knitr::kable(
    col.names = c(
      "Type of screening",
      "Age",
      "Number of tests",
      "\\% of total test",
      "HPV16",
      "HPV18", 
      "Other genotypes",
      "Negative"
    ),
    format = "latex",
    label = "tabledescyearsex",
    caption = "Number of tests and observed infection prevalence, stratified by age and type of screening. Table counterpart to Figure \\ref{descfig}B and D.",
    align = "c",
    escape = F,
    booktabs = T,
    linesep = ""
  ) %>%
  add_header_above(c(
    " " = 4,
    "Positive" = 3,
    " " = 1
  )) %>% 
  kable_styling(
    # font_size = 6,
    latex_options = c(
      "scale_down",
      "repeat_header",
      "HOLD_position"
    ),
    position = "center"
  ) %>%
  add_header_above(c(
    " " = 4,
    "Results (% of tests)" = 4
  ))


```

\blscape

\subsection{Descriptive reporting among females aged [15-79] in Overseas Territories}

The number of tests for people living in Overseas territories was `formating_text(sum(df_dom_tom$N),0)`, among which the share of tests collected through opportunistic screening was `r formating_text(100*sum(df_dom_tom %>% filter(type == "ind") %>% .$N)/sum(df_dom_tom$N),1)`%. A complete reporting of the descriptive statistics are provided in the Supplementary Table \ref{domtomdesc}.

```{r}
x <- c("type",
     "year",
     "age_class",
     "nom_dep")
 list_x <- do.call(c, lapply(seq_along(x), combn, x = x, simplify = FALSE))
 
X_fun <- function(vector) {
 A <- df_dom_tom %>%
  st_drop_geometry() %>% 
  mutate(hpv1618 = pmax(hpv16, hpv18),
      all = pmax(hpv16, hpv18, hpvother)) %>% 
  mutate(type = ifelse(type == "ind", "Opportunistic", "Organised")) %>% 
  select(year, type, age, code_postal, N, hpv1618, hpv16, hpv18,hpvother, all, hpvother, nom_dep) %>%
  mutate(age_class = cut(
    age,
    c(min(age), 24, seq(29, 60, 10), 66, max(age)),
    ordered = T,
    include.lowest = T
  )) %>% 
  group_by_at(vector) %>%
  summarise_at(vars("hpv16", "hpv18", "hpv1618", "hpvother", "all", "N"),~sum(.)) 
 
 B <- A %>%
  mutate_at(vars("hpv16", "hpv18", "hpv1618", "hpvother", "all", "N"),~100*./N) %>% 
  rename_at(vars("hpv16", "hpv18", "hpv1618", "hpvother", "all", "N"),
       ~paste0(.,"pct"))
 A %>% 
  left_join(B) %>% 
  select(-Npct) %>% 
  select(vector,
      N,
      hpv16,
      hpv16pct,
      hpv18,
      hpv18pct,
      hpv1618,
      hpv1618pct,
      hpvother,
      hpvotherpct,
      all,
      allpct)
  
}

descdomtom <- list_x %>%
 imap(~X_fun(.x)) %>% 
 do.call(plyr::rbind.fill,.) %>% 
 select(x, everything()) %>% 
 mutate(age_class = as.character(age_class)) %>% 
 mutate_at(vars(contains("pct")),
      ~formating_text(., 1)) %>% 
 mutate_at(vars(-contains("pct"),
         -x),
      ~formating_text(., 0)) %>% 
 mutate_all(~ifelse(is.na(.), " ", .))

descdomtom %>% 
  knitr::kable(
   col.names = c("Screening",
          "Year",
          "Age",
          "District",
          "Number of tests (N)",
          rep(c("N", "\\%"),5)),
    format = "latex",
    label = "tabledescyearsex",
    caption = "Number of tests and observed prevalence, stratified by genotype group, type of screening, year, age, and district. \\label{domtomdesc}",
    align = "c",
    escape = F,
    booktabs = T,
    linesep = "",
   longtable = T
  ) %>%
  kable_styling(
    font_size = 11,
    latex_options = c(
      #"scale_down",
      "repeat_header",
      "HOLD_position"
    ),
    position = "center"
  ) %>%
  add_header_above(c(
    "Variables" = 4,
    " " = 1,
    "HPV16" = 2,
    "HPV18" = 2,
    "HPV16/18" = 2,
    "HPV-other" = 2,
    "At least 1 HR HPV " = 2
  ))%>%
  add_header_above(c(
    " " = 5,
    "Positive for..." = 2+2+2+2+2
  ))

```


\elscape

\section{Additional statistical details \label{additionalstat}}

\subsection{Complete textual description of the statistical model}

The statistical inference relied on a full Bayesian approach. We aggregated the number of tests and positive test results at the stratum level. Strata were defined by a grid based on the screening pathway (opportunistic or organised), age (30 to 66 years), week-year of screening, postcode, and genotype groups. Two groups of genotypes were considered: HPV16 and/or HPV18 (further denoted as 'HPV16/18’) and genotypes other than HPV16/18 (further denoted 'Other genotypes’). The aggregation of the number of tests positive for HPV16/18 was motivated by the fact that HPV16 and HPV18 stand out in terms of oncogenicity compared to other genotypes \cite{whohpv}, such that public health policies often do not distinguish between them. For example, these two genotypes are the only ones included in all the licensed vaccines available in France \cite{has1,spfhpv}.


The number of positive tests within each stratum was assigned a binomial distribution, the size parameter of which was the total number of tests performed within each stratum. The expected proportion of positive tests within a stratum was linked, through the standard logistic function (i.e., the inverse logit function), to a set of predictor using each stratum’s characteristics as input. 


Each stratum's linear predictor included a common intercept and additional parameters associated to the full two-ways interaction between dummy variables associated with strata related to other genotypes and opportunistic screening (minus one of those interactions, for identifiability of the intercept). Other parameters were divided into two groups. Other components were split into 2 groups. Each group of parameters contained spatially-varying, age-varying, and time-varying parameters to which we assigned multivariate hierarchical priors. The first group was common to both data collected through opportunistic and organised screening. The second group was specific to data collected through opportunistic screening and allowed to capture the potential systematic difference in expected prevalence associated with this screening pathway. 

Spatially-varying parameters were specified through two-dimensional continuous functions, to which we assigned a Gaussian random field (GRF) prior, i.e., a bivariate Gaussian process (GP) \cite{Rasmussen2006Gaussian, Lindgren2011,Lindgren2022} (Models 1 and 2). Alternatively, for models 3 to 6, the spatially-varying parameters were specified through discrete spatially-indexed parameters to which we assigned a scaled reparametrised Besag-York-Mollié (BYM2) prior, a Gaussian Markov random field prior (GMRF) which is the current workhorse in spatial statistics for areal data \cite{Rue2005,Riebler2016,MacNab2022,MacNab20222}. Age-specific and time-specific components were each specified through ordered parameters to which we assigned a Random Walk of order 2 (RW2), a GMRF also known as Bayesian P-splines, as priors  \cite{langbrezger,Rue2005}. 


For models involving spatial GRFs, we assigned to each stratum the centroid of the corresponding postcode. We used the stochastic partial differential equation approach (SPDE) to build computationally efficient representations of all the GPs \cite{Lindgren2011,Lindgren2022}. In two dimensions, the approach relies on the use of a triangular mesh, which was built using the French coordinate reference system, Lambert-93 (EPSG:2154), with kilometer as the distance unit. We tested two different GRF: one GRF with a stationary Matérn covariance function \cite{Lindgren2011} (model 1) and the non-stationary Barrier model \cite{Bakka2019} (model 2). The latter model accounted for the Mediterranean Sea and neighboring countries as a natural barrier, making Corsica a separate area from France Mainland. For this model, the fraction of the range parameter for the barrier domain was set to 0.1 of that of the land domain \cite{Bakka2019}. The final mesh is available in Supplementary Files \ref{additionalstat}.


Conversely, for the BYM2 priors, the spatial index was built from the list of French postcodes (see Supplementary Files \ref{studyadminlandscape}). Four different neighbourhood matrices were considered: the Delaunay Triangulation structure (model 3, \cite{Su1997}), the Sphere of Influence (SOI) subgraph of the Delaunay Triangulation structure (model 4, \cite{Dwyer1995}), and the first-order or second-order Queen contiguity structure (model 5 and 6, \cite{moraga}).


All models accounted for the bivariate nature of the outcome through an exchangeable separable correlation structure between the two groups of genotypes superimposed on each age, space, and time-specific components following \cite{riebler}. Riebler \textit{et al.} \cite{riebler} approach relies on the use of Kronecker product between two precision matrices, hereby assuming that the covariance structure between two dimensions are separable \cite{matrixvariatekp,Wang2022}. This is a classical approach in the analysis of multidimensional data \cite{Wang2022}. This bivariate structure allowed us to test for between-genotype differences while accounting for the fact that infection prevalences were computed from tests performed on the same participants and originated from similar contact and transmission patterns.

All hyperparameters of G(M)RF components, except those for the correlation structure, were assigned penalising-complexity (PC) priors, to mitigate the risk of overfitting inherent to such highly flexible model components \cite{Simpson2017,Simpson20172,Fuglstad2018} Similarly, each parameter specific to other genotypes, opportunistic screening, and the interaction between these two dimensions received a hierarchical prior with their standard deviation being assigned a PC-prior parametrised.  These PC-prior allowed the posterior of these components to shrink towards 0 if not supported by the data. In addition, they allowed to consider larger tail, while ensuring regularisation, compared with a standard Gaussian distribution (see Supplementary Figure \ref{pcprior}). PC-prior are intuitively parametrised through two parameters, specifying the probability for the parameter of interest to be greater or lower than a threshold, depending on the type of PC-prior. These parameters enable the control of the strength of the penalty applied to the deviation from the base model and hence the amount of support that should be provided by the data to support this additional component.

All assigned priors were very weak priors, meaning that high variance and correlation were not excluded \textit{a priori}. PC priors for the marginal variances of the G(M)RF components were parametrised such that the probability for these parameters to be greater than $10$ was 0.01. PC priors for the range parameters were parametrised such that the probability for these parameters to be lower than half the average distance between the two furthest points of metropolitan France on the latitude and longitude axes (i.e., 545 km), was 0.99. The relative weights between the structured and unstructured heterogeneity of BYM2 components received a PC prior parametrised such that the probability to be lower than 0.5 was 0.5. The global intercept, common to all data, received an univariate Gaussian prior with a variance equal to $10$ (i.e., a precision equal to 0.1). The density for other additional intercepts was such that half the density was greater than 1. Finally, all latent parameters of the exchangeable correlation structure were parametrised using the general Fisher’s z-transformation. The corresponding latent parameters were assigned univariate Gaussian distribution as priors with variance set to 5, resulting in a U-shaped prior allowing us to put sufficient probability mass to extreme values and hence not excluding \textit{a priori} extreme correlation \cite{riebler}.

The six competing spatial structures were discriminated through the use of leave-one-group-out cross-validation approach, following \cite{lgocv,Adin2024}. We first computed the posterior predictive density of each observed data point, conditioning on the non-observation of a group of data, further named leave-one-group-out cross validation (LGO-CV). The group of data used to compute this quantity, comprised 32 observations which were automatically selected using the posterior correlation matrix of the model \cite{lgocv,Adin2024}. We further computed the logarithmic score associated with these LGO-CV, defined as minus the average logarithmic LGO-CV, and selected the model with the lowest value \cite{Gneiting2007,Adin2024}.

The model was estimated using the \texttt{inlabru} package \cite{Bachl2019,brunew} (development version as of 29/01/2025, test version 2.12.0.9002), a wrapper around the \texttt{R-INLA} package (development version as of 29/01/2025, test version 25.01.23, Rocky Linux-8.10 (Green Obsidian) build) \cite{JSSv063i19,advancesinrinla}, in R version 4.4.0 \cite{r_logiciel}. All quantities were computed using 3,000 draws from the full joint posterior distribution, except for Marginal Difference in Expected Prevalence (see Supplementary subsection \ref{mdep}) for which we used only 1,550 draws due to computing requirement.


The sensitivity analyses explored the effect on the selected model of assigning to correlation parameters a prior with a variance of 1.25 and 2.5, instead of 5. Such a change had the effect of decreasing the weights assigned to extreme values of correlation \cite{riebler}. We also reported the results of the non-selected models.

\newpage 

\subsection{Mathematical details of the statistical model}

\textbf{Notations and references}

\begin{itemize}
\item Let $B^-$ denote the generalised inverse of the matrix $B$.
\item Let $\mathcal{N}\left(\mu, \sigma^2\right)$ be the Gaussian distribution with expectation $\mu$ and variance $\sigma^2$.
\item Let $\tau=\sigma^{-2}$ be the precision parameter.
\item Let $\text{Cov}(X,Y)$ be the covariance and $\text{Corr}\left(X,Y\right)$ be the correlation between the two random variables $X$ and $Y$.
\item Let $\mathcal{PC}_{X}$ denote the appropriate penalising-complexity (PC) prior for the random variable X (see \cite{Simpson2017,Simpson20172,Fuglstad2018}).
\item The PC-prior for the precision parameter $\tau = \sigma^{-2}$ of a GMRF corresponds to a type-2 Gumbel distribution. It corresponds to an Exponential distribution for the standard deviation. Considering the Wasserstein distance within the PC framework introduced in \cite{Simpson2017,Simpson20172}, instead of the Kullback-Leibler Divergence (KLD), leads to the same prior \cite{wpc}. The related R-INLA webpage is: \url{https://inla.r-inla-download.org/r-inla.org/doc/prior/pc.prec.pdf}.
\item Let $d(z,z')$ be the Euclidean distance for $(z,z')\in\mathbb{R}^d\times\mathbb{R}^d,~d\geq1$. 
\item A Gaussian random field $u:\mathbb{R}^d\times\mathbb{R}^d\rightarrow\mathbb{R}$ is defined via the following system:
$$
\begin{cases}
\mathbb{E}\left(u(z)\right) = m(z)\\
\text{Cov}\left(u(z),u(z')\right) = k\left(z,z'\right)\\
\left(u(z_i)\right)_{i\in\lbrace1,\cdots,N\rbrace}\sim\mathcal{N}\left(\left(m(z_i)\right)_{i\in\lbrace1,\cdots,N\rbrace},\left(k(z_i,z_j)\right)_{(i,j)\in\lbrace1,\cdots,N\rbrace}^2\right)
\end{cases}
$$

for all finite location sets $\left(z_1, \cdots, z_n\right)$. With $k\left(.,.\right)$ the covariance function, which is a symmetric positive definite function and $m\left(.\right)$, the mean function (see Chapter 4, \cite{Rasmussen2006Gaussian}). 

If $u$ is a GRF, we will be using the following notation: $u(z)\sim\mathcal{GP}\left(m\left(z\right),k\left(z,z'\right)\right)$.
\item Various choice are available for the covariance kernel $k(.,.)$. In spatial statistics, the most widely used is the Matérn covariance function, which has been dominating the field for more than half a century \cite{historymatérn,Porcu2024}. 
\item Let $C_{\sigma,\nu,\kappa}(z,z')$ be the Matérn covariance function between any two locations $(z,z')\in \mathbb{R}^d\times\mathbb{R}^d$. In our use case, $d=2$. The Matérn covariance function is parametrised through three parameters: the marginal variance $\sigma^2$, the scaling parameter $\kappa>0$, and the smoothness parameter $\nu>0$. 

$$C_{\sigma,\nu,\kappa}(z,z') := \sigma^2\frac{1}{2^{\nu-1}\Gamma(\nu)}\left(\kappa d(z,z')\right)^\nu K_\nu\left(\kappa d(z,z')\right)$$

where $\Gamma$ is the gamma function, $K_\nu$ is the modified Bessel function of the second kind.


Following Lindgren \textit{et al.} \cite{Lindgren2011}, one may use the empirically derived definition $\rho := \frac{\sqrt{8\nu}}{\kappa}$, conferring to the range parameter $\rho$ the following natural interpretation: it is the distance at which the covariance function becomes about 0.1 \cite{Lindgren2011}. 

The smoothing parameter $\nu$ controls the mean-square differentiability of the underlying process. This parameter is usually poorly identifiable and Lindgren \textit{et al.} \cite{Lindgren2011} define it as $\nu:=\alpha-\frac{d}{2}>0$, with $\alpha \in ]0,2]$ a fixed parameter. We used $\alpha = 2$, which is the usual default value.

With such a parametrisation, the covariance function is stationary, meaning that it only depends on the relative position of the two locations, and isotropic, meaning that the covariance between two points depends only on the Euclidean distance between the locations.

Additional details are available in \cite{Lindgren2011,Lindgren2022}.
\item Lindgren \textit{et al.} \cite{Lindgren2011} presents a computationally efficient way to compute Matérn models (i.e., GRF with Matérn covariance function). The method allows going from a computational cost scaling as $\mathcal{O}\left(N^3\right)$, with $N$ the sample size, to $\mathcal{O}\left(n^{3/2}\right)$, with $n$ the number of basis functions used to perform the approximation. This approach is routinely available in R-INLA and was used to handle GRF model components. The mesh we used for carrying out this approximation had `r formating_text(mesh_space$n,0)` nodes. This mesh is represented in the Supplementary Figure \ref{mesh}. 
\item The Matérn covariance function presented above is stationary and isotropic. In real application, physical barriers or holes can lead to a violation of this assumption \cite{Bakka2019}. To handle such cases, Bakka \textit{et al.} \cite{Bakka2019} introduced a non-stationary GRF accounting for physical barriers using the efficient computation approach introduced by Lindgren \textit{et al.} \cite{Lindgren2011}.

To handle physical barriers or holes from the spatial domain of interest, the Barrier model introduces a partition of the domain into two disjoint subspaces. The first of these subspaces corresponds to the normal area (denoted $\Omega_{n}$) while the second part corresponds to physical barriers (denoted $\Omega_{b}$). Each partition receives its own Matérn covariance function. They both share the same marginal standard deviation but they each have their own range parameter.


$$\begin{cases}
\forall(z,z') \in \Omega_{n}: C_{\sigma,\nu,\rho}(z,z') := \sigma^2\frac{1}{2^{\nu-1}\Gamma(\nu)}\left(\frac{\sqrt{8\nu}}{\rho} d(z,z')\right)^\nu K_\nu\left(\frac{\sqrt{8\nu}}{\rho} d(z,z')\right)\\
\forall(z,z') \in \Omega_{b}:C_{\sigma,\nu,\rho_b}(z,z') := \sigma^2\frac{1}{2^{\nu-1}\Gamma(\nu)}\left(\frac{\sqrt{8\nu}}{\rho_b} d(z,z')\right)^\nu K_\nu\left(\frac{\sqrt{8\nu}}{\rho_b} d(z,z')\right)
\end{cases}$$



To keep the computational cost close to that of the stationary case, the range applied to the barrier domain, $\rho_b$, is specified as a fraction of this of the normal domain, $\rho$: $\rho_b = k \times \rho$. We used the default value for $k$: $k=0.1$.

We considered the ocean, seas, and neighbouring countries as natural barriers.
\item The PC-prior for the parameters of the Matérn covariance function is derived in \cite{Fuglstad2018}. Additional details can be found in the documentation of the \texttt{inla.spde2.pcmatern()} function in R-INLA \cite{JSSv063i19,advancesinrinla}, available in \url{https://inla.r-inla-download.org/r-inla.org/doc/prior/pc.matern.pdf}. The PC-prior for the barrier model is available in \cite{Bakka2019}.
\item The R-INLA webpage, which describes the SPDE representation of the GP process with a stationary Matérn covariance function, is available here: \url{https://inla.r-inla-download.org/r-inla.org/doc/prior/pc.matern.pdf} 
\item The Barrier SPDE model \cite{Bakka2019} is implemented in the INLAspacetime package, see \url{https://github.com/eliaskrainski/INLAspacetime}
\item Let $I_{S}$ be the identity matrix with $S$ rows and columns.
\item Let $R$ be a spatially-structured matrix such that $R_{ij}$, the element of row $i$ and column $j$, is defined as $R_{ij} := \begin{cases}n_{i}~\text{if}~i=j\\-1~\text{if}~i \sim j\\0~else\end{cases}$, with $n_{i}$ the number of neighbouring areas for the spatial unit $i$ and $\sim$ denoting the adjacency (neighbouring) predicate.
\item The Matérn and Barrier model considers space in its native continuous form. Because strata are associated with postcodes, we had to assign arbitrary specific coordinates (i.e. those of the centroid) for using these approaches. A more suitable approach not assigning these arbitrary coordinates is to consider that the layout of cities in space form an irregular lattice and then rely on approaches developed specifically to deal with such data, such as the BYM2 model, introduced in \cite{Riebler2016}. The BYM2 model is the current workhorse in areal spatial statistics, notably because it answers to critics directed towards previously developed priors \cite{Rue2005,Riebler2016,MacNab2022,MacNab20222}.

Let $\alpha = \left(\alpha_1, \cdots, \alpha_{S}\right)$ denotes a vector of parameters such that $\forall i \in \lbrace1,\cdots S\rbrace,~\alpha_{i}=\frac{1}{\sqrt{\tau}}\left(\sqrt{1-\phi}v_i+\phi u_i\right)$ with $\tau=\sigma^{-2}$ the marginal precision parameter, $\phi\in[0,1]$ the relative weight of the structured heterogeneity, $v\sim\mathcal{N}\left(0,I_{S}\right)$, and $u\sim\mathcal{N}\left(0,R_*^{-}\right)$. The spatial structure matrix $R_*$ denotes the scaled counterpart of the matrix $R$, meaning  that the average variance (the diagonal of the generalised inverse) is equal to 1, see section 3.2. of \cite{Riebler2016}.



The variance-covariance matrix of $\alpha$ is given by $\mathrm{Var}(\alpha \vert \tau, \phi)=\tau^{-1}\left(\right(1-\phi\left)I+\phi R_*^{-}\right)$.


The classical sum-to-zero identifiability constraint was used.
\item The BYM2 model, like other spatially-structure GMRF, relies on a neighbourhood matrix encoding the conditional dependencies between the data. 

Two distance-based neighbourhood matrices were considered, using the centroid of each postcode. The first one of these distances was the Delaunay Triangulation approach, which is a geometric-based approach connecting areas into triangles such that the minimum angle of all triangles is maximised \cite{Su1997}. The second one consisted in the thinning of the Delaunay Triangulation structure through the sphere of influence approach. Starting from the Delaunay Triangulation neighbourhood structure, two areas area were linked to each other if their circles from the nearest neighbour, defined as the largest circle centred at the centroid of postcode $p$ that contains no other points than this centroid, overlap.


A third and fourth matrices were defined based on the first-order and second-order Queen contiguity approach, respectively.

We used the \texttt{spdep} package to define spatial neighbourhood \cite{spdep1, spdep2, spdep3}. 
\item The PC-prior for the BYM2 model are provided in \cite{Riebler2016} and is implemented in the R-INLA package, see \url{https://inla.r-inla-download.org/r-inla.org/doc/latent/bym2.pdf}
\item Let $\beta = \left(\beta_1, \cdots, \beta_{n}\right)$. Let $\beta$' be the transpose of $\beta$. The RW2 prior has an improper (rank deficiency equal to n-2) prior density given by:

$$
\pi\left(\beta\vert \tau\right)\propto\tau^{\frac{n-2}{2}}\exp\left(-\frac{1}{2}\beta'Q\beta\right),~Q=\tau R_\mathrm{RW2}
$$

With $R_\mathrm{RW2}$ the structure matrix defined as:

$$
R_\mathrm{RW2}:=\begin{pmatrix}
1 & -2 & 1 & 0 & 0 & \cdots & 0 & 0 \\
-2 & 5 & -4 & 1 & 0 & \cdots & 0 & 0 \\
1 & -4 & 6 & -4 & 1 & \cdots & 0 & 0 \\
0 & 1 & -4 & 6 & -4 & \ddots & 0 & 0 \\
\vdots & \vdots & \ddots & \ddots & \ddots & \ddots & \vdots & \vdots \\
0 & 0 & \cdots & 1 & -4 & 6 & -4 & 1 \\
0 & 0 & \cdots & 0 & 1 & -4 & 5 & -2 \\
0 & 0 & \cdots & 0 & 0 & 1 & -2 & 1
\end{pmatrix}
$$


The classical sum-to-zero identifiability constraint was used to avoid confounding with the intercept.

More details are provided in \cite{langbrezger,Rue2005} for further details.
\item The R-INLA webpage, which describes the RW2 prior, is available here: \url{https://inla.r-inla-download.org/r-inla.org/doc/latent/rw2.pdf} 
\item The uniform exchangeable correlation structure through Gaussian Kronecker product Markov random field is introduced in \cite{riebler}.
\end{itemize}

\textbf{Fit on HPC}

Model fit, computation of GCPO, and draws from the joint posterior were performed within the same R-session for models 1 and 2 and models 3 to 6. The Barrier model (Model 2) used results from the Stationary Matérn model (model 1) as starting values for the optimisation process. Similarly, models 3, 4, and 6 used the results from model 5 (BYM2 with Queen-contiguity structure) as starting values for the optimisation process. Once all fits, GCPOs, and draws were obtained, two new R sessions were launched. The first sessions performed the post-fit analyses for non-selected model, fitted the two additional sensitivity analyses, and run the post-analysis R-function on the sensitivity analyses. The second session run the post-analysis R-function on the selected model, which took almost one week to complete because of all the quantities to compute and the large number of draws considered.

HPC logs are available on the Github webpage: \url{https://github.com/osupplisson/hpv_prevalence/tree/main/log_hpc}.

\newpage


\textbf{Full joint model}

Let \(s\) denote a stratum. Let \(\mathcal{S}\) be the set of all strata.

A stratum $s$ is defined by a 5-tuple $s=(a_s,z_s,t_s,g_s,c_s)$ where $a_s$ denotes the age, $z_s$ the postcode, $t_s$ denotes the week-year of screening, $g_s$ the genotype, and $c_s$ denotes the type of screening.


The postcode is a five-digit number, age $a_s$ is an integer belonging to the set $\lbrace30,\cdots,66\rbrace$. The week-year goes from `r as.Date(paste(dfdate %>% filter(idtime == min(data_bru$idtime)) %>% .$week, 1, sep="-"), "%Y-%U-%u")` to that of `r as.Date(paste(dfdate %>% filter(idtime == max(data_bru$idtime)) %>% .$week, 1, sep="-"), "%Y-%U-%u")`, $g_s$ is either 'HPV16/18' or 'Other genotypes', and $c_s$ is either 'Organised screening' or 'Opportunistic screening'.

Depending on the model, this 5-tuple was mapped to a numeric 5-tuple used as inputs of the model components.

\begin{itemize}
\item For space: the postcode was mapped to the centroid (longitude,latitude) of the corresponding spatial area for GRF components and to a unique spatial index for GMRF components;
\item For age: the age was mapped to an age-specific index starting at 1 for females aged 30 and ending at 36 for females aged 66;
\item For time: the week-year was mapped to a time-specific index starting at 1 for the first week-year and ending at 174;
\item For genotypes: 'HPV16/18' was assigned index 1 and 'Other genotypes' was assigned index 2;
\item For screening pathways: 'Organised screening' was assigned index 1 and 'Opportunistic screening index 2;
\end{itemize}

Using these notations, the full hierarchical model is given by the set of specifications in the system below. For clarity, the symbol indicating conditional dependencies has been omitted from the system. In short: the observation level is conditional to the latent field and the latent field is itself conditional to the hyperparameter level. Within the observation level, $y_{s}$ is conditional to $\left(N_{s},p_{s}\right)$, and $p_{s}$ is conditional to $\mu_s$, which is conditional to the latent field.

\begin{equation*}
\begin{cases}\text{Observation level}
\begin{cases}
y_{s} \sim \mathcal{B}\left(N_{s},p_{s}\right)\\
\begin{cases}
p_{s}=\frac{1}{1+\exp\left(-\mu_{s}\right)}\\
\\
\mu_{s}=\psi_0 + \mathbb{1}_{g_s=2} \psi_1 + v_{\text{SPACE}}(z_s,g_{s})+\gamma_{\text{AGE}}(a_{s},g_{s}) +\beta_{\text{TIME}}(t_s,g_{s})+\\
\mathbb{1}_{c_s = 2}\left[\psi_2 + \mathbb{1}_{g_s=2} \psi_3 + v'_{\text{SPACE}}(z_s,g_{s})+\gamma'_{\text{AGE}}(a_{s},g_{s}) +\beta'_{\text{TIME}}(t_s,g_{s})\right]~\text{Model 1 and 2}\\
\\
\mu_{s}=\psi_0 + \mathbb{1}_{g_s=2} \psi_1 + \alpha_{\text{SPACE}}(z_s,g_{s})+\gamma_{\text{AGE}}(a_{s},g_{s}) +\beta_{\text{TIME}}(t_s,g_{s})+\\
\mathbb{1}_{c_s = 2}\left[\psi_2 + \mathbb{1}_{g_s=2} \psi_3 + \alpha'_{\text{SPACE}}(z_s,g_{s})+\gamma'_{\text{AGE}}(a_{s},g_{s}) +\beta'_{\text{TIME}}(t_s,g_{s})\right]~\text{Model 3 to 6}\\
\end{cases}
\end{cases}\\
\text{Parameters}
\begin{cases}
\psi_{0}\sim \mathcal{N}\left(0,10\right)\\
\psi_{j\in\lbrace 1,2,3\rbrace}\sim \mathcal{N}\left(0,\sigma_{\psi_{j\in\lbrace 1,2,3\rbrace}}^2\right)\\
\text{Hyperparameters for } \psi_{j\in\lbrace 1,2,3\rbrace}
\begin{cases}
\sigma_{\psi_{j\in\lbrace 1,2,3\rbrace}} \sim \mathcal{PC}_{\sigma}\left(1,0.5\right)\\
\end{cases}\\
\textbf{RW2 for age and exchangeable correlation structure between genotypes}\\
\mathrm{for}~f\in\{\gamma,\gamma'\},~(g_s,g_s')\in\{1,2\}^2,~(a_s,a_s')\in \lbrace 1,\cdots,36\rbrace^2:\\
\mathrm{Latent~field}
\begin{cases}
f_{\text{AGE}}(a_s,g_s)-2f_{\text{AGE}}(a_s+1,g_s) + f_{\text{AGE}}(a_s+2,g_s)\sim\mathcal{N}\left(0,\sigma^2\right)\\
\mathrm{Corr}(f_{\text{AGE}}(a_s, 1),f_{\text{AGE}}(a_s', 2)) =\eta_{f_{\text{AGE}}}
\end{cases}\\
\mathrm{Hyperparameters}
\begin{cases}
\eta_{f_{\text{AGE}}}=  \frac{\exp(\eta_{f_{\text{AGE}}}^*) - 1}{\exp(\eta_{f_{\text{AGE}}}^*) + 2 - 1}\\
\eta_{f_{\text{AGE}}}^* \sim \mathcal{N}\left(0,5\right)\\\sigma_{f_{\text{AGE}}} \sim \mathcal{PC}_{\sigma}\left(\lambda_{\sigma_{f_{\text{AGE}}}}\right)\\
\lambda_{\sigma_{f_\text{AGE}}} = -\frac{-\log\left(p_{\sigma_{f_\text{AGE}}}\right)}{\sigma_{0}},~\Pr\left(\sigma >\sigma_{0}\right)=p_{\sigma_{f_\text{AGE}}}\\
\left(\sigma_{0},p_{\sigma_{f_\text{AGE}}}\right)=\left(10,0.01\right) \\
\end{cases}\\
\textbf{RW2 for time and exchangeable correlation structure between genotypes}\\
\mathrm{for}~f\in\{\beta,\beta'\},~(g_s,g_s')\in\{1,2\}^2,~(t_s,t_s')\in \lbrace 1,\cdots,174\rbrace^2:\\
\mathrm{Latent~field}
\begin{cases}
f_{\text{TIME}}(t_s,g_s)-2f_{\text{TIME}}(t_s+1,g_s) + f_{\text{TIME}}(t_s+2,g_s)\sim \mathcal{N}\left(0,\sigma^2\right)\\
\mathrm{Corr}(f_{\text{TIME}}(t_s, 1),f_{\text{TIME}}(t_s', 2)) =\eta_{f_{\text{TIME}}}
\end{cases}\\
\mathrm{Hyperparameters}
\begin{cases}
\eta_{f_{\text{TIME}}}=  \frac{\exp(\eta_{f_{\text{TIME}}}^*) - 1}{\exp(\eta_{f_{\text{TIME}}}^*) + 2 - 1}\\
\eta_{f_{\text{TIME}}}^* \sim \mathcal{N}\left(0,5\right)\\\sigma_{f_{\text{TIME}}} \sim \mathcal{PC}_{\sigma}\left(\lambda_{\sigma_{f_{\text{TIME}}}}\right)\\
\lambda_{\sigma_{f_\text{TIME}}} = -\frac{-\log\left(p_{\sigma_{f_\text{TIME}}}\right)}{\sigma_{0}},~\Pr\left(\sigma >\sigma_{0}\right)=p_{\sigma_{f_\text{TIME}}}\\
\left(\sigma_{0},p_{\sigma_{f_\text{TIME}}}\right)=\left(10,0.01\right) \\
\end{cases}\\
...\text{see next page}
\end{cases}\\
\end{cases}\\
\end{equation*}
\newpage

\begin{equation*}
\begin{cases}
\mathrm{Parameters}
\begin{cases}
...next\\
\textbf{Model 1, spatial GRF: GRF with stationary Matérn covariance for space}\\
\textbf{and exchangeable correlation structure between genotypes}\\
\mathrm{for}~f\in\{v,v'\},~(g_s,g_s')\in\{1,2\}^2,~\forall(z_s,z_s')\in \Omega^2:\\
\mathrm{Latent~field}
\begin{cases}
f_{\text{SPACE}}(z_s, g_s) \sim 
\mathcal{GP}\left(0,C_{\sigma_{f_{\text{SPACE}}},\nu_{f_{\text{SPACE}}},\rho_{f_{\text{SPACE}}}}\left(z_s,z_s'\right)\right)\\
\mathrm{Corr}(f_{\text{SPACE}}(z_s, 1),f_{\text{SPACE}}(z_s, 2)) =\eta_{f_{\text{SPACE}}}
\end{cases}\\
\mathrm{Hyperparameters}
\begin{cases}
\eta_{f_{\text{SPACE}}}=  \frac{\exp(\eta_{f_{\text{SPACE}}}^*) - 1}{\exp(\eta_{f_{\text{SPACE}}}^*) + 2 - 1}\\
\eta_{f_{\text{SPACE}}}^* \sim \mathcal{N}\left(0,5\right)\\
\left(\rho_{f_{\text{SPACE}}},\sigma_{f_{\text{SPACE}}}\right) \sim \mathcal{PC}_{(\rho,\sigma)}\left(\lambda_{\rho_{f_{\text{SPACE}}}},\lambda_{\sigma_{f_{\text{SPACE}}}}\right)\\
\lambda_{\sigma_{f_{\text{SPACE}}}}= \arg_{\in \mathbb{R}^+}:\Pr_{\lambda_{\sigma_{f_{\text{SPACE}}}}}\left(\sigma_{f_{\text{SPACE}}}\geq\sigma_{0}\right)=p_{\sigma_{f_{\text{SPACE}}}}\\
\lambda_{\rho_{f_{\text{SPACE}}}}= \arg_{\in \mathbb{R}^+}:\Pr_{\lambda_{\sigma_{f_{\text{SPACE}}}}}\left(\rho_{f_{\text{SPACE}}}\leq\rho_{0}\right)=p_{\rho_{f_{\text{SPACE}}}}\\
\left(\sigma_{0},p_{\sigma_{f_{\text{SPACE}}}}\right)=\left(10,0.01\right)\\
\left(\rho_{0},p_{\rho_{f_{\text{SPACE}}}}\right)=\left(545, 0.99\right)\\
\alpha_{f_{\text{SPACE}}} = 2\\
\end{cases}\\
\\
\textbf{Model 2, spatial GRF: GRF with non-stationary Matérn covariance (Barrier model) for space}\\
\textbf{and exchangeable correlation structure between genotypes}\\
\Omega = \text{Spatial domain, definition domain for the GRF as given by the mesh}\\
\Omega_{b} = \text{Northern and Mediterranean seas, the Atlantic Ocean, the English Channel...}\\
\text{..., and foreign neighbouring countries (Spain, Italy...)}\\
\Omega_{n} = \text{All France mainland and Corsica}\\
\Omega = \Omega_{n}\cup \Omega_{b},~\Omega_{n}\cap\Omega_{b}=\varnothing \\
\mathrm{for}~f\in\{v,v'\},~(g_s,g_s')\in\{1,2\}^2:\\
\mathrm{Latent~field}
\begin{cases}
(z_s,z_s')\in \Omega_{n}^2: f_{\text{SPACE}}(z_s, g_s) \sim 
\mathcal{GP}\left(0,C_{\sigma_{f_{\text{SPACE}}},\nu_{f_{\text{SPACE}}},\rho_{f_{\text{SPACE}}}}\left(z_s,z_s'\right)\right)\\
(z_s,z_s')\in \Omega_{b}^2: f_{\text{SPACE}}(z_s, g_s) \sim 
\mathcal{GP}\left(0,C_{\sigma_{f_{\text{SPACE}}},\nu_{f_{\text{SPACE}}},\rho_{b,f_{\text{SPACE}}}}\left(z_s,z_s'\right)\right)\\
\mathrm{Corr}(f_{\text{SPACE}}(z_s, 1),f_{\text{SPACE}}(z_s, 2)) =\eta_{f_{\text{SPACE}}}
\end{cases}\\
\mathrm{Hyperparameters}
\begin{cases}
\eta_{f_{\text{SPACE}}}=  \frac{\exp(\eta_{f_{\text{SPACE}}}^*) - 1}{\exp(\eta_{f_{\text{SPACE}}}^*) + 2 - 1}\\
\eta_{f_{\text{SPACE}}}^* \sim \mathcal{N}\left(0,5\right)\\
\left(\rho_{f_{\text{SPACE}}},\sigma_{f_{\text{SPACE}}}\right) \sim \mathcal{PC}_{(\rho,\sigma)}\left(\lambda_{\rho_{f_{\text{SPACE}}}},\lambda_{\sigma_{f_{\text{SPACE}}}}\right)\\
\lambda_{\sigma_{f_{\text{SPACE}}}}= \arg_{\in \mathbb{R}^+}:\Pr\left(\sigma_{f_{\text{SPACE}}}\geq\sigma_{0}\right)=p_{\sigma_{f_{\text{SPACE}}}}\\
\lambda_{\rho_{f_{\text{SPACE}}}}= \arg_{\in \mathbb{R}^+}:\Pr\left(\rho_{f_{\text{SPACE}}}\leq\rho_{0}\right)=p_{\rho_{f_{\text{SPACE}}}}\\
\left(\sigma_{0},p_{\sigma_{f_{\text{SPACE}}}}\right)=\left(10,0.01\right)\\
\left(\rho_{0},p_{\rho_{f_{\text{SPACE}}}}\right)=\left(545,0.99\right)\\
\alpha_{f_{\text{SPACE}}} = 2\\
\end{cases}\\
\\
...\text{see next page}
\end{cases}
\end{cases}
\end{equation*}
\newpage



\begin{equation*}
\begin{cases}
\mathrm{Parameters}
\begin{cases}
...next\\
\textbf{Models 3 to 6, spatial GMRF: GMRF with BYM2 structure for space}\\
\textbf{and exchangeable correlation structure between genotypes}\\
\mathrm{for}~f\in\{\alpha,\alpha'\},~(g_s,g_s')\in\{1,2\}^2,~\forall(z_s,z_s')\in \text{Set of postcodes}^2:\\
\mathrm{Latent~field}
\begin{cases}
f_{SPACE}(z_s,g_s) \sim 
BYM2\left(\sigma,\phi,R\right)\\
\mathrm{Corr}(f_{\text{SPACE}}(z_s, 1),f_{\text{SPACE}}(z_s, 2)) =\eta_{f_{\text{SPACE}}}
\end{cases}\\
\mathrm{Hyperparameters}
\begin{cases}
\eta_{f_{\text{SPACE}}}=  \frac{\exp(\eta_{f_{\text{SPACE}}}^*) - 1}{\exp(\eta_{f_{\text{SPACE}}}^*) + 2 - 1}\\
\eta_{f_{\text{SPACE}}}^* \sim \mathcal{N}\left(0,5\right)\\
\phi_{f_{SPACE}} \sim \mathcal{PC}_{\phi}\left(\lambda_{f_{SPACE}}\right)\\
\lambda_{f_{SPACE}} = \arg_{\in \mathbb{R}^+}: \Pr_{\lambda_{\sigma_{f_{\phi_{\text{SPACE}}}}}}\left(\phi_{f_{\text{SPACE}}}\leq\phi_{0}\right)=p_{\phi_{f_{\text{SPACE}}}}\\
\sigma_{f_{SPACE}} \sim \mathcal{PC}_{\sigma}\left(\lambda_{\sigma_{f_{SPACE}}}\right)\\
\lambda_{\sigma_{f_{SPACE}}} = -\frac{-\log\left(p_{\sigma_{f_{SPACE}}}\right)}{\sigma_{0}},~\Pr\left(\sigma >\sigma_{0}\right)=p_{\sigma_{f_{SPACE}}}\\
\left(\sigma_{0},p_{\sigma_{f_{SPACE}}}\right)=\left(10,0.01\right) \\
\left(\phi_{0},p_{\phi_{f_{SPACE}}}\right)=\left(0.5,0.5\right) \\
R: \begin{cases} 
\text{Delaunay Triangulation (model 3)}\\
\text{SOI subgraph of the Delaunay Triangulation (model 4)} \\
\text{1st-order Queen contiguity (model 5)} \\ 
\text{2nd-order Queen contiguity (model 6)} \\ 
\end{cases}
\end{cases}
\end{cases}
\end{cases}
\end{equation*}
\newpage

\newpage

\begin{itemize}
\item We discriminated between competing models using the logarithmic score, computed using the leave-one-group-out conditional predictive ordinate (LOO-CPO), also known as leave-one-group-out cross validation (LGO-CV). Left-out groups comprised 32 observations which were automatically selected using the posterior correlation matrix of the model \cite{Adin2024}.
\item Denoting $\pi$ the probability density function and $y_{-\mathcal{G}_s}$ all observed data leaving out the group of data $\mathcal{G}_s$, defined using the posterior correlation matrix between data points \cite{Adin2024}:
$$
\begin{cases}
\textrm{LGO-CV}_{s} = \pi(y_{s}\vert y_{-\mathcal{G}_s})\\
\text{log-score}=\frac{1}{\text{card}(\mathcal{S})}\left(\sum_{s \in \mathcal{S}}\textrm{LGO-CV}_s\right)
\end{cases}
$$
\end{itemize}



```{r mesh, dev = 'png'}
#| fig.cap = "Spatial location of all data points (green dots) and mesh (grey edges) used for the finite-elements decomposition approximation of the Gaussian random fields. The blue line delineaetes the areas in which the density of the mesh could change. It was defined to be finner within metropolitan France than outside, where no data could be observed. \\label{mesh}",
#| fig.width=11,
#| fig.height=11
 
post_mesh <- readRDS("hpv/clean_data/output/post_mesh.RDS")

post_mesh + 
  theme_map()
```

```{r}
#| fig.cap = "Prior density for a Gaussian prior distribution with PC(1,0.5) hyperprior assigned to the precision parameter (blue curve) compared with a standard Gaussian distribution (red curve) \\label{pcprior}.",
#| fig.width=6,
#| fig.height=5

library(INLA)
set.seed(123)

A <- rnorm(100000, mean = 0, sqrt(
  inla.pc.rprec(10000000, 1, 0.5)
)^(-1)) 

B <- rnorm(100000, mean = 0, sd = 1)

ggplot() +
  geom_density(data = tibble(x = A), aes(x, color = "A"), n = 2^(16)) +
  geom_density(data = tibble(x = B), aes(x, color = "B"), n = 2^(16)) +
  labs(y = "Prior density for the paramater",
       color = "Prior assigned to the standard \n deviation of the Gaussian prior",
        x = "Parameter") +
  theme_minimal()+
  scale_color_manual(values = c("blue", "red", "orange"), label = c("PC(1,0.5)", "N(0,1)"))+
 theme(legend.direction = "horizontal", legend.position = "bottom")


```



```{r}
#| fig.cap = "PC-prior for the standard deviation of GMRFs.",
#| fig.width=6,
#| fig.height=5


set.seed(123)

A <- sqrt(
  inla.pc.rprec(10000000, 1, 0.5)
)^(-1) 

B <- sqrt(
  inla.pc.rprec(10000000, 10, 0.01)
)^(-1)



ggplot() +
  geom_density(data = tibble(x = A), aes(x, color = "B")) +
  geom_density(data = tibble(x = B), aes(x, color = "A")) +
  labs(y = "Prior density",
       x = "Standard deviation",
       color = element_blank()) +
  scale_color_manual(values = c("blue", "red"), label = c("PC(10,0.01)", "PC(1,0.5)"))+
  theme_minimal()+
 theme(legend.direction = "horizontal", legend.position = "bottom")


```


\subsection{Details about the sensitivity analyses}

Two sensitivity analyses were explored:
\begin{enumerate}
\item Reporting of the non-selected competing models;
\item Change in the prior for the correlation parameters: variance of 1.25 and 2.5, instead of 5. These changes are illustrated in the Supplementary Figures \ref{priorrho}.
\end{enumerate}

```{r}
#| fig.cap = "Precision for the prior distribution of the latent correlation parameters. \\label{priorrho}",
#| fig.width=8,
#| fig.height=3

fx <- function(x, n) {
  (exp(x) - 1) / (exp(x) + n - 1)
 }
ggplot() +
  geom_density(data = tibble(x = fx(rnorm(
    100000, 0, prec_to_var(0.2)$std
  ), 2)), aes(x,colour = "A")) +
  geom_density(data = tibble(x = fx(rnorm(
    100000, 0, prec_to_var(0.4)$std
  ), 2)), aes(x,colour = "B")) +
  geom_density(data = tibble(x = fx(rnorm(
    100000, 0, prec_to_var(0.8)$std
  ), 2)), aes(x,colour = "N")) +
  scale_color_manual(values = c("red", "blue", 'orange'), labels = c("0.2 (baseline)", "0.4", 0.8))+
  labs(x = expression(paste(eta)),y = "Prior density", color = "Precision") + theme_minimal()
```





```{r matrixstructure}
#| fig.cap = "Spatial neighbourhood matrices considered for BYM2 priors. Black squares indicate that the two areas are neighbours.",
#| fig.width=12,
#| fig.height=12

library("grid")
library("ggplotify")


ggarrange(
as.ggplot(Matrix::image(as(nb2mat(delaunay, style = 'B', zero.policy = TRUE), 'Matrix'), xlab = " ", ylab = " ", sub = " ",raster = T)),
as.ggplot(Matrix::image(as(nb2mat(soi, style = 'B', zero.policy = TRUE), 'Matrix'), xlab = " ", ylab = " ", sub = " ",raster = T)
),
as.ggplot(Matrix::image(as(nb2mat(queenfirstorder, style = 'B', zero.policy = TRUE), 'Matrix'), xlab = " ", ylab = " ", sub = " ",raster = T)
),
as.ggplot(Matrix::image(as(nb2mat(queensecondorder, style = 'B', zero.policy = TRUE), 'Matrix'), xlab = " ", ylab = " ", sub = " ",raster = T)
), ncol = 2, labels = c("Delaunay", "SOI", "1st-order Queen", "2nd-order Queen")
)

```


\newpage
\subsection{Details about the Marginal Difference in Expected Prevalence (MDEP) \label{mdep}}

To compute the MDEP, we considered each unique 4-tuple $(a_s,z_s,t_s,g_s)$ and computed the corresponding number of observed tests (i.e., we summed the number of tests across the two screening pathways). 

For each of these 4-tuples we then made 1,550 draws from the joint posterior distribution to obtain the expected proportion of positive tests. We did so considering, first, the model specific to the organised screening pathway and, second, the model specific to the opportunistic screening pathway. We then computed the expected number of positive tests under each screening pathway. We finally took the difference between the expected number of positive tests under opportunistic and organised screening and then divided this difference by the total number of tests, yielding the Marginal Difference in Expected Prevalence.

In mathematical form:
\begin{itemize}
\item Step 1. Compute the observed number of tests, integrating out the screening pathway: $N_{a_s,z_s,t_s,g_s}=N_{a_s,z_s,t_s,g_s,1}+N_{a_s,z_s,t_s,g_s,2}$
\item Step 2. Draws from the full joint posterior distribution $\hat{p}_{a_s,z_s,t_s,g_s,1}$ and $\hat{p}_{a_s,z_s,t_s,g_s,2}$;
\item Step 3. For each draw, compute the expected number of positive test under each screening pathway: $\hat{p}_{a_s,z_s,t_s,g_s,1}\times N_{a_s,z_s,t_s,g_s}$ and $\hat{p}_{a_s,z_s,t_s,g_s,2}\times N_{a_s,z_s,t_s,g_s}$
\item Step 4A. For each draw, compute the marginal prevalence integrating out various dimension. To do so, sum  over all focal dimension the expected number of positive tests. Then, divide this sum by the observed number of tests. For example, for a given screening pathway $c_s$, integrating out all dimensions but the genotype one: $\frac{\sum_{a_s,z_s,t_s}\hat{p}_{a_s,z_s,t_s,g_s,c_s}\times N_{a_s,z_s,t_s,g_s}}{\sum_{a_s,z_s,t_s}N_{a_s,z_s,t_s,g_s}}$
\item Step 4B. For each draw, compute the difference between the marginal expected prevalence under opportunistic and organised screening.
\end{itemize}

\newpage 


\section{Descriptive reporting for the analytic sample  \label{descanalytic}}



```{r mapobserved}
#| fig.cap = "Postcodes with at least one test result observed in the analytic sample.",
#| fig.width=12,
#| fig.height=12


tmp <- data_cp_final %>% 
 mutate(obs = ifelse(code_postal %in% data_cp_obs$code_postal, 'A', 'B'))

tmp$geometry <- ms_simplify(tmp$geometry,
              keep = 0.025,
              keep_shapes = T)

ggplot() + 
 gg(tmp, aes(fill = obs), alpha = 0.3) + 
 scale_fill_manual(values = c("red", "blue"),
           labels = c("Postcodes with at least one test result", "Postcodes without any test result")) +
 theme_map(font_size = 18) +
 labs(fill = element_blank())+
 theme(legend.direction = "horizontal", legend.position = "bottom")

```



```{r}
#| fig.cap = "Postcodes stratified by the number of HR HPV tests in the analytic sample.",
#| fig.width=12,
#| fig.height=12



tmp <- data_bru %>%
    st_drop_geometry() %>% 
    filter(age >= 30 & age < 67) %>%  
    ungroup() %>% 
    group_by(code_postal) %>% 
    summarise(N = sum(N))

tmp <- data_cp_final %>% 
  left_join(tmp, by = "code_postal") %>% 
  select(geometry, N,code_postal) %>% 
  mutate(N = ifelse(is.na(N), 0, N)) 
  
options(scipen = 100, digits = 4)
tmp <- tmp %>% 
 mutate(obs = cut(N, breaks = c(0, 100, 500, 1000,  2000, 3000, 4000, 5000), include.lowest = F, dig.lab = 5)) %>% 
  mutate(obs = case_when(
    N == 0 ~ '0', 
    obs == "(0,1]" ~ '1',
    TRUE ~ obs
    ))

tmp$geometry <- ms_simplify(tmp$geometry,
              keep = 0.025,
              keep_shapes = T)

ggplot() + 
 gg(tmp, aes(fill = obs)) + 
 theme_map(font_size = 18) +
 labs(fill = "Number of tests:")+
 theme(legend.direction = "horizontal", legend.position = "bottom") +
  scale_fill_brewer(palette = "Accent")
```



```{r}
#| fig.cap = "Postcodes stratified by the number of HR HPV tests in the analytic sample, zoom on Paris region.",
#| fig.width=12,
#| fig.height=12



tmp <- data_bru %>%
    st_drop_geometry() %>% 
    filter(age >= 30 & age < 67) %>%  
    ungroup() %>% 
    group_by(code_postal, insee_reg) %>% 
    summarise(N = sum(N)) %>% 
  filter(insee_reg == "11")

tmp <- data_cp_final %>% 
  filter(insee_reg == "11") %>% 
  left_join(tmp, by = "code_postal") %>% 
  select(geometry, N,code_postal) %>% 
  mutate(N = ifelse(is.na(N), 0, N))
  
options(scipen = 100, digits = 4)
tmp <- tmp %>% 
 mutate(obs = cut(N, breaks = c(0, 100, 500, 1000,  2000, 3000, 4000, 5000), include.lowest = F, dig.lab = 5)) %>% 
  mutate(obs = case_when(
    N == 0 ~ '0', 
    obs == "(0,1]" ~ '1',
    TRUE ~ obs
    ))

tmp$geometry <- ms_simplify(tmp$geometry,
              keep = 0.025,
              keep_shapes = T)

ggplot() + 
 gg(tmp, aes(fill = obs)) + 
 theme_map(font_size = 18) +
 labs(fill = "Number of tests:")+
 theme(legend.direction = "horizontal", legend.position = "bottom") +
  scale_fill_brewer(palette = "Accent")
```

```{r}
#| fig.cap = "Postcodes only observed through opportunistic screening, organised screening, both opportunistic and organised screening, and not observed in the analytic sample.",
#| fig.width=12,
#| fig.height=12



screening <- data_bru %>%
    st_drop_geometry() %>% 
    filter(age >= 30 & age < 67) %>%  
    ungroup() %>% 
    group_by(code_postal, type, insee_reg) %>% 
    summarise(N = sum(N)) 

tmp <- data_cp_final  %>% 
  left_join(screening, by = "code_postal") %>% 
  mutate(N = ifelse(is.na(N), 0, N)) 

ind <- tmp %>% filter(type == "ind") %>% distinct(code_postal) %>% .$code_postal
orga <- tmp %>% filter(type == "orga")%>% distinct(code_postal) %>% .$code_postal

  
options(scipen = 100, digits = 4)
tmp <- data_cp_final %>% 
 mutate(obs = case_when(
   code_postal %in% ind & !code_postal %in% orga ~ "Opportunistic only",
   !code_postal %in% ind & code_postal %in% orga  ~ "Organised only",
   code_postal %in% ind & code_postal %in% orga ~ "Opportunistic and Organised",
   TRUE ~ "Not observed"
 ), obs = factor(obs)) %>% 
  filter(code_postal %in% tmp$code_postal)

tmp$geometry <- ms_simplify(tmp$geometry,
              keep = 0.025,
              keep_shapes = T)

ggplot() + 
 gg(tmp, aes(fill = obs)) + 
 theme_map(font_size = 18) +
 labs(fill = "Type of screening: ")+
 theme(legend.direction = "horizontal", legend.position = "bottom") +
  scale_fill_brewer(palette = "Accent")
```

```{r}
#| fig.cap = "Postcodes only observed through opportunistic screening, organised screening, both opportunistic and organised screening, and not observed in the analytic sample, zoom on Paris region.",
#| fig.width=12,
#| fig.height=12



screening <- data_bru %>%
    st_drop_geometry() %>% 
    filter(age >= 30 & age < 67) %>%  
    ungroup() %>% 
    group_by(code_postal, type, insee_reg) %>% 
    summarise(N = sum(N)) %>% 
    filter(insee_reg == "11")

tmp <- data_cp_final  %>% 
    filter(insee_reg == "11") %>%
  left_join(screening, by = "code_postal") %>% 
  mutate(N = ifelse(is.na(N), 0, N)) 

ind <- tmp %>% filter(type == "ind") %>% distinct(code_postal) %>% .$code_postal
orga <- tmp %>% filter(type == "orga")%>% distinct(code_postal) %>% .$code_postal

  
options(scipen = 100, digits = 4)
tmp <- data_cp_final %>% 
 mutate(obs = case_when(
   code_postal %in% ind & !code_postal %in% orga ~ "Opportunistic only",
   !code_postal %in% ind & code_postal %in% orga  ~ "Organised only",
   code_postal %in% ind & code_postal %in% orga ~ "Opportunistic and Organised",
   TRUE ~ "Not observed"
 ), obs = factor(obs)) %>% 
  filter(code_postal %in% tmp$code_postal)

tmp$geometry <- ms_simplify(tmp$geometry,
              keep = 0.025,
              keep_shapes = T)

ggplot() + 
 gg(tmp, aes(fill = obs)) + 
 theme_map(font_size = 18) +
 labs(fill = "Type of screening: ")+
 theme(legend.direction = "horizontal", legend.position = "bottom") +
  scale_fill_brewer(palette = "Accent")
```

```{r}
#| fig.cap = "Empirical cumulative distribution function of the number of tests within postcodes in the analytic sample.",
#| fig.width=7,
#| fig.height=7
data_bru%>%
  st_drop_geometry() %>% 
  filter(age >= 30 & age < 67) %>% 
  group_by(code_postal) %>% 
  summarise(N = sum(N)) %>% 
  ggplot() + 
  stat_ecdf(aes(x = N),geom = "step") + scale_color_manual(values = c("darkgreen", "darkorange"))+
  labs(x = "Number of tests",color = "Virus", y = "Empirical Cumulative Density Function") + 
  theme_minimal(base_size = 10) +
  theme(legend.direction = "horizontal", legend.position = "bottom") +
  scale_x_continuous(n.breaks = 10)

```
\section{Performance of the selected model \label{rawsummary}}


\subsection{Model selection and raw reporting of the selected model}



```{r}
res %>% 
  select(n,
      space,
      type,
      ls) %>% 
  mutate(
    type = case_when(
     type == 'stationary' ~ "Stationary",
     type == 'barrier' ~ "Non-stationary (Barrier model)",
    type == "delaunay" ~ "Delaunay",
    type == "soi" ~ "SOI",
    type == "queenfirstorder" ~ "1st-order Queen",
    type == "queensecondorder" ~ "2nd-order Queen"
    ),
    space = ifelse(space == "grf", "Matérn", "BYM2")
  ) %>% 
  arrange(ls) %>% 
  rename('Model' = n,
      'Log-score' = ls,
      'Type' = space,
      "Structure" = type) %>% 
  knitr::kable(
    format = "latex",
    label = "tablesummary",
    caption = "Logarithmic-score based on LGO-CV. The model with the minimum score was selected.",
    align = "c",
    escape = F,
    booktabs = T,
    linesep = "",
    longtable = F
  ) %>% 
  kable_styling(
    # font_size = 6,
    latex_options = c(
      "scale_down",
      "repeat_header",
      "HOLD_position"
    ),
    position = "center"
  ) 
```



```{r include=FALSE}
table_param <- results$summary.fixed %>% 
  rownames_to_column() %>% 
  mutate(type = "Latent parameters") %>% 
    plyr::rbind.fill(rbind(results$summary.random$intercepthpvother %>% 
                             mutate(rowname = "intercepthpvother"),
      results$summary.random$interceptopportunistic%>% 
                             mutate(rowname = "interceptopportunistic"),
      results$summary.random$intercepthpvotheropportunistic%>% 
                             mutate(rowname = "intercepthpvotheropportunistic"))  %>% 
  mutate(type = "Latent parameters") %>% 
    select(-ID)) %>% 
  plyr::rbind.fill(results$summary.hyperpar%>% 
             mutate(type = "Hyperparameters")%>% 
             rownames_to_column()) %>% 
  mutate(rowname = case_when(
    rowname == "interceptglobal" ~ "$\\psi_0$",
    str_detect(rowname,"intercepthpvother") & ! str_detect(rowname,"intercepthpvotheropportunistic")~ str_replace(rowname,"intercepthpvother", "$\\\\psi_1$"),
    str_detect(rowname,"interceptopportunistic") ~ str_replace(rowname,"interceptopportunistic", "$\\\\psi_2$"),
    str_detect(rowname,"intercepthpvotheropportunistic") ~ str_replace(rowname,"intercepthpvotheropportunistic", "$\\\\psi_3$"),
    str_detect(rowname, 'fspace') & !str_detect(rowname, 'opportunistic') ~ str_replace(rowname, 'fspace', '$\\\\alpha_{SPACE}(z_{s},g_{s})$'),
    
    str_detect(rowname, 'fspace') & str_detect(rowname, 'opportunistic') ~ str_replace(rowname, 'fspace', "$\\\\alpha'_{SPACE}(z_{s},g_{s})$"),
    
        str_detect(rowname, 'fage') & !str_detect(rowname, 'opportunistic') ~ str_replace(rowname, 'fage', '$\\\\gamma_{AGE}(age_{s},g_{s})$'),
    
    str_detect(rowname, 'fage') & str_detect(rowname, 'opportunistic') ~ str_replace(rowname, 'fage', "$\\\\gamma'_{AGE}(age_{s},g_{s})$"),
    
            str_detect(rowname, 'ftime') & !str_detect(rowname, 'opportunistic') ~ str_replace(rowname, 'ftime', "$\\\\beta_{TIME}(t_s,g_s)$"),
    str_detect(rowname, 'ftime') & str_detect(rowname, 'opportunistic') ~ str_replace(rowname, 'ftime', "$\\\\beta'_{TIME}(t_s,g_s)$"),
    TRUE ~ rowname
  )) %>% 
 dplyr::select(type,rowname, mean, sd, contains("quant"), "mode") %>% 
 mutate(rowname = str_replace(rowname,"Stdev", "SD"),
     rowname = str_remove(rowname,"opportunistic"),
     rowname = str_replace_all(rowname, "GroupRho", "$\\\\eta$"),
     rowname = str_replace_all(rowname, "Precision", "$\\\\sigma^{-2}$"),
     rowname = str_replace_all(rowname, "Range", "$\\\\rho$"),
     rowname = str_replace_all(rowname, "Theta1", "$\\\\sigma$"),
     rowname = str_replace_all(rowname, "Theta2", "$\\\\rho^{-2}$"),
     rowname = str_replace_all(rowname, "Phi", "$\\\\phi$"))


library(INLA)
tx_tmp <- function(input,marg,r){
 tmp <- as_tibble(inla.zmarginal(inla.tmarginal(function(x)exp(x), marg)))
input[r,]$mean <- tmp$mean
input[r,]$sd <- tmp$sd
input[r,]$`0.025quant` <- tmp$quant0.025
input[r,]$`0.5quant` <- tmp$quant0.5
input[r,]$`0.975quant` <- tmp$quant0.975
input[r,]$`mode` <- inla.mmarginal(inla.tmarginal(function(x)exp(x), marg))
return(input)
}

if(!str_detect(opt$space, "bym2")){
table_param <- tx_tmp(input = table_param,results$correlation$`Theta1 for fspace`,5)
table_param <- tx_tmp(input = table_param,results$correlation$`Theta2 for fspace`,6)
table_param <- tx_tmp(input = table_param,results$correlation$`Theta1 for fspaceopportunistic`,14)
table_param <- tx_tmp(input = table_param,results$correlation$`Theta2 for fspaceopportunistic`,15)
}

table_param <- table_param %>% 
  mutate_if(is.numeric, ~formating_text(., 2))


```

```{r}
table_param %>% 
 filter(type != "Hyperparameters") %>% 
 dplyr::select(-type) %>% 
  knitr::kable(
    col.names = c(
      "Parameters",
      "Average",
      "SD",
      "0.025",
      "0.5",
      "0.975",
      "Mode"
      ),
    format = "latex",
    label = "tablesummary",
    caption = "Raw summary provided by R-INLA of the posterior distribution for the latent parameters.",
    align = "c",
    escape = F,
    booktabs = T,
    linesep = "",
    longtable = F
  ) %>% 
  kable_styling(
    # font_size = 6,
    latex_options = c(
      "scale_down",
      "repeat_header",
      "HOLD_position"
    ),
    position = "center"
  ) %>% 
  add_header_above(c(
    " " = 3,
    "Quantile" = 3,
    " " = 1
  )) %>%
  add_header_above(c(
    " " = 1,
    "Description of the posterior distribution" = 6
  )) 

```


```{r}
table_param %>% 
 filter(type == "Hyperparameters") %>% 
 dplyr::select(-type) %>% 
  knitr::kable(
    col.names = c(
      "Parameters",
      "Average",
      "SD",
      "0.025",
      "0.5",
      "0.975",
      "Mode"
      ),
    format = "latex",
    label = "tablesummary",
    caption = "Raw summary provided by R-INLA of the posterior distribution for the hyperparameters.",
    align = "c",
    escape = F,
    booktabs = T,
    linesep = "",
    longtable = F
  ) %>% 
  kable_styling(
    # font_size = 6,
    latex_options = c(
      "scale_down",
      "repeat_header",
      "HOLD_position"
    ),
    position = "center"
  ) %>% 
  add_header_above(c(
    " " = 3,
    "Quantile" = 3,
    " " = 1
  )) %>%
  add_header_above(c(
    " " = 1,
    "Description of the posterior distribution" = 6
  )) 
```




\blscape


```{r}
#| fig.cap = "Posterior and prior distribution for the correlations between the two groups of genotypes for components specific to organised screening.",
#| fig.width=8,
#| fig.height=6


fx <- function(x, n = 2) {
  (exp(x) - 1) / (exp(x) + n - 1)
}
tmp <- rnorm(10000, 0, prec_to_var(0.2)$std)



results$correlation$`GroupRho for fspace` %>% 
  as_tibble() %>% 
  mutate(type = "A") %>% 
  rbind(
    results$correlation$`GroupRho for ftime` %>% 
      as_tibble() %>% 
      mutate(type = "B")
  ) %>% 
  rbind(
    results$correlation$`GroupRho for fage` %>% 
      as_tibble() %>% 
      mutate(type = "C")
  ) %>% 
  ggplot() +
  geom_line(aes(x = x, y = y, color = type), size = 1, key_glyph = "abline")+
  coord_cartesian(xlim = c(-1,1))+
  geom_density(data = data.frame(x = tmp) %>%
           mutate(y = fx(x, 2)), aes(x = y, color = 'D'), size = 1, key_glyph = "abline")+
  scale_color_manual(values = c("darkred", "darkblue", "darkgreen", "orange"),
            labels = c(expression(eta["SPACE"]),
                 expression(eta["TIME"]),
                 expression(eta["AGE"]),
                 expression(eta["Prior"])))+
  labs(x = element_blank(),
     y = "Distribution",
     color = element_blank()) +
  theme_minimal(base_size = 12)+
  theme(legend.direction = "horizontal", legend.position = "bottom")
```




```{r}
#| fig.cap = "Posterior and prior distribution for the correlations between the two groups of genotypes for components specific to opportunistic screening.",
#| fig.width=8,
#| fig.height=6


fx <- function(x, n = 2) {
  (exp(x) - 1) / (exp(x) + n - 1)
}
tmp <- rnorm(10000, 0, prec_to_var(0.2)$std)



results$correlation$`GroupRho for fspaceopportunistic` %>% 
  as_tibble() %>% 
  mutate(type = "A") %>% 
  rbind(
    results$correlation$`GroupRho for ftimeopportunistic` %>% 
      as_tibble() %>% 
      mutate(type = "B")
  ) %>% 
  rbind(
    results$correlation$`GroupRho for fageopportunistic` %>% 
      as_tibble() %>% 
      mutate(type = "C")
  ) %>% 
  ggplot() +
  geom_line(aes(x = x, y = y, color = type), size = 1, key_glyph = "abline")+
  coord_cartesian(xlim = c(-1,1))+
  geom_density(data = data.frame(x = tmp) %>%
           mutate(y = fx(x, 2)), aes(x = y, color = 'D'), size = 1, key_glyph = "abline")+
  scale_color_manual(values = c("darkred", "darkblue", "darkgreen", "orange"),
            labels = c(expression(eta["SPACE"]),
                 expression(eta["TIME"]),
                 expression(eta["AGE"]),
                 expression(eta["Prior"])))+
  labs(x = element_blank(),
     y = "Distribution",
     color = element_blank()) +
  theme_minimal(base_size = 12)+
  theme(legend.direction = "horizontal", legend.position = "bottom")
```

\subsection{Posterior predictive check from the selected model}


```{r}
x <- pp_baseline %>%
 do.call(plyr::rbind.fill,.) %>% 
  select(
    region_name,
    genotypes,
    type,
    year,
    age_class,
    N,
    obs,
    mean,
    median,
    qi_lb,
    qi_ub
  ) 


y <- expected_baseline %>%
 do.call(plyr::rbind.fill,.) %>% 
  select(
    region_name,
    genotypes,
    type,
    year,
    age_class,
    N,
    obs,
    "expmean" = mean,
    "expmedian" =median,
    "expqilb" =qi_lb,
    "expqiub" =qi_ub
  ) 

z <- left_join(x,y,
               by = c("region_name",
                      "genotypes",
    "type",
    "year",
    "age_class",
    "N",
    "obs"))

z %>% 
  mutate(type = ifelse(type == "orga", "Organised", "Opportunistic"),
      year = as.character(year),
      age_class = as.character(age_class),
      N = formating_text(N,0)) %>% 
  mutate_if(is.numeric,
       ~formating_text(100*.,2)) %>% 
  mutate_all(~ifelse(is.na(.)|str_detect(., "NA"), " ", .)) %>% 
 filter(genotypes != " ") %>% 
  knitr::kable(
    col.names = c(
      "Region",
      "Genotypes",
      "Type of screening",
      "Year",
      "Age",
      "Number of tests",
      "Observed",
      "Average",
      "Median",
      "LB",
      "UB",
      "Average",
      "Median",
      "LB",
      "UB"
    ),
    format = "latex",
    label = "tabledescyearsex",
    caption = "Observed HR HPV cervical infection prevalence, posterior predictive HR HPV cervical infection prevalence, and posterior expected HR HPV cervical infection prevalence, stratified by various dimensions.",
    align = "c",
    escape = F,
    booktabs = T,
    linesep = "",
    longtable = T
  ) %>%
  add_header_above(c(
    " " = 9,
    "ETI95%" = 2,
    " " = 2,
    "ETI95%" = 2
  )) %>% 
    add_header_above(c(
    " " = 7,
    "Predictive prevalence" = 4,
    "Expected prevalence" = 4
  ))%>%
  add_header_above(c(
    " " = 7,
    "Posterior distribution" = 8
  ))%>% 
  kable_styling(
    font_size = 7,
    latex_options = c(
      "repeat_header",
      "HOLD_position"
    ),
    position = "center"
  ) 

```


\elscape

\section{Systematic difference in expected HR HPV cervical infection prevalence between opportunistic and organised screening, among females aged 30, at the end of November 2023\label{mapwithci1}}



\blscape



```{r}
#| fig.cap = "Posterior difference between the expected HR HPV cervical infection prevalence from opportunistic and organised screening, among females aged 30, at the end of November 2023.",
#| fig.width=29.7,
#| fig.height=22.5


france30_differencetesthpv1618 <- function_for_spatial_plot(results$map[[30]]$difference_test,
             v = "HPV16/18",
             t = "Organised",
             c("mean", "qi_lb", "qi_ub"),
             lab = str_remove(label_difference_test, " \\n"),
             funlabel = function(x){paste0(100*x, "pp")}) 

france30_differencetesthpvother <- function_for_spatial_plot(results$map[[30]]$difference_test,
             v = "Other genotypes",
             t = "Organised",
             c("mean", "qi_lb", "qi_ub"),
             lab = str_remove(label_difference_test, " \\n"),
             funlabel = function(x){paste0(100*x, "pp")}) 

 ggpubr::ggarrange(
  france30_differencetesthpv1618 +
  gg(fr_mask,color = "black", alpha = 0.0000001) +
  labs(fill = "Difference (in percentage points) in expected HR HPV cervical infection \n prevalence, between opportunistic and organised screening, among females aged 30, at the end of November 2023, for HPV16/18: ",
    color = "Difference (in percentage points) in expected HR HPV cervical infection \n prevalence, between opportunistic and organised screening, among females aged 30, at the end of November 2023, for HPV16/18: "),
  france30_differencetesthpvother +
  gg(fr_mask,color = "black", alpha = 0.0000001) +
  labs(fill = "Difference (in percentage points) in expected HR HPV cervical infection \n prevalence, between opportunistic and organised screening, among females aged 30, at the end of November 2023, for other genotypes: ",
    color = "Difference (in percentage points) in expected HR HPV cervical infection \n prevalence, between opportunistic and organised screening, among females aged 30, at the end of November 2023, for other genotypes: "),
  nrow = 2)
```


```{r diffParis}
#| fig.cap = "Posterior difference between the expected HR HPV  using opportunistic and organised data, among females aged 30, at the end of November 2023, in Paris region.",
#| fig.width=29.7,
#| fig.height=22.5


paris30_differencetesthpv1618 <- function_for_spatial_plot(results$map[[30]]$difference_test,
             v = "HPV16/18",
             t = "Organised",
             c("mean", "qi_lb", "qi_ub"),
             lab = str_remove(label_difference_test, " \\n"),
             restriction_idf = T,
             funlabel = function(x){paste0(100*x, "pp")}) +
  gg(carto_district %>% filter(insee_reg == "11"), alpha = 0.0000001, color = "black")

paris30_differencetesthpvother <- function_for_spatial_plot(results$map[[30]]$difference_test,
             v = "Other genotypes",
             t = "Organised",
             c("mean", "qi_lb", "qi_ub"),
             lab = str_remove(label_difference_test, " \\n"),
             restriction_idf = T,
             funlabel = function(x){paste0(100*x, "pp")}) +
  gg(carto_district %>% filter(insee_reg == "11"), alpha = 0.0000001, color = "black")

 ggpubr::ggarrange(
  paris30_differencetesthpv1618 +
  labs(fill = "Systematic inflation (in percentage points) from opportunistic screening among females aged 30, at the end of November 2023, for HPV16/18: ",
    color = "Systematic inflation (in percentage points) from opportunistic screening among females aged 30, at the end of November 2023, for HPV16/18: "),
  paris30_differencetesthpvother +
  labs(fill = "Systematic inflation (in percentage points) from opportunistic screening among females aged 30, at the end of November 2023, for other genotypes: ",
    color = "Systematic inflation (in percentage points) from opportunistic screening among females aged 30, at the end of November 2023, for other genotypes: "),
  nrow = 2)
```


```{r probabilitysystematicincrease}
#| fig.cap = "Posterior probability of a positive difference in expected HR HPV  between opportunistic and organised screening, stratified by genotype group, among females aged 30, at the end of November 2023.",
#| fig.width=29.7,
#| fig.height=22.5

proba_france30_differencetesthpv1618 +
 scale_fill_brewer(palette = "Spectral", direction = -1, drop=TRUE) +
 scale_color_brewer(palette = "Spectral", direction = -1, drop=TRUE) +
 labs(fill = "Posterior probability of a positive difference in expected HR HPV cervical infection \n prevalence, between opportunistic and organised screening, stratified by genotype group, among females aged 30, at the end of November 2023: ",
    color = "Posterior probability of a positive difference in expected HR HPV cervical infection \n prevalence, between opportunistic and organised screening, stratified by genotype group, among females aged 30, at the end of November 2023: ")



```




```{r mapparisbias}
#| fig.cap = "Posterior systematic inflation in HR HPV cervical infection prevalence under opportunistic screening, compared with organised screening, in each of Paris arrondissement, among females aged 30, at the end of November 2023.",
#| fig.width=29.7,
#| fig.height=22.5


p1 <- function_for_spatial_plot(results$map[[30]]$difference_test%>% filter("75" == str_sub(code_postal, 1, 2))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
             v = "HPV16/18",
             t = "Organised",
             c("mean", "qi_lb", "qi_ub"),
             lab = str_remove(label_difference_test, " \\n"),
             funlabel = function(x){paste0(100*x, "pp")})+
 gg(results$map[[30]]$virusspecific%>% filter("75" == str_sub(code_postal, 1, 2))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
   color = "black", alpha = 0.0001)


p2 <- function_for_spatial_plot(results$map[[30]]$difference_test%>% filter("75" == str_sub(code_postal, 1, 2))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
             v = "Other genotypes",
             t = "Organised",
             c("mean", "qi_lb", "qi_ub"),
             lab = str_remove(label_difference_test, " \\n"),
             funlabel = function(x){paste0(100*x, "pp")})+
 gg(results$map[[30]]$virusspecific%>% filter("75" == str_sub(code_postal, 1, 2))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
   color = "black", alpha = 0.0001)


 ggpubr::ggarrange(
  p1,
  p2,
  nrow = 2)
```




```{r maplyonbias}
#| fig.cap = "Posterior systematic inflation in HR HPV cervical infection prevalence under opportunistic screening, compared with organised screening, in each of Lyon arrondissement, among females aged 30, at the end of November 2023.",
#| fig.width=29.7,
#| fig.height=22.5


p1 <- function_for_spatial_plot(results$map[[30]]$difference_test%>% filter("690" == str_sub(code_postal, 1, 3))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
             v = "HPV16/18",
             t = "Organised",
             c("mean", "qi_lb", "qi_ub"),
             lab = str_remove(label_difference_test, " \\n"),
             funlabel = function(x){paste0(100*x, "pp")})+
 gg(results$map[[30]]$virusspecific%>% filter("690" == str_sub(code_postal, 1, 3))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
   color = "black", alpha = 0.0001)


p2 <- function_for_spatial_plot(results$map[[30]]$difference_test%>% filter("690" == str_sub(code_postal, 1, 3))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
             v = "Other genotypes",
             t = "Organised",
             c("mean", "qi_lb", "qi_ub"),
             lab = str_remove(label_difference_test, " \\n"),
             funlabel = function(x){paste0(100*x, "pp")})+
 gg(results$map[[30]]$virusspecific%>% filter("690" == str_sub(code_postal, 1, 3))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
   color = "black", alpha = 0.0001)


 ggpubr::ggarrange(
  p1,
  p2,
  nrow = 2)
```



```{r mapmarseillebias}
#| fig.cap = "Posterior systematic inflation in HR HPV cervical infection prevalence under opportunistic screening, compared with organised screening, in each of Marseille arrondissement, among females aged 30, at the end of November 2023.",
#| fig.width=29.7,
#| fig.height=22.5


p1 <- function_for_spatial_plot(results$map[[30]]$difference_test%>% filter(code_postal %in% c(paste0('1300', seq(1, 9)), paste0('130', seq(10, 16))))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
             v = "HPV16/18",
             t = "Organised",
             c("mean", "qi_lb", "qi_ub"),
             lab = str_remove(label_difference_test, " \\n"),
             funlabel = function(x){paste0(100*x, "pp")})+
 gg(results$map[[30]]$virusspecific%>% filter(code_postal %in% c(paste0('1300', seq(1, 9)), paste0('130', seq(10, 16))))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
   color = "black", alpha = 0.0001)


p2 <- function_for_spatial_plot(results$map[[30]]$difference_test%>% filter(code_postal %in% c(paste0('1300', seq(1, 9)), paste0('130', seq(10, 16))))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
             v = "Other genotypes",
             t = "Organised",
             c("mean", "qi_lb", "qi_ub"),
             lab = str_remove(label_difference_test, " \\n"),
             funlabel = function(x){paste0(100*x, "pp")})+
 gg(results$map[[30]]$virusspecific%>% filter(code_postal %in% c(paste0('1300', seq(1, 9)), paste0('130', seq(10, 16))))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
   color = "black", alpha = 0.0001)


 ggpubr::ggarrange(
  p1,
  p2,
  nrow = 2)
```

\section{Expected HR HPV cervical infection prevalence, among females aged 30, at the end of November 2023, under organised screening\label{mapwithci2}}

```{r}
#| fig.cap = "Posterior HR HPV cervical infection prevalence in metropolitan France, among females aged 30, at the end of November 2023, correcting for the systematic inflation associated with opportunistic screening, stratified by genotype group.",
#| fig.width=29.7,
#| fig.height=20

france30_hpv1618 <- function_for_spatial_plot(results$map[[30]]$virusspecific,
             v = "HPV16/18",
             t = "Organised",
             c("mean", "qi_lb", "qi_ub"))

france30_hpvother <- function_for_spatial_plot(results$map[[30]]$virusspecific,
             v = "Other genotypes",
             t = "Organised",
             c("mean", "qi_lb", "qi_ub"))
 ggpubr::ggarrange(
  france30_hpv1618 +
  gg(fr_mask,color = "black", alpha = 0.0000001),
  france30_hpvother +
  gg(fr_mask,color = "black", alpha = 0.0000001),
  nrow = 2)
```

```{r}
#| fig.cap = "Posterior HR HPV cervical infection prevalence in Paris region, among females aged 30, at the end of November 2023, correcting for the systematic inflation associated with opportunistic screening, stratified by genotype group.",
#| fig.width=29.7,
#| fig.height=22.5


france30_hpv1618 <- function_for_spatial_plot(results$map[[30]]$virusspecific,
             v = "HPV16/18",
             t = "Organised",
             c("mean", "qi_lb", "qi_ub"),
             restriction_idf = T)+
  gg(carto_district %>% filter(insee_reg == "11"), alpha = 0.0000001, color = "black")

france30_hpvother <- function_for_spatial_plot(results$map[[30]]$virusspecific,
             v = "Other genotypes",
             t = "Organised",
             c("mean", "qi_lb", "qi_ub"),
             restriction_idf = T)+
  gg(carto_district %>% filter(insee_reg == "11"), alpha = 0.0000001, color = "black")
 ggpubr::ggarrange(
  france30_hpv1618,
  france30_hpvother,
  nrow = 2)
```



```{r mapparis}
#| fig.cap = "Posterior HR HPV cervical infection prevalence in each of the Paris arrondissement, among females aged 30, at the end of November 2023, correcting for the systematic inflation associated with opportunistic screening, stratified by genotype group.",
#| fig.width=29.7,
#| fig.height=22.5


mapparishpv1618 <- function_for_spatial_plot(results$map[[30]]$virusspecific%>% filter("75" == str_sub(code_postal, 1, 2))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
             v = "HPV16/18",
             t = "Organised",
             c("mean", "qi_lb", "qi_ub"),
             restriction_idf = T)+
 gg(results$map[[30]]$virusspecific%>% filter("75" == str_sub(code_postal, 1, 2))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
   color = "black", alpha = 0.0001)


mapparishpvother <- function_for_spatial_plot(results$map[[30]]$virusspecific%>% filter("75" == str_sub(code_postal, 1, 2))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
             v = "Other genotypes",
             t = "Organised",
             c("mean", "qi_lb", "qi_ub"),
             restriction_idf = T) +
 gg(results$map[[30]]$virusspecific%>% filter("75" == str_sub(code_postal, 1, 2))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
   color = "black", alpha = 0.0001)


 ggpubr::ggarrange(
  mapparishpv1618,
  mapparishpvother,
  nrow = 2)
```


```{r maplyon}
#| fig.cap = "Posterior HR HPV cervical infection prevalence in each of the Lyon arrondissement, among females aged 30, at the end of November 2023, correcting for the systematic inflation associated with opportunistic screening, stratified by genotype group.",
#| fig.width=29.7,
#| fig.height=22.5


maplyonhpv1618 <- function_for_spatial_plot(results$map[[30]]$virusspecific%>% filter("690" == str_sub(code_postal, 1, 3))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
             v = "HPV16/18",
             t = "Organised",
             c("mean", "qi_lb", "qi_ub"),
             restriction_idf = F)+
 gg(results$map[[30]]$virusspecific%>% filter("690" == str_sub(code_postal, 1, 3))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
   color = "black", alpha = 0.0001)


maplyonhpvother <- function_for_spatial_plot(results$map[[30]]$virusspecific%>% filter("690" == str_sub(code_postal, 1, 3))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
             v = "Other genotypes",
             t = "Organised",
             c("mean", "qi_lb", "qi_ub"),
             restriction_idf = F)+
 gg(results$map[[30]]$virusspecific%>% filter("690" == str_sub(code_postal, 1, 3))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
   color = "black", alpha = 0.0001)


 ggpubr::ggarrange(
  maplyonhpv1618,
  maplyonhpvother,
  nrow = 2)
```


```{r mapmarseille}
#| fig.cap = "Posterior HR HPV cervical infection prevalence in each of the Marseille arrondissement, among females aged 30, at the end of November 2023, correcting for the systematic inflation associated with opportunistic screening, stratified by genotype group.",
#| fig.width=29.7,
#| fig.height=22.5


mapmarseillehpv1618 <- function_for_spatial_plot(results$map[[30]]$virusspecific%>% filter(code_postal %in% c(paste0('1300', seq(1, 9)), paste0('130', seq(10, 16))))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
             v = "HPV16/18",
             t = "Organised",
             c("mean", "qi_lb", "qi_ub"),
             restriction_idf = F)+
 gg(results$map[[30]]$virusspecific%>% filter(code_postal %in% c(paste0('1300', seq(1, 9)), paste0('130', seq(10, 16))))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
   color = "black", alpha = 0.0001)


mapmarseillehpvother <- function_for_spatial_plot(results$map[[30]]$virusspecific%>% filter(code_postal %in% c(paste0('1300', seq(1, 9)), paste0('130', seq(10, 16))))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
             v = "Other genotypes",
             t = "Organised",
             c("mean", "qi_lb", "qi_ub"),
             restriction_idf = F)+
 gg(results$map[[30]]$virusspecific%>% filter(code_postal %in% c(paste0('1300', seq(1, 9)), paste0('130', seq(10, 16))))%>% st_drop_geometry() %>% left_join(data_cp_final %>% select(code_postal, geometry), by = "code_postal") %>% st_as_sf,
   color = "black", alpha = 0.0001)


 ggpubr::ggarrange(
  mapmarseillehpv1618,
  mapmarseillehpvother,
  nrow = 2)
```

\newpage

\section{Maps of the posterior average expected infection prevalence stratified by age, at the end of November 2023, under organised screening \label{mapall}}

```{r}
function_selecting_map <- function(vector_age, v, legend, type_map = "virusspecific", metric = "mean", symbol="%"){
  
  if(type_map != "difference_virus"){
  tmp <- results$map[vector_age] %>% 
    imap(~.x[[type_map]]%>% filter( virusgroup == v))
  }else{
    tmp <- results$map[vector_age] %>% 
    imap(~.x[[type_map]]%>% filter(testgroup == v))
  }
  
  values <- tmp %>% imap(~tibble(
    min = min(.x[[metric]]),
    max = max(.x[[metric]]))
    ) %>% do.call(rbind, .) 
  
  max_v <- max(values$max)
  min_v <- min(values$min)
  tmp %>%
    imap(function(.x,.y){
      legend_choice <- ifelse(unique(.x$age) == 66, "bottom", "none")
      data_plot <- .x
      data_plot$metric <- data_plot[[metric]]
      
      ggplot() +
  gg(data_plot, aes(color = metric, 
      fill = metric)) + 
  theme_map(font_size = 23) +
  scale_color_viridis_c(option = "turbo",
             direction = 1,
             label = function(x){paste0(100*x, symbol)},
             limits = c(min_v,max_v),
             n.breaks = 6) +
  scale_fill_viridis_c(option = "turbo",
             direction = 1,
             label = function(x){paste0(100*x, symbol)},
             limits = c(min_v,max_v),
             n.breaks = 6) +
  labs(color = legend,
     fill = legend,
     subtitle = data_plot$age) +
  theme(
   plot.title = element_text(hjust = 0.5),
   legend.position = "bottom",
   legend.key.width = unit(3, "cm"),
   legend.key.height = unit(0.5, "cm"),
   legend.spacing = unit(0.25, "cm"),
   legend.title = element_text(hjust = 0.5),
   legend.justification = "center",
   legend.title.position = "top"
  ) +
  theme(plot.margin = margin(
   t = 0.0005,
   r = 0.0005,
   b = 0.0005,
   l = 0.0005,
   unit = "cm"
  ))+ theme(
  plot.title = element_text(hjust = 0.5, face = "bold"),
  plot.subtitle = element_text(hjust = 0.5, face = "bold"))+
    theme(legend.position=legend_choice)})
}

g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
  }

prevmap1618 <- function_selecting_map(vector_age = seq(30,66), v = 1, legend = "Posterior average expected infection prevalence for HPV16/18")
prevmap1618legend<-g_legend(prevmap1618[[length(prevmap1618)]])
prevmap1618[[length(prevmap1618)]] <- prevmap1618[[length(prevmap1618)]] +
    theme(legend.position= "none")
prevmap1618 <- ggpubr::ggarrange(plotlist=prevmap1618)



prevmapother <- function_selecting_map(vector_age = seq(30,66), v = 2, legend = "Posterior average expected infection prevalence for Other genotypes")
prevmapotherlegend<-g_legend(prevmapother[[length(prevmapother)]])
prevmapother[[length(prevmapother)]] <- prevmapother[[length(prevmapother)]] +
    theme(legend.position= "none")
prevmapother <- ggpubr::ggarrange(plotlist=prevmapother)


```



```{r mapfr1}
#| fig.cap = "Posterior average expected infection prevalence for HPV16/18 under organised screening, across metropolitan France, stratified by age.",
#| fig.width=29.7,
#| fig.height=20


grid.arrange(prevmap1618,
             prevmap1618legend, 
             nrow=2,
             heights=c(10, 1))

```


```{r mapfr2}
#| fig.cap = "Posterior average expected infection prevalence for Other genotypes, under organised screening, across metropolitan France, stratified by age.",
#| fig.width=29.7,
#| fig.height=20


grid.arrange(prevmapother,
             prevmapotherlegend, 
             nrow=2,
             heights=c(10, 1))

```



\newpage

\section{Difference in expected HR HPV cervical infection prevalence, between the two groups of genotypes\label{comparinggenotype}}


```{r}
#| fig.cap = "Summary of the posterior distribution of the difference (in percentage points) in infection prevalence cause by HPB16/18 and other genotypes, under organised screening, among females aged 30, at the end of November 2023.",
#| fig.width=29.7,
#| fig.height=20

tmp <- results$map[[30]]$difference_virus %>%
  filter(testgroup == 1) %>% 
  select(geometry, region, mean, qi_lb, qi_ub) %>%
  pivot_longer(cols = c("mean", "qi_lb", "qi_ub"), names_to = "name", values_to = "values") %>% 
  mutate(name = case_when(name == "mean" ~ "Posterior average",
              name == "qi_lb" ~ "Posterior LB ETI95%",
              name == "qi_ub" ~ "Posterior UB ETI95%"),
      name = factor(name,
             levels = c("Posterior LB ETI95%",
                  "Posterior average",
                  "Posterior UB ETI95%"))) 
 ggplot() +
  gg(tmp,
    aes(color = values, 
      fill = values)) + 
  theme_map(font_size = 26) +
  scale_color_viridis_c(option = "turbo",
             limits = c(min(tmp$values),max(tmp$values)), 
             direction = 1,
             labels = function(x){paste0(100*x, "pp")},
             n.breaks = 6) +
  scale_fill_viridis_c(option = "turbo",
             limits = c(min(tmp$values),max(tmp$values)), 
             direction = 1,
             labels = function(x){paste0(100*x, "pp")},
             n.breaks = 6) +
  labs(color = "Posterior difference (in percentage points) in infection prevalence cause by HPB16/18 and other genotypes, under organised screening, among females aged 30, at the end of November 2023",
     fill = "Posterior difference (in percentage points) in infection prevalence cause by HPB16/18 and other genotypes, under organised screening, among females aged 30, at the end of November 2023") +
  theme(
   plot.title = element_text(hjust = 0.5),
   legend.position = "bottom",
   legend.key.width = unit(3, "cm"),
   legend.key.height = unit(0.5, "cm"),
   legend.spacing = unit(0.25, "cm"),
   legend.title = element_text(hjust = 0.5),
   legend.justification = "center",
   legend.title.position = "top"
  ) +
  theme(plot.margin = margin(
   t = 0.0005,
   r = 0.0005,
   b = 0.0005,
   l = 0.0005,
   unit = "cm"
  ))+ theme(
  plot.title = element_text(hjust = 0.5, face = "bold"),
  plot.subtitle = element_text(hjust = 0.5, face = "bold")
) + 
   facet_wrap(~name)+
  gg(fr_mask,color = "black", alpha = 0.0000001)
  
```


```{r}
#| fig.cap = "Summary of the posterior distribution of the difference (in percentage points) in infection prevalence cause by HPB16/18 and other genotypes, under opportunistic screening, among females aged 30, at the end of November 2023.",
#| fig.width=29.7,
#| fig.height=20

tmp <- results$map[[30]]$difference_virus %>%
  filter(testgroup == 2) %>% 
  select(geometry, region, mean, qi_lb, qi_ub) %>%
  pivot_longer(cols = c("mean", "qi_lb", "qi_ub"), names_to = "name", values_to = "values") %>% 
  mutate(name = case_when(name == "mean" ~ "Posterior average",
                          name == "qi_lb" ~ "Posterior LB ETI95%",
                          name == "qi_ub" ~ "Posterior UB ETI95%"),
         name = factor(name,
                       levels = c("Posterior LB ETI95%",
                                  "Posterior average",
                                  "Posterior UB ETI95%"))) 
ggplot() +
  gg(tmp,
     aes(color = values, 
         fill = values)) + 
  theme_map(font_size = 26) +
  scale_color_viridis_c(option = "turbo",
                        limits = c(min(tmp$values),max(tmp$values)), 
                        direction = 1,
                        labels = function(x){paste0(100*x, "pp")},
                        n.breaks = 6) +
  scale_fill_viridis_c(option = "turbo",
                       limits = c(min(tmp$values),max(tmp$values)), 
                       direction = 1,
                       labels = function(x){paste0(100*x, "pp")},
                       n.breaks = 6) +
  labs(color = "Posterior difference (in percentage points) in infection prevalence cause by HPB16/18 and other genotypes, under opportunistic screening, among females aged 30, at the end of November 2023",
       fill = "Posterior difference (in percentage points) in infection prevalence cause by HPB16/18 and other genotypes, under opportunistic screening, among females aged 30, at the end of November 2023") +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "bottom",
    legend.key.width = unit(3, "cm"),
    legend.key.height = unit(0.5, "cm"),
    legend.spacing = unit(0.25, "cm"),
    legend.title = element_text(hjust = 0.5),
    legend.justification = "center",
    legend.title.position = "top"
  ) +
  theme(plot.margin = margin(
    t = 0.0005,
    r = 0.0005,
    b = 0.0005,
    l = 0.0005,
    unit = "cm"
  ))+ theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5, face = "bold")
  ) + 
  facet_wrap(~name) +
  gg(fr_mask,color = "black", alpha = 0.0000001)

```


```{r}

diffvirugeorganised <- function_selecting_map(vector_age = seq(30,66), v = 1, legend = "Posterior average expected difference in infection prevalence between other genotypes and HPV16/18, under organised screening", type_map =  "difference_virus", symbol = "pp")

diffvirugeorganisedlegend<-g_legend(diffvirugeorganised[[length(diffvirugeorganised)]])

diffvirugeorganised[[length(diffvirugeorganised)]] <- diffvirugeorganised[[length(diffvirugeorganised)]] +
    theme(legend.position= "none")

diffvirugeorganised <- ggpubr::ggarrange(plotlist=diffvirugeorganised)


```



```{r mapfrdiffvirugeorganised}
#| fig.cap = "Posterior average expected difference in infection prevalence between other genotypes and HPV16/18, across metropolitan France, stratified by age, under organised screening.",
#| fig.width=29.7,
#| fig.height=20


grid.arrange(diffvirugeorganised,
             diffvirugeorganisedlegend, 
             nrow=2,
             heights=c(10, 1))

```


```{r}

diffvirugeopportunistic <- function_selecting_map(vector_age = seq(30,66), v = 2, legend = "Posterior average expected difference in infection prevalence between other genotypes and HPV16/18, under opportunistic screening", type_map =  "difference_virus", symbol = "pp")

diffvirugeopportunisticlegend<-g_legend(diffvirugeopportunistic[[length(diffvirugeopportunistic)]])

diffvirugeopportunistic[[length(diffvirugeopportunistic)]] <- diffvirugeopportunistic[[length(diffvirugeopportunistic)]] +
    theme(legend.position= "none")

diffvirugeopportunistic <- ggpubr::ggarrange(plotlist=diffvirugeopportunistic)


```


```{r mapfrdiffvirugeopportunistic}
#| fig.cap = "Posterior average expected difference in infection prevalence between other genotypes and HPV16/18, across metropolitan France, stratified by age, under opportunistic screening.",
#| fig.width=29.7,
#| fig.height=20


grid.arrange(diffvirugeopportunistic,
             diffvirugeopportunisticlegend, 
             nrow=2,
             heights=c(10, 1))

```





```{r eval=TRUE, include=FALSE}
tmp_fun <- function(h){
  results$map %>% 
    imap(~.x[["difference_virus"]] %>% 
    st_drop_geometry() ) %>% 
    do.call(rbind,.)%>% 
    mutate(count = ifelse(higher_0 > h, 1, 0)) %>% 
  group_by(count, testgroup, age) %>% 
  count() %>% 
  filter(count == 1) %>% 
  mutate(pct = 100*n/nrow(data_cp_final)) %>% 
  ungroup() %>% 
  mutate()
}
```


```{r}
#| fig.cap = "Summary of the posterior distribution of the difference (in percentage points), between opportunistic and organised screening, in the expected HR HPV cervical infection prevalence, in major French cities, at the end of November 2023, stratified by age and genotype group.",
#| fig.width=29.7,
#| fig.height=20


diff_between_virus_city

```




\newpage

\section{Figure \ref{probacity}A, B, C, and D in table format} \label{tableprobacity}

```{r}
plot_summary_city$data %>% 
  st_drop_geometry() %>% 
  select(
    virusgroup,
    testgroup,
    city, 
    age,
    mean,
    qi_lb_099,
    qi_lb,
    qi_lb_09,
    median,
    qi_ub_09,
    qi_ub,
    qi_ub_099
  ) %>% 
  arrange(virusgroup, testgroup) %>% 
  mutate(virusgroup = ifelse(virusgroup == 1, "HPV16/18", "Other genotypes"),
         testgroup = ifelse(testgroup == 1, "Organised", "Opportunistic")) %>% 
  mutate_at(
    vars("mean",
       "qi_lb_099",
       "qi_lb",
       "qi_lb_09",
       "median",
       "qi_ub_09",
       "qi_ub",
       "qi_ub_099"),
    ~formating_text(100*.,2)
  ) %>% 
  mutate_all(~ifelse(is.na(.), "", .)) %>% 
  knitr::kable(
    col.names = c(
      "Virus",
      "Test",
      "City",
      "Age",
      "Average",
      "0.01",
      "0.025",
      "0.1",
      "0.5",
      "0.9",
      "0.975",
      "0.99"
    ),
    format = "latex",
    label = "tabledescyearsex",
    caption = "Posterior expected HR HPV cervical infection prevalence (in \\%) in major French cities, stratified by type of test, city, and age. Table counterpart to Figure \\ref{probacity}A",
    align = "c",
    escape = F,
    booktabs = T,
    linesep = "",
    longtable = T
  ) %>%
  add_header_above(c(
    " " = 5,
    "Percentiles" = 7
  )) %>%
  add_header_above(c(
    " " = 4,
    "Posterior distribution" = 8
  )) %>% 
  kable_styling(
    font_size = 10,
    latex_options = c(
      #      "scale_down",
      "repeat_header",
      "HOLD_position"
    ),
    position = "center"
  )

```

```{r}
diff_between_test_city$data %>% 
  st_drop_geometry() %>% 
  select(
    virusgroup,
    city, 
    age,
    mean,
    qi_lb_099,
    qi_lb,
    qi_lb_09,
    median,
    qi_ub_09,
    qi_ub,
    qi_ub_099
  ) %>% 
  arrange(virusgroup, city) %>% 
  mutate(virusgroup = ifelse(virusgroup == 1, "HPV16/18", "Other genotypes")) %>% 
  mutate_at(
    vars("mean",
       "qi_lb_099",
       "qi_lb",
       "qi_lb_09",
       "median",
       "qi_ub_09",
       "qi_ub",
       "qi_ub_099"),
    ~formating_text(100*.,2)
  ) %>% 
  mutate_all(~ifelse(is.na(.), "", .)) %>% 
  knitr::kable(
    col.names = c(
      "Virus",
      "City",
      "Age",
      "Average",
      "0.01",
      "0.025",
      "0.1",
      "0.5",
      "0.9",
      "0.975",
      "0.99"
    ),
    format = "latex",
    label = "tabledescyearsex",
    caption = "Posterior difference in expected HR HPV cervical infection prevalence (in percentage points) in major French cities, between opportunistic and organised screening, stratified by type of test, city, and age. Table counterpart to Figure \\ref{probacity}B.",
    align = "c",
    escape = F,
    booktabs = T,
    linesep = "",
    longtable = T
  ) %>%
  add_header_above(c(
    " " = 4,
    "Percentiles" = 7
  )) %>%
  add_header_above(c(
    " " = 3,
    "Posterior distribution" = 8
  )) %>% 
  kable_styling(
    font_size = 10,
    latex_options = c(
      #      "scale_down",
      "repeat_header",
      "HOLD_position"
    ),
    position = "center"
  )

```


```{r}

results$map %>% 
  imap(~.x$count_difference_test %>% st_drop_geometry) %>% 
  do.call(rbind,.) %>% 
  select(virusgroup, 
    age,
    mean,
    qi_lb_099,
    qi_lb,
    qi_lb_09,
    median,
    qi_ub_09,
    qi_ub,
    qi_ub_099)  %>% 
    mutate(virusgroup = ifelse(virusgroup==1, "HPV16/18", "Other genotypes")) %>% 
  mutate_at(c("mean",
    "qi_lb_099",
    "qi_lb",
    "qi_lb_09",
    "median",
    "qi_ub_09",
    "qi_ub",
    "qi_ub_099"),
            ~formating_text(100*round(.)/nrow(data_cp_final),2)) %>% 
  mutate_all(~ifelse(is.na(.), "", .)) %>% 
  arrange(virusgroup,age) %>% 
  knitr::kable(
    col.names = c(
      "Virus",
      "Age",
      "Average",
      "0.01",
      "0.025",
      "0.1",
      "0.5",
      "0.9",
      "0.975",
      "0.99"
    ),
    format = "latex",
    label = "xxxx",
    caption = "Posterior percentage of postcodes with a greater expected infection prevalence under opportunistic screening, than under organised screening, stratified by age and genotype group, as of November. Table counterpart to Figure \\ref{probacity}C.",
    align = "c",
    escape = F,
    booktabs = T,
    linesep = "",
    longtable = T
  ) %>%
  add_header_above(c(
    " " = 3,
    "Percentiles" = 7
  )) %>%
  add_header_above(c(
    " " = 2,
    "Posterior distribution" = 8
  )) %>% 
  kable_styling(
    font_size = 10,
    latex_options = c(
      #      "scale_down",
      "repeat_header",
      "HOLD_position"
    ),
    position = "center"
  )

```



```{r}


results$change_inflation_age %>% 
    imap(~.x$diff_prev_between_screening) %>% 
    do.call(rbind,.) %>% 
    st_drop_geometry() %>% 
    select(virusgroup, 
           age,
           mean,
           qi_lb_099,
           qi_lb,
           qi_lb_09,
           median,
           qi_ub_09,
           qi_ub,
           qi_ub_099,
           lower_0)  %>% 
    mutate(virusgroup = ifelse(virusgroup==1, "HPV16/18", "Other genotypes")) %>% 
  mutate_at(c("mean",
    "qi_lb_099",
    "qi_lb",
    "qi_lb_09",
    "median",
    "qi_ub_09",
    "qi_ub",
    "qi_ub_099"),
            ~formating_text(round(.))) %>% 
  mutate(lower_0 = formating_text(lower_0, 2)) %>% 
  mutate_all(~ifelse(is.na(.), "", .)) %>% 
  arrange(virusgroup,age) %>% 
  knitr::kable(
    col.names = c(
      "Virus",
      "Age",
      "Average",
      "0.01",
      "0.025",
      "0.1",
      "0.5",
      "0.9",
      "0.975",
      "0.99",
      "Proba < 0"
    ),
    format = "latex",
    label = "xxxx",
    caption = "Posterior distribution of the difference in the number of postcodes with a higher expected prevalence under opportunistic screening versus organised screening at each age, relative to females aged 30, as of end of November 2023. Table counterpart to Figure \\ref{probacity}D.",
    align = "c",
    escape = F,
    booktabs = T,
    linesep = "",
    longtable = T
  ) %>%
  add_header_above(c(
    " " = 3,
    "Percentiles" = 7,
    " " = 1
  )) %>%
  add_header_above(c(
    " " = 2,
    "Posterior distribution" = 9
  )) %>% 
  kable_styling(
    font_size = 10,
    latex_options = c(
      #      "scale_down",
      "repeat_header",
      "HOLD_position"
    ),
    position = "center"
  )

```
\newpage

\section{Difference in expected HR HPV cervical prevalence between the last and first week of the study period, stratified by age \label{diftim}}


```{r}
#| fig.cap = "Difference in expected HR HPV cervical infection prevalence, between the last and first week of the study period in major French cities, stratified by type of screening and age, for HPV16/18.",
#| fig.width=29.7,
#| fig.height=22.5


results$list_main_city$summary_city_year %>% 
  filter(metric == 'rd' & idtime == max(idtime)) %>% 
  ggplot() +
  geom_point(aes(x = age, y = mean, color = test), position = position_dodge(width = 0.9), alpha = 0.2)+
  geom_errorbar(aes(x = age, ymin = qi_lb, ymax = qi_ub, color = test), position = position_dodge(width = 0.9), alpha = 0.2) +
  theme_minimal()+
  geom_hline(yintercept = 0, linetype = "dashed") +
  scale_y_continuous(n.breaks = 8) +
  labs(x = "Genotypes",
     y = "Posterior difference in expected HR HPV cervical infection prevalence, between the last and first date of the study period",
     color = "Type of screening: ",
     caption = "Dots show the posterior average and bars the posterior ETI95%.")+
  scale_color_manual(values = c("red", "blue")) +
  theme_minimal(base_size = 21) +
  theme(legend.direction = "horizontal", legend.position = "bottom") +
  facet_grid(genotypes~city)

```

\newpage

\section{Figure \ref{differenceage}B and C in table format}\label{diffcitytable}

```{r}

table <- results$expected_prevalence%>% 
  plyr::rbind.fill(results$prevalence$expected_prevalence_year)%>% 
  plyr::rbind.fill(results$prevalence$expected_prevalence_age)%>% 
  plyr::rbind.fill(results$prevalence$expected_prevalence_year_age)


table %>% 
  mutate(age_class = as.character(age_class)) %>% 
  select(
    virus,
    year,
    age_class,
    mean,
    qi_lb_099,
    qi_lb,
    qi_lb_09,
    median,
    qi_ub_09,
    qi_ub,
    qi_ub_099
  ) %>% 
  mutate(virus = ifelse(virus == "hpv1618", "HPV16/18", "Other genotypes")) %>% 
  mutate_at(
    vars("mean",
       "qi_lb_099",
       "qi_lb",
       "qi_lb_09",
       "median",
       "qi_ub_09",
       "qi_ub",
       "qi_ub_099"),
    ~formating_text(100*.,2)
  ) %>% 
  mutate_all(~ifelse(is.na(.), "", .)) %>% 
  knitr::kable(
    col.names = c(
      "Genotype",
      "Year",
      "Age",
      "Average",
      "0.01",
      "0.025",
      "0.1",
      "0.5",
      "0.9",
      "0.975",
      "0.99"
    ),
    format = "latex",
    label = "tabledescyearsex",
    caption = "Posterior expected HR HPV infection prevalence (in \\%) assuming all data would have been collected with opportunistic or organised screening, not stratified or stratified by age, year, or age and year. Provide values from Figure  \\ref{differenceage}B in table format.",
    align = "c",
    escape = F,
    booktabs = T,
    linesep = "",
    longtable = T
  ) %>%
  add_header_above(c(
    " " = 4,
    "Percentiles" = 7
  )) %>%
  add_header_above(c(
    " " = 3,
    "Posterior distribution" = 8
  )) %>% 
  kable_styling(
    font_size = 12,
    latex_options = c(
      #      "scale_down",
      "repeat_header",
      "HOLD_position"
    ),
    position = "center"
  )



```

```{r}

table <- results$ame_test %>% 
 plyr::rbind.fill(results$ame$ame_test_year)%>% 
 plyr::rbind.fill(results$ame$ame_test_age)%>% 
 plyr::rbind.fill(results$ame$ame_test_age_year)



table %>% 
   mutate(age_class = as.character(age_class)) %>% 
  select(
    virus,
    year,
    age_class,
    mean,
    qi_lb_099,
    qi_lb,
    qi_lb_09,
    median,
    qi_ub_09,
    qi_ub,
    qi_ub_099,
    higher_0
  ) %>% 
  mutate(virus = ifelse(virus == "hpv1618", "HPV16/18", "Other genotypes")) %>% 
  mutate_at(
    vars("mean",
       "qi_lb_099",
       "qi_lb",
       "qi_lb_09",
       "median",
       "qi_ub_09",
       "qi_ub",
       "qi_ub_099"),
    ~formating_text(100*.,2)
  ) %>% 
  mutate(higher_0 = formating_text(higher_0, 2)) %>% 
  mutate_all(~ifelse(is.na(.), "", .)) %>% 
  knitr::kable(
    col.names = c(
      "Genotype",
      "Year",
      "Age",
      "Average",
      "0.01",
      "0.025",
      "0.1",
      "0.5",
      "0.9",
      "0.975",
      "0.99",
      "Pr(MDEP>0)"
    ),
    format = "latex",
    label = "tabledescyearsex",
    caption = "Marginal Difference in Expected Prevalence  (in percentage points), not stratified or stratified by age, year, or age and year. Provide values from Figure \\ref{differenceage}C in table format.",
    align = "c",
    escape = F,
    booktabs = T,
    linesep = "",
    longtable = T
  ) %>%
  add_header_above(c(
    " " = 4,
    "Percentiles" = 7,
    " " = 1
  )) %>%
  add_header_above(c(
    " " = 3,
    "Posterior distribution" = 9
  )) %>% 
  kable_styling(
    font_size = 11,
    latex_options = c(
      #      "scale_down",
      "repeat_header",
      "HOLD_position"
    ),
    position = "center"
  )


```

\elscape

\section{Sensitivity analyses} \label{sensi}

\subsection{Change in the variance of priors assigned to the (latent) correlation parameters} 

```{r}
sensitivity1 <- readRDS("hpv/clean_data/output/post_fit_sensi1.RDS")
sensitivity2 <- readRDS("hpv/clean_data/output/post_fit_sensi2.RDS")
```


```{r}
#| fig.cap = "Posterior average (ETI95%) for the expected HR HPV cervical infection prevalence in 11 major cities in France. The precision is defined as 1/variance: the greater the precision, the lower the variance. The baseline case, precision = 0.2, has a U-shape. A precision of 0.4 looks like a uniform distribution on [-1,1]. At a precision of 0.8, extreme values for the correlation are very unlikely.",
#| fig.width=10,
#| fig.height=8


dat <- rbind(results$list_main_city$virusspecific %>% filter(testgroup == 1) %>% mutate(type = "Baseline (precision: 0.2)"),
   sensitivity1$list_main_city$virusspecific %>% filter(testgroup == 1) %>% mutate(type = "Sensitivity (precision: 0.4)"),
   sensitivity2$list_main_city$virusspecific %>% filter(testgroup == 1) %>% mutate(type = "Sensitivity (precision: 0.8)"))




dat %>% 
  filter(idtime != 1) %>%
  select(age, genotypes, city, type, mean, qi_lb, qi_ub) %>% 
  pivot_longer(cols = c(mean, qi_lb, qi_ub)) %>% 
  mutate(name = factor(name, levels = c("qi_lb", "mean", "qi_ub"))) %>% 
  ggplot() + 
  geom_line(aes(x = age, y = value, color = type, linetype = name)) +
  facet_grid(genotypes~city, scales = "free")+ 
  theme_minimal() +
  theme(legend.direction = "horizontal", legend.position = "bottom") + 
     labs(color = "Analysis: ",
         y = "Expected HR HPV cervical infection prevalence",
         x = "Age",
         linetype = "Posterior: ") + 
    scale_color_manual(values = c("red", "blue", "orange", "purple", "darkgreen"))+
    scale_linetype_manual(values = c(2,1,3), labels = c("2.5% Quantile", "Mean", "97.5% Quantile"))+
  theme(legend.position="bottom", legend.box="vertical", legend.margin=margin())
```


```{r}

baseline <- results$ame_test %>% 
 plyr::rbind.fill(results$ame$ame_test_year)%>% 
 plyr::rbind.fill(results$ame$ame_test_age)%>% 
 plyr::rbind.fill(results$ame$ame_test_age_year) %>% 
 mutate(type = "Baseline (precision: 0.2)")

sensi1 <- sensitivity2$ame_test %>% 
 plyr::rbind.fill(sensitivity1$ame$ame_test_year)%>% 
 plyr::rbind.fill(sensitivity1$ame$ame_test_age)%>% 
 plyr::rbind.fill(sensitivity1$ame$ame_test_age_year) %>% 
 mutate(type = "Sensitivity (precision: 0.4)")

sensi2 <- sensitivity2$ame_test %>% 
 plyr::rbind.fill(sensitivity2$ame$ame_test_year)%>% 
 plyr::rbind.fill(sensitivity2$ame$ame_test_age)%>% 
 plyr::rbind.fill(sensitivity2$ame$ame_test_age_year) %>% 
 mutate(type = "Sensitivity (precision: 0.8)")

sensi <- rbind(baseline,
        sensi1,
   sensi2)

```


```{r}
#| fig.cap = "Posterior average (ETI95%) for the Marginal Difference in Expected Prevalence, stratified by precision for the priors of the latent correlation parameters, age, and year. The precision is defined as 1/variance: the greater the precision, the lower the variance. The baseline case, precision = 0.2, has a U-shape. A precision of 0.4 looks like a uniform distribution on [-1,1]. At a precision of 0.8, extreme values for the correlation are very unlikely.",
#| fig.width=10,
#| fig.height=10


sensi %>% 
 mutate(virus = ifelse(virus == "hpv1618", "HPV16/18", "Other genotypes")) %>% 
  mutate(year = ifelse(is.na(year), " ", year),
      age_class = ifelse(is.na(age_class), "[30,66]", as.character(age_class)),
      age_class = factor(age_class, levels = c("[30,39]", "(39,49]", "(49,59]", "(59,66]", "[30,66]"))) %>% 
  ggplot() + 
  geom_point(position = position_dodge(width = 0.9),
        aes(x = year, 
          y = mean,
          color = type))+
  geom_errorbar(position = position_dodge(width = 0.9),
         aes(x = year,
           ymin = qi_lb, 
           ymax = qi_ub, 
           color = type)) + 
  facet_grid(virus~age_class) + 
  theme_minimal() +
  theme(legend.direction = "horizontal", legend.position = "bottom") + 
  labs(color = element_blank(),
     y = "Posterior average (dots) and ETI95% (bars)",
     x = "Year") + 
  theme(strip.text.x = element_text(vjust = 0.5), strip.text.y = element_text(angle = -90)) + 
  scale_color_manual(values = c("red", "blue", "orange"))+
  scale_fill_manual(values = c("red", "blue", "orange"))
```

\newpage


\subsection{Non-selected competing models}



```{r}

to_read <- list("hpv/clean_data/output/post_fit_barrier.RDS",
 "hpv/clean_data/output/post_fit_stationary.RDS",
 "hpv/clean_data/output/post_fit_bym2delaunay.RDS",
 "hpv/clean_data/output/post_fit_bym2soi.RDS",
 "hpv/clean_data/output/post_fit_bym2queenfirstorder.RDS",
 "hpv/clean_data/output/post_fit_bym2queensecondorder.RDS")
names(to_read) <- c("GRF-Barrier",
          "GRF-Stationary",
          "GMRF-Delaunay",
          "GMRF-SOI",
          "GMRF-1stQueen",
          "GMRF-2ndQueen")
to_read <- to_read %>% imap(~readRDS(.x))
                            
```

```{r}
#| fig.cap = "Posterior average (ETI95%) for the conditional prevalence in major French cities, at the end of November 2023, stratified by genotype group and type of Matérn covariance function (stationary or non-stationary model).",
#| fig.width=10,
#| fig.height=8

dat <- rbind(to_read$`GRF-Barrier`$list_main_city$virusspecific %>% mutate(type = "GRF-Barrier"),
       to_read$`GRF-Stationary`$list_main_city$virusspecific %>% mutate(type = "GRF-Stationary"),
       to_read$`GMRF-Delaunay`$list_main_city$virusspecific %>% mutate(type = "GMRF-Delaunay"),
       to_read$`GMRF-SOI`$list_main_city$virusspecific %>% mutate(type = "GMRF-SOI"),
       to_read$`GMRF-1stQueen`$list_main_city$virusspecific %>% mutate(type = "GMRF-1stQueen"),
       to_read$`GMRF-2ndQueen`$list_main_city$virusspecific %>% mutate(type = "GMRF-2ndQueen")) %>% 
 mutate(type = factor(type,
            levels = c("GRF-Barrier",
                 "GRF-Stationary",
                 "GMRF-Delaunay",
                 "GMRF-SOI",
                 "GMRF-1stQueen",
                 "GMRF-2ndQueen")))




dat %>% 
    filter(idtime != 1 & testgroup==2) %>%
    select(age, genotypes, city, type, mean, qi_lb, qi_ub) %>% 
    pivot_longer(cols = c(mean, qi_lb, qi_ub)) %>% 
    mutate(name = factor(name, levels = c("qi_lb", "mean", "qi_ub"))) %>%
    ggplot() + 
    geom_line(aes(x = age, y = value, color = type, linetype = name)) +
    facet_grid(genotypes~city, scales = "free")+ 
    theme_minimal() +
    theme(legend.direction = "horizontal", legend.position = "bottom") + 
    labs(color = element_blank(),
         fill = "Spatial component",
         y = "Expected HR HPV cervical infection prevalence",
         x = "Age",
         linetype = "Posterior: ") + 
    scale_color_manual(values = c("red", "blue", "orange", "purple", "darkgreen", "black"))+
    scale_linetype_manual(values = c(2,1, 3), labels = c("2.5% Quantile", "Mean", "97.5% Quantile"))+
  theme(legend.position="bottom", legend.box="vertical", legend.margin=margin())
```



```{r}

fextract <- function(list,n){
 list[["ame_test"]] %>% 
    plyr::rbind.fill(list[["ame_test_year"]])%>% 
    plyr::rbind.fill(list[["ame_test_age"]])%>% 
    plyr::rbind.fill(list[["ame_test_age_year"]]) %>% 
  mutate(type = n)}

sensi <- rbind(
 fextract(to_read$`GRF-Barrier`[["ame"]], "GRF-Barrier"),
 fextract(to_read$`GRF-Stationary`[["ame"]], "GRF-Stationary"),
 fextract(to_read$`GMRF-Delaunay`[["ame"]], "GMRF-Delaunay"),
 fextract(to_read$`GMRF-SOI`[["ame"]], "GMRF-SOI"),
 fextract(to_read$`GMRF-1stQueen`[["ame"]], "GMRF-1stQueen"),
 fextract(to_read$`GMRF-2ndQueen`[["ame"]], "GMRF-2ndQueen")
)%>% 
 mutate(type = factor(type,
            levels = c("GRF-Barrier",
                 "GRF-Stationary",
                 "GMRF-Delaunay",
                 "GMRF-SOI",
                 "GMRF-1stQueen",
                 "GMRF-2ndQueen")),
     age_class = factor(age_class, levels = c(
      "[30,39]", "(39,49]", "(49,59]", "(59,66]"
     )))
 

```


```{r}
#| fig.cap = "Posterior average (ETI95%) for the Marginal Difference in Expected Prevalence, stratified by the type of spatial component, age, and year.",
#| fig.width=10,
#| fig.height=10


sensi %>% 
 mutate(virus = ifelse(virus == "hpv1618", "HPV16/18", "Other genotypes")) %>% 
  mutate(year = ifelse(is.na(year), " ", year),
      age_class = ifelse(is.na(age_class), "[30,66]", as.character(age_class)),
      age_class = factor(age_class, levels = c("[30,39]", "(39,49]", "(49,59]", "(59,66]", "[30,66]"))) %>% 
  ggplot() + 
  geom_point(position = position_dodge(width = 0.9),
        aes(x = year, 
          y = mean,
          color = type))+
  geom_errorbar(position = position_dodge(width = 0.9),
         aes(x = year,
           ymin = qi_lb, 
           ymax = qi_ub, 
           color = type)) + 
  facet_grid(virus~age_class) + 
  theme_minimal() +
  theme(legend.direction = "horizontal", legend.position = "bottom") + 
  labs(color = element_blank(),
     y = "Posterior average (dots) and ETI95% (bars) of the Marginal Difference in Expected Prevalence",
     x = "Year") + 
  theme(strip.text.x = element_text(vjust = 0.5), strip.text.y = element_text(angle = -90)) + 
  scale_color_manual(values = c("red", "blue", "orange", "purple", "darkgreen", "black"))+
  scale_fill_manual(values = c("red", "blue", "orange", "purple", "darkgreen", "black"))
```


\newpage
\section{References for the Supplementary Files}

\printbibliography[section=\therefsection,heading=subbibliography,title={$~$}, resetnumbers]

\let\printbibliography\relax


```{r eval=FALSE, include=FALSE}
save.image("hpv/clean_data/output_from_rmd.rda")
```
